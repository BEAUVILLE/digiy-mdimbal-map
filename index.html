<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DIGIY NDIMBAL ‚Äî Map ‚ôæÔ∏è</title>
  <meta name="description" content="Carte des partenaires DIGIY NDIMBAL ‚Äî 0% commission, contact direct." />
  <meta name="theme-color" content="#0B1120" />

  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --card:#111a2f;
      --line:rgba(255,255,255,.10);
      --text:#e5e7eb;
      --muted:#9ca3af;

      --gold:#facc15;
      --green:#22c55e;
      --orange:#f97316;

      --r-xl:22px;
      --r-lg:18px;
      --r-md:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 12% -10%, rgba(250,204,21,.14), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, #070b16 0%, var(--bg) 45%, #070b16 100%);
      overflow-x:hidden;
    }
    a{color:inherit}

    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(7,11,22,.62);
      backdrop-filter: blur(10px) saturate(140%);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar .inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .mark{
      width:38px;height:38px;border-radius:14px;
      display:grid; place-items:center;
      font-weight:1000;
      color:#0b1020;
      background: radial-gradient(circle at 30% 30%, rgba(250,204,21,.95), rgba(245,158,11,.80));
      box-shadow: 0 16px 60px rgba(250,204,21,.18);
      border:1px solid rgba(250,204,21,.35);
    }
    .brand .txt{min-width:0}
    .brand b{display:block;font-size:13px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand small{display:block;color:var(--muted);font-weight:750;font-size:12px}
    .spacer{flex:1}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      transition: .15s transform ease, .15s background ease, .15s border-color ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(250,204,21,.45)}
    .btn:active{transform:translateY(0)}
    .btn-gold{
      background: linear-gradient(135deg, rgba(250,204,21,.95), rgba(245,158,11,.88));
      border-color: rgba(250,204,21,.35);
      color:#0b1020;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:14px 14px 40px}
    .layout{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }

    .mapCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r-xl);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      position:relative;
      min-height: 520px;
    }
    #map{height:100%; min-height:520px}

    .side{
      display:grid; gap:14px;
      align-content:start;
    }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r-xl);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel .hd b{font-size:14px;letter-spacing:.2px}
    .panel .bd{padding:12px 14px}

    .search{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .search input{
      flex:1;
      min-width: 220px;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    .search input::placeholder{color:rgba(156,163,175,.9)}
    .search select{
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    .list{display:grid; gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding:12px 12px;
    }
    .itemTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .item h3{margin:0;font-size:14px;letter-spacing:.2px}
    .item p{margin:6px 0 0;color:var(--muted);font-weight:750;font-size:12px;line-height:1.4}
    .rowBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .mini{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      text-decoration:none;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .mini:hover{border-color:rgba(250,204,21,.45)}
    .mini-gold{
      background: linear-gradient(135deg, rgba(250,204,21,.95), rgba(245,158,11,.88));
      border-color: rgba(250,204,21,.35);
      color:#0b1020;
    }

    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      max-width:980px; margin:0 auto;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding:12px 14px;
      backdrop-filter: blur(10px);
      display:none;
      z-index:99;
      box-shadow: 0 18px 60px rgba(0,0,0,.5);
      color:var(--text);
      font-weight:800;
    }
    .toast small{display:block;margin-top:6px;color:rgba(156,163,175,.9);font-weight:750}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="mark">‚àû</div>
        <div class="txt">
          <b>DIGIY NDIMBAL ‚Äî Map</b>
          <small>Partenaires ¬∑ 0% commission ¬∑ direct</small>
        </div>
      </div>

      <div class="spacer"></div>

      <a class="btn" href="https://digiylyfe.com/page-partenaires/" target="_blank" rel="noopener">üîé Moteur</a>
      <a class="btn btn-gold" href="https://beauville.github.io/digiy-hub/" target="_blank" rel="noopener">üè† HUB</a>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">

      <div class="mapCard">
        <div id="map"></div>
      </div>

      <div class="side">

        <div class="panel">
          <div class="hd">
            <b>üéØ Rechercher</b>
            <span style="color:var(--muted);font-weight:800;font-size:12px" id="countLabel">‚Äî</span>
          </div>
          <div class="bd">
            <div class="search">
              <input id="q" placeholder="Nom, ville, zone, cat√©gorie‚Ä¶" />
              <select id="cat">
                <option value="">Toutes cat√©gories</option>
                <option value="commerce">Commerce</option>
                <option value="restaurant">Restaurant</option>
                <option value="logement">Logement</option>
                <option value="taxi">Taxi/VTC</option>
                <option value="hotel">H√¥tel</option>
                <option value="batiment">B√¢timent</option>
                <option value="voyage">Voyage</option>
                <option value="loisir">Loisir</option>
                <option value="notable">Notable</option>
              </select>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="hd"><b>üìå Partenaires</b><span style="color:var(--muted);font-weight:800;font-size:12px">Clique ‚Üí fiche</span></div>
          <div class="bd">
            <div class="list" id="list"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <div id="toastMsg">‚Äî</div>
    <small>Astuce : ouvre une fiche ‚Üí puis reviens √† la carte en 1 clic.</small>
  </div>

<script>
/* ================================
   SUPABASE (tes cl√©s)
================================ */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id)=>document.getElementById(id);

function showToast(msg){
  const t = $("toast");
  $("toastMsg").innerHTML = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 3200);
}
function fold(s){
  return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function normCategory(cat){
  const c = fold(cat);
  if(c.includes('resto') || c.includes('restaurant')) return 'restaurant';
  if(c.includes('commerce') || c.includes('market') || c.includes('boutique')) return 'commerce';
  if(c.includes('logement') || c.includes('heberg') || c.includes('h√©berg') || c.includes('villa')) return 'logement';
  if(c.includes('hotel') || c.includes('h√¥tel')) return 'hotel';
  if(c.includes('taxi') || c.includes('vtc') || c.includes('driver') || c.includes('chauffeur')) return 'taxi';
  if(c.includes('bat') || c.includes('b√¢t') || c.includes('construction') || c.includes('artisan')) return 'batiment';
  if(c.includes('voyage') || c.includes('explore') || c.includes('guide')) return 'voyage';
  if(c.includes('loisir')) return 'loisir';
  if(c.includes('notable')) return 'notable';
  return cat ? 'commerce' : '';
}
function catEmoji(c){
  const m = {
    commerce:"üè™", restaurant:"üçΩÔ∏è", logement:"üè†", taxi:"üöï", hotel:"üè®",
    batiment:"üî®", voyage:"‚úàÔ∏è", loisir:"üé≠", notable:"üëî"
  };
  return m[c] || "üìç";
}
function safe(v, fb=""){ return (v==null?fb:String(v)).trim(); }
function pickLat(p){ return p.latitude ?? p.lat ?? p.gps_lat ?? null; }
function pickLng(p){ return p.longitude ?? p.lng ?? p.gps_lng ?? null; }

function proUrl(slug){
  return `./pro.html?slug=${encodeURIComponent(slug)}`;
}

let MAP, layerPins;
let ALL = [];

async function loadProfessionals(){
  // ‚ö†Ô∏è si RLS bloque, il faudra une policy SELECT public (on voit apr√®s)
  const { data, error } = await SB.from("professionals").select("*").limit(2000);
  if(error) throw error;
  return data || [];
}

function initMap(){
  MAP = L.map("map", { zoomControl:true }).setView([14.439, -17.004], 10); // Saly/Dakar zone
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(MAP);
  layerPins = L.layerGroup().addTo(MAP);
}

function drawPins(list){
  layerPins.clearLayers();

  const bounds = [];
  list.forEach(p=>{
    const lat = pickLat(p);
    const lng = pickLng(p);
    if(lat==null || lng==null) return;

    const slug = safe(p.slug);
    const name = safe(p.name, "Partenaire");
    const city = safe(p.city);
    const zone = safe(p.zone);
    const cat = normCategory(p.category || p.cat || p.type || "");
    const em = catEmoji(cat);

    const html = `
      <div style="font-family:system-ui;min-width:220px">
        <div style="font-weight:900;margin-bottom:6px">${em} ${name}</div>
        <div style="color:#334155;font-weight:700;font-size:12px">${[city, zone].filter(Boolean).join(" ¬∑ ")}</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <a href="${proUrl(slug)}" style="padding:8px 10px;border-radius:999px;background:#facc15;color:#0b1020;font-weight:900;text-decoration:none;border:1px solid rgba(245,158,11,.35)">üëÄ Voir fiche</a>
          <a href="./index.html" style="padding:8px 10px;border-radius:999px;background:#0b1120;color:#fff;font-weight:900;text-decoration:none;border:1px solid rgba(2,6,23,.2)">üó∫Ô∏è Map</a>
        </div>
      </div>
    `;

    const m = L.marker([Number(lat), Number(lng)]).bindPopup(html);
    m.addTo(layerPins);
    bounds.push([Number(lat), Number(lng)]);
  });

  if(bounds.length){
    try{ MAP.fitBounds(bounds, { padding:[30,30] }); }catch(e){}
  }
}

function renderList(list){
  $("countLabel").textContent = `${list.length} r√©sultat(s)`;
  const box = $("list");
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = `<div class="item"><h3>üòÖ Rien trouv√©</h3><p>Essaie un autre mot-cl√© ou enl√®ve la cat√©gorie.</p></div>`;
    return;
  }

  list.slice(0, 80).forEach(p=>{
    const slug = safe(p.slug);
    const name = safe(p.name, "Partenaire");
    const city = safe(p.city);
    const zone = safe(p.zone);
    const cat = normCategory(p.category || p.cat || p.type || "");
    const em = catEmoji(cat);

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div>
          <h3>${em} ${name}</h3>
          <p>${[safe(p.category||""), city, zone].filter(Boolean).join(" ¬∑ ") || "Partenaire local"}</p>
        </div>
        <a class="mini mini-gold" href="${proUrl(slug)}">üëÄ Fiche</a>
      </div>
      <div class="rowBtns">
        <a class="mini" href="${proUrl(slug)}">‚ôæÔ∏è Ouvrir</a>
        <a class="mini" href="./index.html" onclick="event.preventDefault();window.__focusSlug='${slug}';focusOn('${slug}');">üìç Centrer</a>
      </div>
    `;
    box.appendChild(el);
  });
}

function focusOn(slug){
  const p = ALL.find(x=>safe(x.slug)===slug);
  if(!p) return showToast(`‚ö†Ô∏è Introuvable : <b>${slug}</b>`);
  const lat = pickLat(p), lng = pickLng(p);
  if(lat==null || lng==null) return showToast("‚ö†Ô∏è GPS manquant pour centrer.");
  MAP.setView([Number(lat), Number(lng)], 16);
  // ouvre popup si possible
  layerPins.eachLayer(layer=>{
    const ll = layer.getLatLng?.();
    if(ll && Math.abs(ll.lat-Number(lat))<1e-6 && Math.abs(ll.lng-Number(lng))<1e-6){
      layer.openPopup();
    }
  });
}

function applyFilters(){
  const q = fold($("q").value);
  const cat = $("cat").value;

  const filtered = ALL.filter(p=>{
    const blob = fold([
      p.name, p.slug, p.category, p.city, p.zone, p.region, p.description
    ].filter(Boolean).join(" "));
    const okQ = !q || blob.includes(q);
    const pc = normCategory(p.category || p.cat || p.type || "");
    const okC = !cat || pc === cat;
    return okQ && okC;
  });

  renderList(filtered);
  drawPins(filtered);
}

(async function boot(){
  try{
    initMap();
    showToast("‚ôæÔ∏è NDIMBAL Map pr√™te. Chargement partenaires‚Ä¶");

    ALL = await loadProfessionals();
    // si focus=slug dans l'URL, on centre
    const u = new URL(location.href);
    const focus = (u.searchParams.get("focus") || "").trim();

    applyFilters();

    $("q").addEventListener("input", ()=>applyFilters());
    $("cat").addEventListener("change", ()=>applyFilters());

    if(focus){
      setTimeout(()=>focusOn(focus), 400);
    }

    showToast(`‚úÖ ${ALL.length} partenaire(s) charg√©s.`);
  }catch(e){
    console.error(e);
    showToast("‚ùå Erreur chargement Supabase. V√©rifie RLS/policies ou connexion.");
    $("list").innerHTML = `
      <div class="item">
        <h3>‚ùå Impossible de charger les partenaires</h3>
        <p>Cause fr√©quente : RLS bloque le SELECT public sur <b>professionals</b>.</p>
        <p style="color:var(--muted)">D√©tail: ${String(e?.message||e)}</p>
      </div>
    `;
  }
})();
</script>
</body>
</html>
