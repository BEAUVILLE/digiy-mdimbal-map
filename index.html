<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fiche Pro ‚Äî DIGIYLYFE</title>
  <meta name="description" content="Fiche partenaire ‚Äî photos, horaires, services, contact." />
  <meta name="theme-color" content="#0B1120" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#0f172a; --card2:#0b1328; --line:rgba(255,255,255,.10);
      --text:#e5e7eb; --muted:#9ca3af;
      --gold:#facc15; --green:#22c55e; --orange:#f97316; --red:#ef4444; --blue:#60a5fa;
      --radius:18px; --radius2:22px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --glow: 0 0 0 1px rgba(250,204,21,.20), 0 18px 80px rgba(250,204,21,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 12% -10%, rgba(250,204,21,.14), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(96,165,250,.10), transparent 55%),
        linear-gradient(180deg, #070b16 0%, #0b1020 45%, #070b16 100%);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1080px;margin:0 auto;padding:16px 14px 40px}
    .topbar{
      position:sticky;top:0;z-index:10;
      background:rgba(7,11,22,.62);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar .inner{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:10px;padding:10px 14px}
    .brand{
      display:flex;align-items:center;gap:10px;min-width:0;
      font-weight:900;letter-spacing:.3px;
    }
    .brand .mark{
      width:36px;height:36px;border-radius:12px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(250,204,21,.35), rgba(250,204,21,.08) 55%, rgba(255,255,255,.06) 100%);
      box-shadow: var(--glow);
      border:1px solid rgba(250,204,21,.25);
      font-size:18px;
    }
    .brand .txt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .spacer{flex:1}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      text-decoration:none;cursor:pointer;
      transition:.15s transform ease, .15s background ease, .15s border-color ease;
      font-weight:800;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.16)}
    .btn:active{transform:translateY(0)}
    .btn-primary{
      background: linear-gradient(135deg, rgba(250,204,21,.95), rgba(245,158,11,.85));
      color:#0b1020;border-color:rgba(250,204,21,.35);
      box-shadow: 0 16px 60px rgba(250,204,21,.18);
    }
    .btn-primary:hover{background: linear-gradient(135deg, rgba(250,204,21,1), rgba(245,158,11,.92))}
    .btn-green{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.80));
      color:#04120c;border-color:rgba(34,197,94,.35);
    }
    .btn-ghost{background:transparent}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-weight:750;
      max-width:100%;
    }
    .hero{
      margin-top:14px;
      border-radius:var(--radius2);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
    }
    .cover{
      position:relative;
      height:240px;
      background: linear-gradient(135deg, rgba(250,204,21,.14), rgba(34,197,94,.10));
    }
    .cover img{
      width:100%;height:100%;object-fit:cover;display:block;
      filter:saturate(1.05) contrast(1.05);
    }
    .cover::after{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(7,11,22,.15), rgba(7,11,22,.75));
      pointer-events:none;
    }
    .hero-body{padding:14px 14px 16px}
    .head{
      display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;
    }
    .title{
      font-size:22px;line-height:1.15;font-weight:950;letter-spacing:.2px;
      margin:0;
    }
    .subtitle{
      margin:6px 0 0;color:var(--muted);font-weight:650
    }
    .metaRow{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:10px
    }
    .ctaRow{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:14px
    }

    .grid{
      display:grid;grid-template-columns: 1.25fr .75fr;gap:14px;
      margin-top:14px;
    }
    .card{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      box-shadow: 0 12px 40px rgba(0,0,0,.30);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .hd b{font-size:14px;letter-spacing:.25px}
    .card .bd{padding:12px 14px}
    .list{display:grid;gap:10px}
    .item{
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .item .t{font-weight:900}
    .item .s{color:var(--muted);margin-top:4px;font-weight:650}

    .gallery{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .ph{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      aspect-ratio: 4 / 3;
    }
    .ph img{width:100%;height:100%;object-fit:cover;display:block}
    .ph::after{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.28));
      pointer-events:none;
    }

    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(250,204,21,.32);
      background: rgba(250,204,21,.06);
      color: rgba(255,255,255,.92);
      font-weight:700;
    }

    .err{
      margin:18px 0;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color: rgba(255,255,255,.95);
      font-weight:800;
      white-space:pre-line;
    }

    .foot{
      margin-top:18px;
      padding:14px 2px 0;
      color: rgba(255,255,255,.55);
      font-weight:650;
      text-align:center;
    }

    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .cover{height:220px}
    }
    @media (max-width: 560px){
      .cover{height:210px}
      .gallery{grid-template-columns: repeat(2, 1fr)}
      .btn{flex:1}
      .ctaRow .btn{flex:1}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <a class="btn btn-ghost" id="btnBack" href="#" title="Retour">‚Üê Retour</a>

      <div class="brand" title="DIGIYLYFE">
        <div class="mark">‚àû</div>
        <div class="txt">DIGIYLYFE ¬∑ Fiche Pro</div>
      </div>

      <div class="spacer"></div>

      <a class="btn" id="btnSearch" href="https://digiylyfe.com/page-partenaires/" target="_blank" rel="noopener">
        üîé Moteur
      </a>
      <a class="btn btn-primary" id="btnHub" href="https://beauville.github.io/digiy-hub/" target="_blank" rel="noopener">
        üè† HUB
      </a>
    </div>
  </div>

  <div class="wrap">

    <div id="loading" class="note" style="display:none">Chargement‚Ä¶</div>
    <div id="infoNoSlug" class="note" style="display:none">
      Aucun <b>slug</b> dans l‚ÄôURL ‚Üí on t‚Äôaffiche <b>Astou</b> par d√©faut. (Astou d‚Äôabord üòÑ)
    </div>
    <div id="errorBox" class="err" style="display:none"></div>

    <section class="hero" id="hero" style="display:none">
      <div class="cover" id="cover">
        <img id="coverImg" alt="Couverture" />
      </div>

      <div class="hero-body">
        <div class="head">
          <div style="flex:1;min-width:260px">
            <h1 class="title" id="proName">‚Äî</h1>
            <div class="subtitle" id="proSubtitle">‚Äî</div>

            <div class="metaRow" id="metaRow"></div>

            <div class="ctaRow" id="ctaRow"></div>
          </div>

          <div style="min-width:220px;display:grid;gap:10px;align-content:start">
            <div class="pill" id="badgePill" style="display:none">üè∑Ô∏è <span id="badgeText">‚Äî</span></div>
            <div class="pill" id="pricePill" style="display:none">üí∞ <span id="priceText">‚Äî</span></div>
            <div class="pill" id="slugPill">üîó <span id="slugText">‚Äî</span></div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid" id="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <b>üßæ Pr√©sentation</b>
          <span class="pill" id="verifiedPill" style="display:none">‚úÖ V√©rifi√©</span>
        </div>
        <div class="bd">
          <div class="item">
            <div class="t">Description</div>
            <div class="s" id="proDesc">‚Äî</div>
          </div>

          <div class="item" id="servicesBox" style="display:none">
            <div class="t">Services</div>
            <div class="s" id="proServices">‚Äî</div>
          </div>

          <div class="item" id="hoursBox" style="display:none">
            <div class="t">Horaires</div>
            <div class="s" id="proHours">‚Äî</div>
          </div>

          <div class="item" id="galleryBox" style="display:none">
            <div class="t">Photos</div>
            <div class="s" style="margin-bottom:10px;color:var(--muted)">Tape une photo pour zoomer (si ton navigateur g√®re).</div>
            <div class="gallery" id="gallery"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <b>üìç Contact</b>
          <span class="pill" id="statusPill" style="display:none">üü¢ En ligne</span>
        </div>
        <div class="bd">
          <div class="list">

            <div class="item">
              <div class="t">Infos</div>
              <div class="s" id="infoLines">‚Äî</div>
            </div>

            <div class="item" id="phoneBox" style="display:none">
              <div class="t">T√©l√©phone</div>
              <div class="s"><a id="phoneLink" href="#" rel="nofollow">‚Äî</a></div>
            </div>

            <div class="item" id="addressBox" style="display:none">
              <div class="t">Adresse</div>
              <div class="s" id="addressText">‚Äî</div>
            </div>

            <div class="item" id="mapBox" style="display:none">
              <div class="t">Carte</div>
              <div class="s"><a id="mapLink" href="#" target="_blank" rel="noopener">Ouvrir Google Maps</a></div>
            </div>

            <div class="item" id="shareBox">
              <div class="t">Partager</div>
              <div class="s">
                <a class="btn" href="#" id="btnCopy">üìã Copier le lien</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <div class="foot">¬© DIGIYLYFE ¬∑ 0% commission ¬∑ Paiement direct au pro</div>
  </div>

<script>
/* ‚úÖ SUPABASE ‚Äî int√©gr√© */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== UTIL ===== */
const $ = (id)=>document.getElementById(id);

const DEFAULT_SLUG = "astou-boutique";

// Pages / repo √† ignorer si on lit "dernier segment"
const RESERVED = new Set([
  "index","index.html",
  "pro","pro.html",
  "map","map.html",
  "digiy-mdimbal-map","digiy-mdimbal-map.html",
  "digiy-ndimbal-map","digiy-ndimbal-map.html"
]);

function safeText(v, fallback="‚Äî"){
  if(v===null || v===undefined) return fallback;
  const s = (""+v).trim();
  return s ? s : fallback;
}

function parseSlug(){
  // 1) ?slug=xxx ou ?pro=xxx
  const q = new URLSearchParams(location.search);
  let slug = (q.get("slug") || q.get("pro") || "").trim();

  // 2) #xxx
  if(!slug){
    const h = (location.hash || "").replace("#","").trim();
    if(h && !RESERVED.has(h.toLowerCase())) slug = h;
  }

  // 3) /xxx (dernier segment) ‚Äî seulement si ce n‚Äôest PAS r√©serv√©
  if(!slug){
    const parts = location.pathname.split("/").filter(Boolean);
    const last = (parts[parts.length-1] || "").trim();
    const clean = last.replace(/\.html$/i,"").trim();
    const low = (clean || "").toLowerCase();
    if(clean && !RESERVED.has(low)) slug = clean;
  }

  // 4) s√©curit√© finale
  if(slug && RESERVED.has(slug.toLowerCase())) return "";

  return slug;
}

function isUrl(s){
  try{ new URL(s); return true; }catch(e){ return false; }
}

function joinList(val){
  if(!val) return "";
  if(Array.isArray(val)) return val.filter(Boolean).join(" ¬∑ ");
  if(typeof val === "string") return val;
  if(typeof val === "object"){
    const entries = Object.entries(val).filter(([k,v])=>v!==null && v!==undefined && (""+v).trim()!=="");
    return entries.map(([k,v])=>`${k}: ${v}`).join(" ¬∑ ");
  }
  return ""+val;
}

function buildMapsLink(address, city){
  const q = encodeURIComponent([address, city].filter(Boolean).join(", "));
  return "https://www.google.com/maps/search/?api=1&query=" + q;
}

function showError(msg){
  $("errorBox").style.display = "block";
  $("errorBox").textContent = msg;
}

/* ===== UI ===== */
$("btnBack").addEventListener("click", (e)=>{
  e.preventDefault();
  if(history.length > 1) history.back();
  else location.href = "./"; // ‚úÖ retourne √† la racine du repo (ta MAP)
});

$("btnCopy").addEventListener("click", async (e)=>{
  e.preventDefault();
  try{
    await navigator.clipboard.writeText(location.href);
    $("btnCopy").textContent = "‚úÖ Lien copi√©";
    setTimeout(()=> $("btnCopy").textContent = "üìã Copier le lien", 1400);
  }catch(err){
    alert("Copie impossible. Tu peux copier l‚ÄôURL manuellement.");
  }
});

/* ===== DATA LOAD ===== */
async function loadPro(slug){
  $("loading").style.display = "block";
  $("loading").textContent = "Chargement‚Ä¶";

  const { data, error } = await SB
    .from("professionals")
    .select("*")
    .eq("slug", slug)
    .maybeSingle();

  if(error) throw new Error("Supabase: " + error.message);
  if(!data) throw new Error("Aucun partenaire trouv√© pour le slug : " + slug);
  return data;
}

function renderPro(p){
  $("hero").style.display = "block";
  $("grid").style.display = "grid";
  $("loading").style.display = "none";

  const name = safeText(p.name, "Partenaire DIGIY");
  const cat  = safeText(p.category, "");
  const city = safeText(p.city, "");
  const zone = safeText(p.zone, "");
  const sub  = [cat, zone, city].filter(Boolean).join(" ¬∑ ") || "Partenaire local";

  $("proName").textContent = name;
  $("proSubtitle").textContent = sub;

  const slug = safeText(p.slug, "");
  $("slugText").textContent = slug ? slug : "‚Äî";

  const cover = p.cover_url && isUrl(p.cover_url) ? p.cover_url : "";
  $("coverImg").src = cover || "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='700'>
      <defs>
        <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop stop-color='#facc15' stop-opacity='.20'/>
          <stop offset='1' stop-color='#22c55e' stop-opacity='.12'/>
        </linearGradient>
      </defs>
      <rect width='100%' height='100%' fill='#0b1020'/>
      <rect width='100%' height='100%' fill='url(#g)'/>
      <text x='50%' y='52%' text-anchor='middle' fill='#e5e7eb' font-family='system-ui' font-size='46' font-weight='900'>${name.replace(/</g,"&lt;")}</text>
      <text x='50%' y='62%' text-anchor='middle' fill='#9ca3af' font-family='system-ui' font-size='22' font-weight='700'>DIGIYLYFE ¬∑ 0% commission</text>
    </svg>`
  );

  if(p.badge_text){
    $("badgePill").style.display = "inline-flex";
    $("badgeText").textContent = safeText(p.badge_text);
  }
  if(p.price_text){
    $("pricePill").style.display = "inline-flex";
    $("priceText").textContent = safeText(p.price_text);
  }

  if(p.is_verified === true) $("verifiedPill").style.display = "inline-flex";
  if(p.is_online === true) $("statusPill").style.display = "inline-flex";

  const meta = [];
  if(cat) meta.push(`üè∑Ô∏è ${cat}`);
  if(city) meta.push(`üìç ${city}`);
  if(zone) meta.push(`üß≠ ${zone}`);
  const metaRow = $("metaRow");
  metaRow.innerHTML = "";
  meta.forEach(t=>{
    const el = document.createElement("div");
    el.className = "pill";
    el.textContent = t;
    metaRow.appendChild(el);
  });

  $("proDesc").textContent = safeText(p.description, "Pas encore de description. (Mais le service est l√† üòÑ)");

  const services = joinList(p.services);
  if(services){
    $("servicesBox").style.display = "block";
    $("proServices").textContent = services;
  }

  const hours = joinList(p.opening_hours || p.hours);
  if(hours){
    $("hoursBox").style.display = "block";
    $("proHours").textContent = hours;
  }

  let photos = p.photos || p.gallery || p.images;
  if(typeof photos === "string"){
    try{ photos = JSON.parse(photos); }catch(e){}
  }
  if(Array.isArray(photos) && photos.length){
    const urls = photos.filter(u=>typeof u==="string" && u.trim() && isUrl(u.trim())).slice(0, 12);
    if(urls.length){
      $("galleryBox").style.display = "block";
      const g = $("gallery");
      g.innerHTML = "";
      urls.forEach(u=>{
        const a = document.createElement("a");
        a.className = "ph";
        a.href = u;
        a.target = "_blank";
        a.rel = "noopener";
        a.title = "Ouvrir";
        const img = document.createElement("img");
        img.src = u;
        img.alt = "Photo";
        a.appendChild(img);
        g.appendChild(a);
      });
    }
  }

  const lines = [];
  if(cat) lines.push(cat);
  if(zone || city) lines.push([zone, city].filter(Boolean).join(", "));
  $("infoLines").innerHTML = lines.length ? lines.map(x=>`‚Ä¢ ${x}`).join("<br>") : "‚Ä¢ Partenaire local";

  const phone = safeText(p.phone, "");
  const whatsapp = safeText(p.whatsapp, "");
  const phoneToUse = whatsapp || phone;

  if(phoneToUse){
    $("phoneBox").style.display = "block";
    $("phoneLink").textContent = phoneToUse;
    $("phoneLink").href = "tel:" + phoneToUse.replace(/\s+/g,"");
  }

  const address = safeText(p.address, "");
  if(address){
    $("addressBox").style.display = "block";
    $("addressText").textContent = address;

    $("mapBox").style.display = "block";
    $("mapLink").href = buildMapsLink(address, city);
  }

  const ctaRow = $("ctaRow");
  ctaRow.innerHTML = "";

  const cta1Label = safeText(p.cta_primary_label, "");
  const cta1Url   = safeText(p.cta_primary_url, "");
  const cta2Label = safeText(p.cta_secondary_label, "");
  const cta2Url   = safeText(p.cta_secondary_url, "");

  function addBtn(label, url, cls){
    if(!label || !url) return;
    const a = document.createElement("a");
    a.className = "btn " + (cls || "");
    a.textContent = label;
    a.href = url;
    a.target = "_blank";
    a.rel = "noopener";
    ctaRow.appendChild(a);
  }

  if(cta1Label && cta1Url && isUrl(cta1Url)){
    addBtn(cta1Label, cta1Url, "btn-primary");
  }else{
    if(phoneToUse){
      const wa = "https://wa.me/" + phoneToUse.replace(/[^\d]/g,"") +
        "?text=" + encodeURIComponent("Salam " + name + " je viens de DIGIYLYFE");
      addBtn("üí¨ WhatsApp", wa, "btn-primary");
    }
  }

  if(cta2Label && cta2Url && isUrl(cta2Url)){
    addBtn(cta2Label, cta2Url, "");
  }else{
    addBtn("üîé Voir sur partenaires", "https://digiylyfe.com/page-partenaires/", "");
  }

  if(phoneToUse){
    const tel = "tel:" + phoneToUse.replace(/\s+/g,"");
    const a = document.createElement("a");
    a.className = "btn btn-green";
    a.textContent = "üìû Appeler";
    a.href = tel;
    ctaRow.appendChild(a);
  }

  document.title = name + " ‚Äî DIGIYLYFE";
}

/* ===== BOOT ===== */
(async function boot(){
  try{
    const slug = parseSlug();

    if(!slug){
      $("infoNoSlug").style.display = "block";
    }

    const finalSlug = slug || DEFAULT_SLUG;

    const pro = await loadPro(finalSlug);
    renderPro(pro);

  }catch(err){
    $("loading").style.display = "none";
    showError(
      "Impossible de charger la fiche.\n" +
      "‚Ä¢ V√©rifie que le slug existe dans Supabase.\n" +
      "‚Ä¢ V√©rifie que la table s‚Äôappelle bien 'professionals' et que la colonne 'slug' est remplie.\n\n" +
      "D√©tail: " + (err?.message || err)
    );
  }
})();
</script>
</body>
</html>
