<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Fiche Pro ‚Äî DIGIY NDIMBAL</title>
  <meta name="description" content="Fiche professionnelle DIGIY NDIMBAL ‚Äî horaires, services, contact, localisation." />
  <meta name="theme-color" content="#0b1020" />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a2f;
      --card:#16213e;
      --line:rgba(255,255,255,.10);
      --text:#ffffff;
      --muted:#b8b8b8;

      --primary:#FF6B35;
      --primary-dark:#E55A2B;
      --secondary:#4ECDC4;

      --ok:#22c55e;
      --warn:#fbbf24;
      --danger:#ff6b6b;

      --r-xl:22px;
      --r-lg:16px;
      --r-md:12px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --t: all .22s ease;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 10% -10%, rgba(255,107,53,.18), transparent 55%),
        radial-gradient(900px 520px at 100% 0%, rgba(78,205,196,.14), transparent 55%),
        linear-gradient(180deg, #070b16 0%, var(--bg) 40%, #070b16 100%);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:18px 14px 70px}
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 10px;
      background: rgba(11,16,32,.78);
      backdrop-filter: blur(10px) saturate(140%);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .infty{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(255,107,53,.22), rgba(78,205,196,.18));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      font-weight:900; font-size:22px; color: var(--primary);
    }
    .brand h1{margin:0;font-size:14px;letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      cursor:pointer; border:none; text-decoration:none;
      padding:10px 12px; border-radius:999px;
      display:inline-flex; align-items:center; gap:8px;
      font-weight:900; font-size:13px;
      transition: var(--t);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn-outline{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
    }
    .btn-outline:hover{border-color: rgba(255,107,53,.45); transform: translateY(-1px)}
    .btn-primary{
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color:#fff;
    }
    .btn-primary:hover{transform: translateY(-1px)}
    .btn-secondary{
      background: linear-gradient(135deg, rgba(78,205,196,1), rgba(78,205,196,.75));
      color:#09121f;
    }
    .btn-secondary:hover{transform: translateY(-1px)}
    .btn-whatsapp{
      background: linear-gradient(135deg, #35d07f, #0d9f54);
      color:#fff;
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .actions{justify-content:flex-start}
    }

    .hero{
      background: linear-gradient(135deg, rgba(255,107,53,.18), rgba(78,205,196,.12));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero::before{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(520px 180px at 70% 0%, rgba(255,255,255,.12), transparent 55%);
      pointer-events:none;
    }
    .hero-inner{display:grid; grid-template-columns: 1fr; gap:12px; padding:14px}
    .cover{
      position:relative;
      border-radius: var(--r-lg);
      overflow:hidden;
      background: linear-gradient(135deg, rgba(255,107,53,.35), rgba(78,205,196,.22));
      border:1px solid rgba(255,255,255,.10);
      min-height: 220px;
    }
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute; top:12px; left:12px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.16);
      padding:8px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      backdrop-filter: blur(10px);
    }
    .badge.ok{border-color: rgba(34,197,94,.35)}
    .badge.warn{border-color: rgba(251,191,36,.35)}
    .badge.danger{border-color: rgba(255,107,107,.35)}

    .head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:2px 2px 0;
      flex-wrap:wrap;
    }
    .title h2{margin:0; font-size:22px; letter-spacing:.2px}
    .subtitle{
      margin:6px 0 0;
      color: var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color:#fff;
    }
    .chip strong{color: var(--secondary)}
    .section{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r-xl);
      box-shadow: 0 12px 40px rgba(0,0,0,.32);
      overflow:hidden;
    }
    .section h3{
      margin:0;
      padding:14px 14px 10px;
      font-size:14px;
      letter-spacing:.2px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .section .content{padding:12px 14px 14px}
    .kvs{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:540px){.kvs{grid-template-columns:1fr}}
    .kv{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r-md);
      padding:10px 12px;
    }
    .kv .k{color:var(--muted); font-size:12px; font-weight:800}
    .kv .v{margin-top:3px; font-weight:900; font-size:13px}

    .desc{
      line-height:1.6;
      color: rgba(255,255,255,.92);
      font-weight:600;
      font-size:14px;
    }
    .services{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .tag{
      background: rgba(78,205,196,.14);
      border:1px solid rgba(78,205,196,.28);
      color: var(--secondary);
      padding:7px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
    }

    .gallery{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 540px){ .gallery{grid-template-columns:repeat(2,1fr)} }
    .photo{
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      min-height:110px;
    }
    .photo img{width:100%; height:100%; object-fit:cover; display:block}

    .side-stack{display:grid; gap:14px}
    .cta-box{
      background: linear-gradient(135deg, rgba(255,107,53,.18), rgba(78,205,196,.12));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r-xl);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .cta-box h4{margin:0 0 10px; font-size:14px}
    .cta-row{display:flex; gap:10px; flex-wrap:wrap}
    .cta-row .btn{flex:1; justify-content:center; min-width:160px}
    .note{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      font-weight:700;
      line-height:1.5;
    }

    .skeleton{
      height: 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size: 220% 100%;
      animation: shimmer 1.2s linear infinite;
    }
    @keyframes shimmer{0%{background-position: 0% 0%}100%{background-position: 220% 0%}}
    .sk-wrap{display:grid; gap:10px; padding:14px}
    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      max-width:980px; margin:0 auto;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding:12px 14px;
      backdrop-filter: blur(10px);
      display:none;
      z-index:99;
      box-shadow: 0 18px 60px rgba(0,0,0,.5);
    }
    .toast strong{color: var(--secondary)}
    .toast small{display:block; margin-top:6px; color: var(--muted); font-weight:700}
  </style>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

  <div class="topbar">
    <div class="brand">
      <div class="infty">‚àû</div>
      <div>
        <h1 id="brandTitle">DIGIY NDIMBAL ‚Äî Fiche</h1>
        <p id="brandSub">Propri√©t√© du pro ‚Ä¢ z√©ro interm√©diaire</p>
      </div>
    </div>
    <div class="actions">
      <a class="btn btn-outline" id="btnBackMap" href="#">üó∫Ô∏è Retour carte</a>
      <a class="btn btn-outline" id="btnHub" href="https://beauville.github.io/digiy-hub/" target="_blank" rel="noopener">üè† HUB</a>
    </div>
  </div>

  <div class="wrap">

    <!-- Skeleton while loading -->
    <div id="loading" class="section" style="margin-top:14px">
      <div class="sk-wrap">
        <div class="skeleton" style="width:55%"></div>
        <div class="skeleton" style="width:85%"></div>
        <div class="skeleton" style="width:65%"></div>
        <div class="skeleton" style="width:95%; height:160px; border-radius:18px"></div>
        <div class="skeleton" style="width:75%"></div>
        <div class="skeleton" style="width:92%"></div>
      </div>
    </div>

    <!-- Real content -->
    <div id="content" class="grid" style="display:none">

      <!-- LEFT -->
      <div class="hero">
        <div class="hero-inner">
          <div class="cover">
            <img id="coverImg" alt="Photo du professionnel" loading="lazy" decoding="async" />
            <div id="badge" class="badge ok" hidden>‚úÖ V√©rifi√©</div>
          </div>

          <div class="head">
            <div class="title">
              <h2 id="proName">‚Äî</h2>
              <div class="subtitle" id="proMeta">‚Äî</div>
            </div>

            <div class="chips">
              <div class="chip">‚≠ê <strong id="proRating">‚Äî</strong>/5</div>
              <div class="chip">‚ôæÔ∏è <strong id="proSlug">‚Äî</strong></div>
            </div>
          </div>

          <div class="section">
            <h3>üìù Histoire & description</h3>
            <div class="content">
              <div class="desc" id="proDesc">‚Äî</div>
              <div class="services" id="proServices"></div>
            </div>
          </div>

          <div class="section">
            <h3>üì∏ Photos</h3>
            <div class="content">
              <div class="gallery" id="gallery"></div>
              <div class="note">Astuce : plus tu ajoutes des photos r√©elles, plus la fiche ‚Äúrespire‚Äù et la confiance grimpe.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="side-stack">

        <div class="cta-box">
          <h4>‚ö° Contacter maintenant</h4>
          <div class="cta-row">
            <a class="btn btn-primary" id="btnCall" href="#">üìû Appeler</a>
            <a class="btn btn-whatsapp" id="btnWA" href="#" target="_blank" rel="noopener">üí¨ WhatsApp</a>
          </div>
          <div class="cta-row" style="margin-top:10px">
            <button class="btn btn-secondary" id="btnShare" type="button">üîó Partager la fiche</button>
            <a class="btn btn-outline" id="btnOpenMap" href="#">üß≠ Ouvrir GPS</a>
          </div>
          <div class="note">
            Ici, pas d‚ÄôOTA qui pompe ton SEO : c‚Äôest la fiche du pro, par le pro, pour le peuple.
          </div>
        </div>

        <div class="section">
          <h3>üìå Infos rapides</h3>
          <div class="content">
            <div class="kvs">
              <div class="kv">
                <div class="k">Cat√©gorie</div>
                <div class="v" id="kvCategory">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">R√©gion</div>
                <div class="v" id="kvRegion">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">Ville / Zone</div>
                <div class="v" id="kvCity">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">Horaires</div>
                <div class="v" id="kvHours">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">Email</div>
                <div class="v" id="kvEmail">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">T√©l√©phone</div>
                <div class="v" id="kvPhone">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>üó∫Ô∏è Localisation</h3>
          <div class="content">
            <div class="desc" id="locLine">‚Äî</div>
            <div class="note" id="gpsNote"></div>
          </div>
        </div>

        <div class="section">
          <h3>üß† SEO (invisible mais puissant)</h3>
          <div class="content">
            <div class="desc" style="font-size:13px;color:rgba(255,255,255,.82)">
              Cette fiche g√©n√®re automatiquement un bloc ‚ÄúBusiness‚Äù (JSON-LD) pour aider Google √† comprendre le pro.
              C‚Äôest propre, et √ßa travaille pendant que toi tu dors.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <div id="toastMsg">‚Äî</div>
    <small>Astuce : tu peux partager la fiche comme un lien WhatsApp / QR.</small>
  </div>

<script>
/* ================================
   CONFIG SUPABASE (UNIQUE)
================================ */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

window.SB = window.SB || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const SB = window.SB;

/* ================================
   PRIORIT√â ASTOU (si pas de slug)
================================ */
const DEFAULT_SLUG = "astou-boutique";

/* ================================
   PARAMS (robuste)
   - ?slug=xxx
   - ?pro=xxx
   - #xxx
   - /xxx (dernier segment)
================================ */
function canon(x){ return String(x ?? "").trim(); }

function parseKey(){
  const u = new URL(window.location.href);
  const qs = canon(u.searchParams.get("slug") || u.searchParams.get("pro") || "");

  if(qs) return qs;

  const h = canon((window.location.hash || "").replace("#",""));
  if(h) return h;

  const parts = window.location.pathname.split("/").filter(Boolean);
  const last = canon(parts[parts.length - 1] || "");
  const clean = canon(last.replace(/\.html$/i,""));
  // √©vite de prendre "index" comme slug
  if(clean && clean.toLowerCase() !== "index") return clean;

  return "";
}

const KEY = parseKey();

/* ================================
   CATEGORY LABELS
================================ */
function fold(s){
  return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function normCategory(cat){
  const c = fold(cat);
  if(c.includes('resto') || c.includes('restaurant')) return 'restaurant';
  if(c.includes('commerce') || c.includes('market') || c.includes('boutique')) return 'commerce';
  if(c.includes('logement') || c.includes('heberg') || c.includes('h√©berg') || c.includes('villa')) return 'logement';
  if(c.includes('hotel') || c.includes('h√¥tel')) return 'hotel';
  if(c.includes('taxi') || c.includes('vtc') || c.includes('driver') || c.includes('chauffeur')) return 'taxi';
  if(c.includes('bat') || c.includes('b√¢t') || c.includes('construction') || c.includes('artisan')) return 'batiment';
  if(c.includes('voyage') || c.includes('explore') || c.includes('guide')) return 'voyage';
  if(c.includes('loisir')) return 'loisir';
  if(c.includes('notable')) return 'notable';
  if(c.includes('voiture')) return 'voiture';
  return 'commerce';
}
function getCategoryLabel(category){
  const labels = {
    restaurant:'üçΩÔ∏è Restaurant',
    commerce:'üè™ Commerce',
    logement:'üè† Logement',
    taxi:'üöï Taxi/VTC',
    notable:'üëî Notable',
    batiment:'üî® B√¢timent',
    voiture:'üöó Voiture',
    voyage:'‚úàÔ∏è Voyage',
    loisir:'üé≠ Loisir',
    hotel:'üè® H√¥tel'
  };
  return labels[category] || 'üìç Service';
}
function getRegionLabel(region){
  return (region||'').toString().replace(/-/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
}

/* ================================
   UI HELPERS
================================ */
function escapeHTML(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function showToast(msg){
  const t = document.getElementById("toast");
  document.getElementById("toastMsg").innerHTML = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 3200);
}
function setMetaTitleDesc(name, cat, city){
  const title = `${name} ‚Äî ${cat} ‚Ä¢ ${city} | DIGIY NDIMBAL`;
  document.title = title;
  const meta = document.querySelector('meta[name="description"]');
  if(meta) meta.setAttribute("content", `Fiche pro : ${name} ‚Äî ${cat} √† ${city}. Horaires, services, contact, localisation.`);
}
function showErrorBox(title, detail){
  // Remplace le skeleton par un message propre
  const loading = document.getElementById("loading");
  loading.innerHTML = `
    <div class="content">
      <div class="desc" style="padding:14px">
        <div style="font-weight:950;font-size:16px;margin-bottom:6px">‚ùå ${escapeHTML(title)}</div>
        <div style="color:var(--muted);font-weight:700;line-height:1.6">${escapeHTML(detail || "")}</div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn btn-outline" href="map.html">üó∫Ô∏è Retour carte</a>
          <a class="btn btn-primary" href="https://digiylyfe.com/page-partenaires/" target="_blank" rel="noopener">üîé Moteur partenaires</a>
        </div>
      </div>
    </div>
  `;
}

/* ================================
   DATA ADAPTER
================================ */
function pickLat(p){ return p.latitude ?? p.lat ?? p.gps_lat ?? null; }
function pickLng(p){ return p.longitude ?? p.lng ?? p.gps_lng ?? null; }

function parseServices(p){
  const s = p.services;
  if(Array.isArray(s)) return s.filter(Boolean).map(x=>String(x));
  if(typeof s === "string"){
    const t = s.trim();
    if(!t) return [];
    try{
      const j = JSON.parse(t);
      if(Array.isArray(j)) return j.map(x=>String(x));
    }catch(e){}
    return t.split(",").map(x=>x.trim()).filter(Boolean);
  }
  if(s && typeof s === "object") return Object.keys(s);
  return [];
}

function parsePhotos(p){
  const out = [];
  const add = (u)=>{ if(u && typeof u === "string"){ const x=u.trim(); if(x) out.push(x); } };

  add(p.cover_url);
  add(p.cover);
  add(p.photo_url);

  const arr = p.photos ?? p.gallery ?? p.images ?? null;
  if(Array.isArray(arr)) arr.forEach(add);
  else if(typeof arr === "string"){
    const t = arr.trim();
    if(t){
      try{
        const j = JSON.parse(t);
        if(Array.isArray(j)) j.forEach(add);
        else add(t);
      }catch(e){
        t.split(",").forEach(add);
      }
    }
  }
  return Array.from(new Set(out));
}

function buildWA(phone, name){
  const p = String(phone||"").replace(/\s+/g,'');
  if(!p) return "";
  const msg = encodeURIComponent(`Salam ${name || ""} ‚Äî je viens de DIGIY NDIMBAL ‚ôæÔ∏è`);
  const cleaned = p.replace(/^00/,'+');
  const digits = cleaned.startsWith("+") ? cleaned.slice(1) : cleaned;
  return `https://wa.me/${digits}?text=${msg}`;
}

function googleMapsLink(lat, lng, name){
  if(lat==null || lng==null) return "";
  const q = encodeURIComponent(`${lat},${lng} (${name||"Pro"})`);
  return `https://www.google.com/maps?q=${q}`;
}

/* ================================
   JSON-LD SEO
================================ */
function injectJsonLd(p){
  const name = p.name || "Professionnel";
  const city = p.city || "";
  const region = p.region ? getRegionLabel(p.region) : "";
  const phone = p.phone || "";
  const email = p.email || "";
  const hours = p.hours || "";
  const desc = (p.description || "").slice(0, 300);
  const photos = p._photos || [];
  const lat = pickLat(p);
  const lng = pickLng(p);

  const data = {
    "@context":"https://schema.org",
    "@type":"LocalBusiness",
    "name": name,
    "description": desc || undefined,
    "image": photos.length ? photos : undefined,
    "telephone": phone || undefined,
    "email": email || undefined,
    "address":{
      "@type":"PostalAddress",
      "addressLocality": city || undefined,
      "addressRegion": region || undefined,
      "addressCountry":"SN"
    },
    "geo": (lat!=null && lng!=null) ? ({
      "@type":"GeoCoordinates",
      "latitude": Number(lat),
      "longitude": Number(lng)
    }) : undefined,
    "openingHours": hours || undefined
  };

  const clean = JSON.parse(JSON.stringify(data));
  const s = document.createElement("script");
  s.type = "application/ld+json";
  s.textContent = JSON.stringify(clean);
  document.head.appendChild(s);
}

/* ================================
   LOAD LOGIC (PROPRE)
   1) slug exact
   2) slug ilike
   3) id
================================ */
async function fetchPro(key){
  if(!key) return null;

  let q = await SB.from("professionals").select("*").eq("slug", key).maybeSingle();
  if(!q.error && q.data) return q.data;

  q = await SB.from("professionals").select("*").ilike("slug", key).maybeSingle();
  if(!q.error && q.data) return q.data;

  q = await SB.from("professionals").select("*").eq("id", key).maybeSingle();
  if(!q.error && q.data) return q.data;

  return null;
}

/* ================================
   RENDER
================================ */
function renderPro(p){
  const name = p.name || "Professionnel";
  const slug = p.slug || p.id || "‚Äî";
  const city = p.city || "S√©n√©gal";
  const region = p.region ? getRegionLabel(p.region) : "";
  const catNorm = normCategory(p.category || p.cat || p.type || "");
  p._cat = catNorm;

  const rating = (p.rating != null && String(p.rating).trim() !== "") ? String(p.rating) : "5.0";
  const phone = p.phone || "";
  const email = p.email || "N/A";
  const hours = p.hours || p.opening_hours || "N/A";

  const photos = parsePhotos(p);
  p._photos = photos;

  const services = parseServices(p);
  const desc = p.description || "‚Äî";

  const lat = pickLat(p);
  const lng = pickLng(p);

  // Cover
  const coverEl = document.getElementById("coverImg");
  coverEl.src = photos[0] || "https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=1600&q=70";

  // Badge
  const badgeEl = document.getElementById("badge");
  const badgeText = (p.badge_text || "").trim();
  if(badgeText){
    badgeEl.textContent = badgeText;
    badgeEl.hidden = false;
    badgeEl.className = "badge ok";
  }else{
    if(p.verified === true || p.is_verified === true){
      badgeEl.textContent = "‚úÖ V√©rifi√©";
      badgeEl.hidden = false;
      badgeEl.className = "badge ok";
    }else{
      badgeEl.hidden = true;
    }
  }

  // Titles
  document.getElementById("proName").textContent = name;
  document.getElementById("proSlug").textContent = slug;
  document.getElementById("proRating").textContent = rating;

  const meta = `${getCategoryLabel(catNorm)} ‚Ä¢ üìç ${city}${region ? " ‚Äî " + region : ""}`;
  document.getElementById("proMeta").textContent = meta;

  // Description + services
  document.getElementById("proDesc").textContent = desc;
  const sWrap = document.getElementById("proServices");
  sWrap.innerHTML = "";
  services.slice(0, 24).forEach(s=>{
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = s;
    sWrap.appendChild(span);
  });

  // Gallery
  const g = document.getElementById("gallery");
  g.innerHTML = "";
  const gal = photos.slice(0, 6);
  if(gal.length){
    gal.forEach(u=>{
      const d = document.createElement("div");
      d.className = "photo";
      d.innerHTML = `<img src="${escapeHTML(u)}" alt="Photo ${escapeHTML(name)}" loading="lazy" decoding="async">`;
      g.appendChild(d);
    });
  }else{
    g.innerHTML = `<div class="desc" style="color:var(--muted)">Aucune photo pour l‚Äôinstant. Ajoute 3 √† 6 images r√©elles : boutique, √©quipe, produits, fa√ßade‚Ä¶</div>`;
  }

  // KVs
  document.getElementById("kvCategory").textContent = getCategoryLabel(catNorm);
  document.getElementById("kvRegion").textContent = region || "‚Äî";
  document.getElementById("kvCity").textContent = city || "‚Äî";
  document.getElementById("kvHours").textContent = hours;
  document.getElementById("kvEmail").textContent = email;
  document.getElementById("kvPhone").textContent = phone || "N/A";

  // Location line
  document.getElementById("locLine").textContent = `üìç ${city}${region ? " ‚Äî " + region : ""}`;

  const gpsNote = document.getElementById("gpsNote");
  if(lat!=null && lng!=null){
    gpsNote.innerHTML = `Coordonn√©es GPS : <strong>${Number(lat).toFixed(6)}</strong>, <strong>${Number(lng).toFixed(6)}</strong>`;
  }else{
    gpsNote.textContent = "‚ö†Ô∏è GPS non renseign√© : ajoute latitude/longitude pour un rep√®re parfait sur la carte.";
  }

  // CTA links
  const btnCall = document.getElementById("btnCall");
  btnCall.href = phone ? `tel:${phone}` : "#";
  btnCall.onclick = (e)=>{ if(!phone){ e.preventDefault(); alert("Num√©ro non disponible"); } };

  const btnWA = document.getElementById("btnWA");
  const wa = buildWA(phone, name);
  btnWA.href = wa || "#";
  btnWA.onclick = (e)=>{ if(!wa){ e.preventDefault(); alert("WhatsApp indisponible (num√©ro manquant)"); } };

  const btnOpenMap = document.getElementById("btnOpenMap");
  const gmap = googleMapsLink(lat, lng, name);
  btnOpenMap.href = gmap || "#";
  btnOpenMap.target = "_blank";
  btnOpenMap.rel = "noopener";
  btnOpenMap.onclick = (e)=>{ if(!gmap){ e.preventDefault(); alert("GPS manquant pour ouvrir la carte."); } };

  // Share
  const shareBtn = document.getElementById("btnShare");
  shareBtn.onclick = async ()=>{
    const url = window.location.href;
    try{
      if(navigator.share){
        await navigator.share({ title: document.title, text: `${name} ‚Äî fiche NDIMBAL`, url });
        showToast(`‚úÖ Partag√© : <strong>${escapeHTML(name)}</strong>`);
      }else{
        await navigator.clipboard.writeText(url);
        showToast(`üîó Lien copi√© : <strong>${escapeHTML(name)}</strong>`);
      }
    }catch(e){
      try{
        await navigator.clipboard.writeText(url);
        showToast(`üîó Lien copi√© : <strong>${escapeHTML(name)}</strong>`);
      }catch(err){
        alert("Impossible de partager automatiquement. Copie le lien dans la barre d‚Äôadresse.");
      }
    }
  };

  // Meta tags + JSON-LD
  setMetaTitleDesc(name, getCategoryLabel(catNorm), city);
  injectJsonLd(p);

  // show
  document.getElementById("loading").style.display = "none";
  document.getElementById("content").style.display = "grid";
}

/* ================================
   NAV: Retour carte (√©vite boucle)
================================ */
document.getElementById("btnBackMap").addEventListener("click", (e)=>{
  e.preventDefault();
  if(history.length > 1) history.back();
  else window.location.href = "map.html"; // <-- change ici si ta carte a un autre fichier
});

/* ================================
   INIT
================================ */
(async function init(){
  // 1) si pas de KEY -> astou direct
  const finalKey = KEY || DEFAULT_SLUG;
  if(!KEY){
    showToast(`‚ÑπÔ∏è Aucun slug fourni ‚Äî affichage <strong>${escapeHTML(DEFAULT_SLUG)}</strong> (priorit√© Astou).`);
  }

  // 2) Charge depuis Supabase
  let data = null;
  try{
    data = await fetchPro(finalKey);
  }catch(e){
    data = null;
  }

  if(!data){
    showErrorBox(
      "Partenaire introuvable",
      `Slug/ID demand√© : ${finalKey}. V√©rifie que la table 'professionals' contient bien ce slug (colonne 'slug').`
    );
    showToast(`‚ö†Ô∏è Introuvable : <strong>${escapeHTML(finalKey)}</strong>`);
    return;
  }

  if(data.region) data.region = String(data.region);
  renderPro(data);
})();
</script>

</body>
</html>
