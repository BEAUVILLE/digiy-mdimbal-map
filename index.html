<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DIGIY NDIMBAL MAP ‚Äî S√©n√©gal (Slug Ready)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>

  <style>
    :root{
      --primary:#FF6B35; --primary-dark:#E55A2B; --secondary:#4ECDC4;
      --success:#95E1D3; --warning:#FFD93D; --danger:#FF6B6B;
      --dark:#1A1A2E; --card:#16213E; --sidebar:#0F1419;
      --text:#FFFFFF; --muted:#B8B8B8; --radius:15px; --t: all .25s ease;

      --color-restaurant:#FF6B35; --color-commerce:#4ECDC4; --color-logement:#FFD93D;
      --color-taxi:#95E1D3; --color-notable:#9B59B6; --color-batiment:#E67E22;
      --color-voiture:#3498DB; --color-voyage:#1ABC9C; --color-loisir:#E91E63; --color-hotel:#FF9800;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden;height:100vh;background:#0b1020}

    .header{
      background:linear-gradient(135deg,var(--dark),#0F3460);
      padding:1rem 1.2rem; display:flex; gap:1rem; align-items:center; justify-content:space-between;
      box-shadow:0 4px 20px rgba(0,0,0,.5); position:relative; z-index:1000;
    }
    .logo-section{display:flex;align-items:center;gap:.8rem}
    .logo-infinity{font-size:2rem;font-weight:900;color:var(--primary)}
    .logo-text h1{font-size:1.25rem;color:var(--text);margin:0}
    .logo-text p{font-size:.85rem;color:var(--muted);margin:.1rem 0 0}

    .header-search{flex:1;max-width:560px}
    .search-input{
      width:100%; padding:.85rem 1rem; border:2px solid rgba(255,255,255,.12);
      border-radius:999px; background:rgba(255,255,255,.06); color:var(--text); font-size:1rem; transition:var(--t)
    }
    .search-input:focus{outline:none;border-color:var(--primary);background:rgba(255,255,255,.09)}

    .header-right{display:flex; align-items:center; gap:.6rem}
    .chip{
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:#fff; padding:.55rem .8rem; border-radius:999px; font-weight:700; font-size:.9rem;
      display:flex; gap:.45rem; align-items:center; cursor:pointer; transition:var(--t)
    }
    .chip:hover{transform:translateY(-1px);border-color:rgba(255,107,53,.45)}

    .main-container{display:flex;height:calc(100vh - 76px)}
    .sidebar{
      width:320px;background:var(--sidebar);overflow-y:auto; box-shadow:4px 0 20px rgba(0,0,0,.3);
      position:relative; z-index:900;
    }
    .sidebar-header{padding:1.2rem;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;text-align:center}
    .sidebar-header h2{font-size:1.15rem;margin:0 0 .25rem}
    .category-section{padding:1rem}
    .category-title{color:var(--muted);font-size:.82rem;text-transform:uppercase;margin-bottom:.7rem;padding:0 .5rem}
    .category-list{display:flex;flex-direction:column;gap:.5rem}
    .category-item{
      display:flex; align-items:center; gap:1rem; padding:1rem;
      background:rgba(255,255,255,.03); border-radius:var(--radius);
      cursor:pointer; transition:var(--t); border-left:4px solid transparent; position:relative;
    }
    .category-item:hover{background:rgba(255,255,255,.08); transform:translateX(5px)}
    .category-item.active{background:rgba(255,107,53,.2); border-left-color:var(--primary)}
    .category-icon{font-size:1.8rem; min-width:40px; text-align:center}
    .category-info{flex:1}
    .category-name{color:var(--text); font-weight:800; font-size:.95rem; margin-bottom:.15rem}
    .category-count{color:var(--muted); font-size:.8rem}

    .region-filter{padding:1rem;background:rgba(255,255,255,.02);margin:1rem;border-radius:var(--radius)}
    .region-filter-title{color:var(--text);font-size:.9rem;margin-bottom:.8rem;font-weight:800}
    .region-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
    .region-btn{
      padding:.55rem; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
      border-radius:10px; color:var(--text); font-size:.82rem; cursor:pointer; transition:var(--t); text-align:center;
    }
    .region-btn:hover{background:rgba(78,205,196,.2); border-color:var(--secondary)}
    .region-btn.active{background:var(--secondary); color:var(--dark); font-weight:900; border-color:var(--secondary)}

    .map-container{flex:1; position:relative}
    #map{width:100%; height:100%}

    .map-controls{
      position:absolute; top:1rem; right:1rem; z-index:800;
      display:flex; flex-direction:column; gap:.5rem;
    }
    .control-btn{
      background:#fff; border:none; padding:.8rem; border-radius:50%;
      width:45px; height:45px; cursor:pointer;
      box-shadow:0 4px 15px rgba(0,0,0,.2); transition:var(--t); font-size:1.15rem;
    }
    .control-btn:hover{transform:scale(1.08); box-shadow:0 6px 20px rgba(0,0,0,.3)}

    .leaflet-popup-content-wrapper{
      background:var(--card); color:var(--text); border-radius:var(--radius);
      padding:0; box-shadow:0 8px 32px rgba(0,0,0,.5);
    }
    .leaflet-popup-content{margin:0; min-width:280px}
    .popup-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));padding:1rem;border-radius:var(--radius) var(--radius) 0 0}
    .popup-title{font-size:1.15rem;font-weight:900;margin-bottom:.2rem}
    .popup-category{font-size:.85rem;opacity:.92}
    .popup-body{padding:1rem}
    .popup-info{display:flex;align-items:center;gap:.5rem;margin-bottom:.7rem;color:var(--muted);font-size:.9rem}
    .popup-description{color:var(--muted);font-size:.85rem;line-height:1.5;margin-bottom:1rem}
    .popup-actions{display:flex;gap:.5rem}
    .popup-btn{
      flex:1; padding:.65rem; border:none; border-radius:10px; font-weight:900; cursor:pointer; transition:var(--t); font-size:.85rem
    }
    .popup-btn-primary{background:var(--primary);color:#fff}
    .popup-btn-secondary{background:var(--secondary);color:var(--dark)}
    .popup-btn:hover{transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.3)}

    .custom-marker{
      display:flex; align-items:center; justify-content:center;
      width:35px;height:35px;border-radius:50%;
      border:3px solid #fff; box-shadow:0 4px 10px rgba(0,0,0,.3);
      font-size:1.2rem; cursor:pointer; transition:var(--t)
    }
    .custom-marker:hover{transform:scale(1.18)}
    .marker-restaurant{background:var(--color-restaurant)}
    .marker-commerce{background:var(--color-commerce)}
    .marker-logement{background:var(--color-logement)}
    .marker-taxi{background:var(--color-taxi)}
    .marker-notable{background:var(--color-notable)}
    .marker-batiment{background:var(--color-batiment)}
    .marker-voiture{background:var(--color-voiture)}
    .marker-voyage{background:var(--color-voyage)}
    .marker-loisir{background:var(--color-loisir)}
    .marker-hotel{background:var(--color-hotel)}

    .modal{
      display:none; position:fixed; z-index:2000; inset:0;
      background:rgba(0,0,0,.85); backdrop-filter: blur(5px);
    }
    .modal-content{
      background:var(--card); margin:2% auto; padding:1.6rem;
      border-radius:var(--radius); max-width:720px; max-height:85vh; overflow:auto;
      box-shadow:0 10px 50px rgba(0,0,0,.5); animation: slideIn .25s ease;
    }
    @keyframes slideIn{from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:2px solid rgba(255,255,255,.1)}
    .close{color:var(--muted);font-size:2rem;font-weight:900;cursor:pointer;transition:var(--t)}
    .close:hover{color:var(--danger)}
    .modal-body h2{color:var(--primary);margin-bottom:.7rem}
    .modal-info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.2rem}
    .info-card{background:rgba(255,255,255,.05); padding:1rem; border-radius:var(--radius)}
    .info-label{color:var(--muted);font-size:.85rem;margin-bottom:.25rem}
    .info-value{color:var(--text);font-weight:800}

    .loader{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      border:5px solid rgba(255,255,255,.1); border-top:5px solid var(--primary);
      border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; z-index:1000;
    }
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
    .hidden{display:none !important;}

    @media (max-width:1024px){ .sidebar{width:280px} }
    @media (max-width:768px){
      .header{flex-direction:column; align-items:stretch}
      .header-search{max-width:100%}
      .sidebar{position:absolute; left:-320px; height:calc(100vh - 140px); transition:left .3s ease; z-index:1000}
      .sidebar.open{left:0}
      .region-grid{grid-template-columns:1fr}
      .modal-info-grid{grid-template-columns:1fr}
    }

    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-track{background:var(--dark)}
    ::-webkit-scrollbar-thumb{background:var(--primary);border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:var(--primary-dark)}
  </style>
</head>

<body>

<header class="header">
  <div class="logo-section">
    <div class="logo-infinity">‚àû</div>
    <div class="logo-text">
      <h1>DIGIY NDIMBAL MAP</h1>
      <p>Annuaire g√©olocalis√© du S√©n√©gal ‚Ä¢ slug ready</p>
    </div>
  </div>

  <div class="header-search">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher un service, une ville, un nom..." />
  </div>

  <div class="header-right">
    <div class="chip" id="chipTotal" title="Total affich√©">üë• <span id="totalPros">0</span></div>
    <div class="chip" onclick="goBackHub()" title="Retour HUB">üè† HUB</div>
  </div>
</header>

<div class="main-container">

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>üóÇÔ∏è Cat√©gories</h2>
      <p style="font-size:.85rem; opacity:.9;">Clique pour filtrer</p>
    </div>

    <div class="category-section">
      <div class="category-title">Services</div>
      <div class="category-list">
        <div class="category-item active" data-category="all">
          <span class="category-icon">üåç</span>
          <div class="category-info">
            <div class="category-name">Tout afficher</div>
            <div class="category-count" id="count-all">0 r√©sultats</div>
          </div>
        </div>

        <div class="category-item" data-category="restaurant"><span class="category-icon">üçΩÔ∏è</span><div class="category-info"><div class="category-name">Restaurants</div><div class="category-count" id="count-restaurant">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="commerce"><span class="category-icon">üè™</span><div class="category-info"><div class="category-name">Commerces</div><div class="category-count" id="count-commerce">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="logement"><span class="category-icon">üè†</span><div class="category-info"><div class="category-name">Logements</div><div class="category-count" id="count-logement">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="taxi"><span class="category-icon">üöï</span><div class="category-info"><div class="category-name">Taxis & VTC</div><div class="category-count" id="count-taxi">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="notable"><span class="category-icon">üëî</span><div class="category-info"><div class="category-name">Notables</div><div class="category-count" id="count-notable">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="batiment"><span class="category-icon">üî®</span><div class="category-info"><div class="category-name">B√¢timent</div><div class="category-count" id="count-batiment">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="voiture"><span class="category-icon">üöó</span><div class="category-info"><div class="category-name">Voitures</div><div class="category-count" id="count-voiture">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="voyage"><span class="category-icon">‚úàÔ∏è</span><div class="category-info"><div class="category-name">Voyage</div><div class="category-count" id="count-voyage">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="loisir"><span class="category-icon">üé≠</span><div class="category-info"><div class="category-name">Loisirs</div><div class="category-count" id="count-loisir">0 r√©sultats</div></div></div>
        <div class="category-item" data-category="hotel"><span class="category-icon">üè®</span><div class="category-info"><div class="category-name">H√¥tels</div><div class="category-count" id="count-hotel">0 r√©sultats</div></div></div>
      </div>
    </div>

    <div class="region-filter">
      <div class="region-filter-title">üó∫Ô∏è Filtrer par r√©gion</div>
      <div class="region-grid" id="regionGrid">
        <button class="region-btn active" data-region="all">Toutes</button>
        <button class="region-btn" data-region="dakar">Dakar</button>
        <button class="region-btn" data-region="thies">Thi√®s (Saly)</button>
        <button class="region-btn" data-region="diourbel">Diourbel</button>
        <button class="region-btn" data-region="fatick">Fatick</button>
        <button class="region-btn" data-region="kaolack">Kaolack</button>
        <button class="region-btn" data-region="kaffrine">Kaffrine</button>
        <button class="region-btn" data-region="kolda">Kolda</button>
        <button class="region-btn" data-region="louga">Louga</button>
        <button class="region-btn" data-region="matam">Matam</button>
        <button class="region-btn" data-region="saint-louis">Saint-Louis</button>
        <button class="region-btn" data-region="sedhiou">S√©dhiou</button>
        <button class="region-btn" data-region="tambacounda">Tambacounda</button>
        <button class="region-btn" data-region="kedougou">K√©dougou</button>
        <button class="region-btn" data-region="ziguinchor">Ziguinchor</button>
      </div>
    </div>
  </aside>

  <div class="map-container">
    <div id="map"></div>

    <div class="map-controls">
      <button class="control-btn" onclick="centerMap()" title="Centrer S√©n√©gal">üéØ</button>
      <button class="control-btn" onclick="locateUser()" title="Ma position">üìç</button>
      <button class="control-btn" onclick="toggleSidebar()" title="Menu" style="display:none" id="menuBtn">‚ò∞</button>
    </div>

    <div class="loader" id="loader"></div>
  </div>

</div>

<div id="detailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="color:var(--primary); margin:0;">D√©tails du professionnel</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================================
   CONFIG SUPABASE
================================ */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================================
   GLOBALS
================================ */
let map, markerCluster;
let allProfessionals = [];
let filteredProfessionals = [];
let currentCategory = 'all';
let currentRegion = 'all';

const categoryIcons = {
  restaurant:'üçΩÔ∏è', commerce:'üè™', logement:'üè†', taxi:'üöï', notable:'üëî',
  batiment:'üî®', voiture:'üöó', voyage:'‚úàÔ∏è', loisir:'üé≠', hotel:'üè®'
};
const categoryColors = {
  restaurant:'#FF6B35', commerce:'#4ECDC4', logement:'#FFD93D', taxi:'#95E1D3',
  notable:'#9B59B6', batiment:'#E67E22', voiture:'#3498DB', voyage:'#1ABC9C', loisir:'#E91E63', hotel:'#FF9800'
};

/* ================================
   URL PARAMS
================================ */
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
const slugWanted = (getParam("pro") || "").trim();

/* ================================
   INIT
================================ */
document.addEventListener('DOMContentLoaded', async ()=>{
  initMap();
  await loadProfessionals();
  setupEventListeners();
  document.getElementById('loader').classList.add('hidden');

  // ‚úÖ si slug demand√© => focus direct
  if(slugWanted){
    await focusBySlug(slugWanted);
  }
});

/* ================================
   MAP
================================ */
function initMap(){
  map = L.map('map').setView([14.4974,-14.4524], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© OpenStreetMap | DIGIYLYFE',
    maxZoom: 19
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover:false,
    maxClusterRadius:50
  });
  map.addLayer(markerCluster);

  if(window.innerWidth<=768) document.getElementById('menuBtn').style.display='block';
}
function centerMap(){ map.setView([14.4974,-14.4524], 7); }

function locateUser(){
  if(!navigator.geolocation) return alert("G√©olocalisation non support√©e");
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const { latitude, longitude } = pos.coords;
      map.setView([latitude, longitude], 13);
      L.marker([latitude, longitude]).addTo(map).bindPopup("üìç Vous √™tes ici").openPopup();
    },
    ()=> alert("Impossible de r√©cup√©rer votre position")
  );
}
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }
function goBackHub(){ window.location.href = "https://beauville.github.io/digiy-hub/"; }

/* ================================
   NORMALIZE (Saly = Thi√®s)
================================ */
function fold(s){
  return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function normRegion(r, city){
  const v = fold(r || city || '');
  if(!v) return '';
  if(v.includes('dakar')) return 'dakar';
  if(v.includes('thies') || v.includes('thi√®s') || v.includes('saly') || v.includes('mbour')) return 'thies';
  if(v.includes('ziguinchor')) return 'ziguinchor';
  if(v.includes('saint-louis') || v.includes('saintlouis')) return 'saint-louis';
  if(v.includes('fatick')) return 'fatick';
  if(v.includes('kaolack')) return 'kaolack';
  if(v.includes('louga')) return 'louga';
  if(v.includes('tambacounda')) return 'tambacounda';
  if(v.includes('diourbel')) return 'diourbel';
  if(v.includes('matam')) return 'matam';
  return (r||'').toString().toLowerCase().replace(/\s+/g,'-');
}
function normCategory(cat){
  const c = fold(cat);
  if(c.includes('resto') || c.includes('restaurant')) return 'restaurant';
  if(c.includes('commerce') || c.includes('market') || c.includes('boutique')) return 'commerce';
  if(c.includes('logement') || c.includes('heberg') || c.includes('h√©berg') || c.includes('villa')) return 'logement';
  if(c.includes('hotel') || c.includes('h√¥tel')) return 'hotel';
  if(c.includes('taxi') || c.includes('vtc') || c.includes('driver') || c.includes('chauffeur')) return 'taxi';
  if(c.includes('bat') || c.includes('b√¢t') || c.includes('construction') || c.includes('artisan')) return 'batiment';
  if(c.includes('voyage') || c.includes('explore') || c.includes('guide')) return 'voyage';
  if(c.includes('loisir')) return 'loisir';
  if(c.includes('notable')) return 'notable';
  if(c.includes('voiture')) return 'voiture';
  return 'commerce';
}

/* ================================
   DATA LOAD (FIX is_active)
================================ */
async function loadProfessionals(){
  try{
    // ‚úÖ plus de .eq("is_active", true) => √©vite ERROR 42703
    const { data, error } = await SB.from('professionals').select('*').order('created_at', { ascending:false });

    if(error){
      console.warn("Supabase error (fallback demo):", error);
      allProfessionals = generateDemoData();
    }else{
      allProfessionals = (data || []).map(p => ({
        ...p,
        region: normRegion(p.region, p.city),
        category: normCategory(p.category || p.cat || p.type || ''),
      }));
    }

    filteredProfessionals = [...allProfessionals];
    displayMarkers(filteredProfessionals);
    updateCounts();
  }catch(err){
    console.warn("Load error => fallback demo:", err);
    allProfessionals = generateDemoData();
    filteredProfessionals = [...allProfessionals];
    displayMarkers(filteredProfessionals);
    updateCounts();
  }
}

/* ================================
   DEMO DATA
================================ */
function generateDemoData(){
  const categories = Object.keys(categoryIcons);
  const regions = ['dakar','thies','diourbel','saint-louis','kaolack','ziguinchor','louga','tambacounda','fatick','matam'];
  const demo=[];
  for(let i=0;i<60;i++){
    const cat = categories[i % categories.length];
    const reg = regions[Math.floor(Math.random()*regions.length)];
    demo.push({
      id:`demo-${i}`,
      slug:`demo-${i}`,
      name:`Pro D√©mo ${i+1}`,
      category:cat,
      region:reg,
      city: reg.charAt(0).toUpperCase()+reg.slice(1),
      description:"Service de qualit√© ‚Äî NDIMBAL d√©mo",
      phone:"+221770000000",
      rating:(4+Math.random()).toFixed(1),
      latitude: 14.4974 + (Math.random()-0.5)*2.2,
      longitude:-14.4524 + (Math.random()-0.5)*3.0,
      hours:"Lun-Sam 8h-20h",
      services:["Service 1","Service 2"]
    });
  }
  return demo;
}

/* ================================
   MARKERS
================================ */
function displayMarkers(pros){
  markerCluster.clearLayers();

  pros.forEach(pro=>{
    const lat = pro.latitude ?? pro.lat ?? pro.gps_lat;
    const lng = pro.longitude ?? pro.lng ?? pro.gps_lng;

    // ‚úÖ si pas de coordonn√©es => pas de marker (mais le pro existe)
    if(!lat || !lng) return;

    const cat = pro.category || 'commerce';
    const icon = L.divIcon({
      className:'custom-div-icon',
      html:`<div class="custom-marker marker-${cat}">${categoryIcons[cat] || 'üìç'}</div>`,
      iconSize:[35,35],
      iconAnchor:[17,17]
    });

    const marker = L.marker([Number(lat), Number(lng)], { icon });
    marker._digiy_pro_id = pro.id;
    marker._digiy_slug = pro.slug;

    marker.bindPopup(createPopupContent(pro));
    markerCluster.addLayer(marker);
  });
}

function createPopupContent(pro){
  return `
    <div class="popup-header">
      <div class="popup-title">${escapeHTML(pro.name || "Professionnel")}</div>
      <div class="popup-category">${getCategoryLabel(pro.category)}</div>
    </div>
    <div class="popup-body">
      <div class="popup-info">üìç ${escapeHTML(pro.city || "")} ${pro.region ? "‚Ä¢ " + escapeHTML(getRegionLabel(pro.region)) : ""}</div>
      <div class="popup-info">‚≠ê ${escapeHTML(pro.rating || "5.0")} ‚Ä¢ üìû ${escapeHTML(pro.phone || "N/A")}</div>
      <div class="popup-description">${escapeHTML((pro.description || "Service professionnel").slice(0,110))}${(pro.description||"").length>110?'‚Ä¶':''}</div>
      <div class="popup-actions">
        <button class="popup-btn popup-btn-primary" onclick='openDetailsModal("${String(pro.id)}")'>üëÅÔ∏è D√©tails</button>
        <button class="popup-btn popup-btn-secondary" onclick='contactPro("${String(pro.id)}")'>üìû Contact</button>
      </div>
    </div>
  `;
}

/* ================================
   FILTERS
================================ */
function filterProfessionals(){
  const term = document.getElementById('searchInput').value.toLowerCase().trim();
  let res = [...allProfessionals];

  if(currentCategory !== 'all') res = res.filter(p => (p.category||'') === currentCategory);
  if(currentRegion !== 'all') res = res.filter(p => (p.region||'') === currentRegion);

  if(term){
    res = res.filter(p => {
      const t = (p.name||'')+' '+(p.city||'')+' '+(p.description||'')+' '+(p.slug||'');
      return t.toLowerCase().includes(term);
    });
  }

  filteredProfessionals = res;
  displayMarkers(res);
  updateCounts();
}

function updateCounts(){
  document.getElementById('totalPros').textContent = String(filteredProfessionals.length);
  document.getElementById('count-all').textContent = `${filteredProfessionals.length} r√©sultats`;

  Object.keys(categoryIcons).forEach(cat=>{
    const c = filteredProfessionals.filter(p=>(p.category||'')===cat).length;
    const el = document.getElementById(`count-${cat}`);
    if(el) el.textContent = `${c} r√©sultats`;
  });
}

/* ================================
   MODAL + ACTIONS
================================ */
function openDetailsModal(proId){
  const pro = allProfessionals.find(p => String(p.id) === String(proId));
  if(!pro) return;

  const lat = pro.latitude ?? pro.lat ?? pro.gps_lat;
  const lng = pro.longitude ?? pro.lng ?? pro.gps_lng;

  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = `
    <h2>${escapeHTML(pro.name || "")}</h2>
    <p style="color:var(--secondary); margin-bottom: 1rem; font-weight:900;">${getCategoryLabel(pro.category)}</p>

    <div class="modal-info-grid">
      <div class="info-card"><div class="info-label">‚ôæÔ∏è Slug</div><div class="info-value">${escapeHTML(pro.slug || "N/A")}</div></div>
      <div class="info-card"><div class="info-label">üìç Localisation</div><div class="info-value">${escapeHTML(pro.city || "")}${pro.region? ", "+escapeHTML(getRegionLabel(pro.region)):""}</div></div>
      <div class="info-card"><div class="info-label">‚≠ê Note</div><div class="info-value">${escapeHTML(pro.rating || "5.0")} / 5</div></div>
      <div class="info-card"><div class="info-label">üìû T√©l√©phone</div><div class="info-value">${escapeHTML(pro.phone || "N/A")}</div></div>
      <div class="info-card"><div class="info-label">üìß Email</div><div class="info-value">${escapeHTML(pro.email || "N/A")}</div></div>
      <div class="info-card"><div class="info-label">‚è∞ Horaires</div><div class="info-value">${escapeHTML(pro.hours || "N/A")}</div></div>
    </div>

    <div style="margin-bottom:1rem;">
      <div style="color:var(--muted); font-size:.85rem; margin-bottom:.5rem;">üìù Description</div>
      <p style="color:var(--text); line-height:1.6;">${escapeHTML(pro.description || "")}</p>
    </div>

    <div style="margin-bottom:1.2rem;">
      <div style="color:var(--muted); font-size:.85rem; margin-bottom:.5rem;">üè∑Ô∏è Services</div>
      <div style="display:flex; flex-wrap:wrap; gap:.5rem;">
        ${(pro.services || []).map(s=>`<span style="background:rgba(78,205,196,.2); color:var(--secondary); padding:.4rem 1rem; border-radius:999px; font-size:.85rem; font-weight:800;">${escapeHTML(s)}</span>`).join('')}
      </div>
    </div>

    <div style="display:flex; gap:1rem;">
      <button onclick="contactPro('${String(pro.id)}')" style="flex:1; padding:1rem; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:900; cursor:pointer;">
        üìû Contacter
      </button>
      <button onclick="viewOnMap('${String(pro.id)}')" style="flex:1; padding:1rem; background:var(--secondary); color:var(--dark); border:none; border-radius:12px; font-weight:900; cursor:pointer;">
        üó∫Ô∏è Voir sur la carte
      </button>
    </div>

    ${(!lat || !lng) ? `<div style="margin-top:1rem; color:#ffd93d; font-weight:900;">‚ö†Ô∏è Ce pro n‚Äôa pas encore de coordonn√©es GPS, donc pas de marqueur sur la carte.</div>` : ``}
  `;

  document.getElementById('detailsModal').style.display = 'block';
}

function closeModal(){ document.getElementById('detailsModal').style.display = 'none'; }

function contactPro(proId){
  const pro = allProfessionals.find(p => String(p.id) === String(proId));
  if(!pro || !pro.phone) return alert("Num√©ro non disponible");
  window.location.href = `tel:${pro.phone}`;
}

function viewOnMap(proId){
  const pro = allProfessionals.find(p => String(p.id) === String(proId));
  const lat = pro?.latitude ?? pro?.lat ?? pro?.gps_lat;
  const lng = pro?.longitude ?? pro?.lng ?? pro?.gps_lng;
  if(!pro || !lat || !lng) return alert("Coordonn√©es GPS manquantes pour ce pro.");
  closeModal();
  map.setView([Number(lat), Number(lng)], 15);
}

/* ================================
   SLUG FOCUS
================================ */
async function focusBySlug(slug){
  let pro = allProfessionals.find(p => (p.slug||'') === slug);

  if(!pro){
    const { data, error } = await SB
      .from("professionals")
      .select("*")
      .eq("slug", slug)
      .maybeSingle();

    if(!error && data){
      pro = {
        ...data,
        region: normRegion(data.region, data.city),
        category: normCategory(data.category || data.cat || data.type || '')
      };
      allProfessionals.push(pro);
      filteredProfessionals = [...allProfessionals];
      displayMarkers(filteredProfessionals);
      updateCounts();
    }
  }

  if(!pro){
    document.getElementById('searchInput').value = slug;
    filterProfessionals();
    alert("Pro introuvable via ce slug : " + slug);
    return;
  }

  const lat = pro.latitude ?? pro.lat ?? pro.gps_lat;
  const lng = pro.longitude ?? pro.lng ?? pro.gps_lng;

  if(lat && lng){
    map.setView([Number(lat), Number(lng)], 15);
  }

  let targetMarker = null;
  markerCluster.eachLayer(layer=>{
    if(layer && layer._digiy_slug === slug) targetMarker = layer;
  });

  if(targetMarker){
    markerCluster.zoomToShowLayer(targetMarker, ()=>{
      targetMarker.openPopup();
    });
  }

  setTimeout(()=> openDetailsModal(String(pro.id)), 400);
}

/* ================================
   HELPERS
================================ */
function getCategoryLabel(category){
  const labels = {
    restaurant:'üçΩÔ∏è Restaurant', commerce:'üè™ Commerce', logement:'üè† Logement',
    taxi:'üöï Taxi/VTC', notable:'üëî Notable', batiment:'üî® B√¢timent',
    voiture:'üöó Voiture', voyage:'‚úàÔ∏è Voyage', loisir:'üé≠ Loisir', hotel:'üè® H√¥tel'
  };
  return labels[category] || 'üìç Service';
}
function getRegionLabel(region){
  return (region||'').toString().replace(/-/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
}
function escapeHTML(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ================================
   EVENTS
================================ */
function setupEventListeners(){
  document.getElementById('searchInput').addEventListener('input', filterProfessionals);

  document.querySelectorAll('.category-item').forEach(item=>{
    item.addEventListener('click', ()=>{
      document.querySelectorAll('.category-item').forEach(i=>i.classList.remove('active'));
      item.classList.add('active');
      currentCategory = item.dataset.category;
      filterProfessionals();
    });
  });

  document.querySelectorAll('.region-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.region-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentRegion = btn.dataset.region;
      filterProfessionals();
    });
  });

  window.onclick = (event)=>{
    if(event.target && event.target.id === 'detailsModal') closeModal();
  };
}
</script>

</body>
</html>
