<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGIY NDIMBAL MAP â€” Saly QG âˆ (Supabase)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  /* ============================================ */
  /* ğŸ¨ THÃˆME SABLE & OR â€” DIGIYLYFE Premium */
  /* ============================================ */
  :root{
    --bg-1: #f7f3ea;
    --bg-2: #efe7d6;
    --ink: #1f2937;
    --muted: #6b7280;
    --card: #ffffff;
    --line: rgba(31,41,55,.08);
    --shadow: 0 10px 30px rgba(0,0,0,.06);

    --gold-1: #d1b464;
    --gold-2: #b89231;
    --gold-3: #f3e6b3;

    --accent-cta-1: #b38728;
    --accent-cta-2: #f9d976;

    --radius-xl: 28px;
    --radius-lg: 18px;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--ink);
    background: linear-gradient(180deg, var(--bg-1), #fbfaf7 40%, #ffffff 100%);
    overflow: hidden;
  }

  /* ============================================ */
  /* ğŸ“Œ HEADER DIGIY */
  /* ============================================ */
  .digiy-header {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color: #111;
    padding: 16px 24px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    position: relative;
    z-index: 1000;
  }
  .digiy-header h1 {
    font-size: clamp(18px, 4vw, 28px);
    font-weight: 900;
    letter-spacing: .5px;
    margin: 0;
    text-shadow: 0 1px 2px rgba(255,255,255,.3);
  }
  .digiy-header p {
    font-size: clamp(12px, 2.5vw, 14px);
    margin: 4px 0 0;
    opacity: .85;
    font-weight: 600;
  }

  /* ============================================ */
  /* ğŸ” BARRE DE RECHERCHE */
  /* ============================================ */
  .search-panel {
    position: absolute;
    top: 120px;
    left: 20px;
    z-index: 999;
    background: rgba(255,255,255,.96);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    width: 320px;
    max-width: calc(100vw - 40px);
  }

  .search-panel input {
    width: 100%;
    padding: 12px 14px;
    font-size: 14px;
    border: 1px solid var(--line);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all .2s ease;
  }
  .search-panel input:focus {
    outline: none;
    border-color: var(--gold-1);
    box-shadow: 0 0 0 3px rgba(209,180,100,.25);
  }

  .search-panel select {
    width: 100%;
    padding: 10px 12px;
    font-size: 13px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: white;
    margin-bottom: 12px;
    cursor: pointer;
  }

  .partner-count {
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    margin-top: 8px;
  }

  .partner-list {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 12px;
    border-top: 1px solid var(--line);
    padding-top: 12px;
  }

  .partner-item {
    padding: 8px 10px;
    margin: 4px 0;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 10px;
    cursor: pointer;
    transition: all .2s ease;
    font-size: 13px;
  }
  .partner-item:hover {
    background: linear-gradient(135deg, var(--gold-3), #fde68a);
    border-color: var(--gold-1);
    transform: translateX(4px);
  }
  .partner-item strong {
    display: block;
    font-size: 14px;
    margin-bottom: 2px;
    color: var(--ink);
  }
  .partner-item span {
    color: var(--muted);
    font-size: 12px;
  }

  .loading-msg {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-weight: 600;
  }

  /* ============================================ */
  /* ğŸ—ºï¸ CARTE */
  /* ============================================ */
  #map {
    position: absolute;
    top: 110px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* Marker personnalisÃ© */
  .digiy-marker {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    width: 36px;
    height: 36px;
    transform: rotate(-45deg);
    box-shadow: 0 4px 12px rgba(0,0,0,.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .digiy-marker span {
    transform: rotate(45deg);
  }

  /* Popup personnalisÃ©e */
  .leaflet-popup-content-wrapper {
    border-radius: var(--radius-lg);
    padding: 0;
    overflow: hidden;
    box-shadow: 0 12px 32px rgba(0,0,0,.2);
  }
  .leaflet-popup-content {
    margin: 0;
    padding: 16px;
    min-width: 280px;
  }
  .popup-header {
    font-size: 16px;
    font-weight: 900;
    margin-bottom: 8px;
    color: var(--ink);
  }
  .popup-meta {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .popup-desc {
    font-size: 13px;
    margin-bottom: 12px;
    color: #4b5563;
  }
  .popup-cta {
    display: flex;
    gap: 8px;
  }
  .popup-btn {
    flex: 1;
    padding: 10px;
    text-align: center;
    text-decoration: none;
    font-weight: 800;
    font-size: 12px;
    border-radius: 10px;
    transition: all .2s ease;
  }
  .popup-btn.whatsapp {
    background: linear-gradient(135deg, #35d07f, #0d9f54);
    color: white;
  }
  .popup-btn.view {
    background: linear-gradient(135deg, var(--accent-cta-2), var(--accent-cta-1));
    color: #111;
  }
  .popup-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }

  /* ============================================ */
  /* ğŸ“± MOBILE */
  /* ============================================ */
  @media (max-width: 640px) {
    .search-panel {
      top: 100px;
      left: 10px;
      width: calc(100vw - 20px);
      padding: 12px;
    }
    #map {
      top: 90px;
    }
    .digiy-header h1 {
      font-size: 18px;
    }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="digiy-header">
  <h1>ğŸ—ºï¸ DIGIY NDIMBAL MAP â€” Saly QG âˆ</h1>
  <p>ğŸ“ L'entraide digitale du SÃ©nÃ©gal â€¢ Pierre par pierre</p>
</header>

<!-- PANNEAU DE RECHERCHE -->
<div class="search-panel">
  <input type="search" id="searchInput" placeholder="ğŸ” Rechercher (chauffeur, villa, plombier...)" />
  
  <select id="categoryFilter">
    <option value="all">ğŸŒŸ Toutes catÃ©gories</option>
    <option value="hebergement">ğŸ¨ HÃ©bergement</option>
    <option value="market">ğŸ›’ Market & Style</option>
    <option value="driver">ğŸš— Driver</option>
    <option value="construction">ğŸ—ï¸ BÃ¢tisseur</option>
    <option value="explore">ğŸŒ´ Explore</option>
  </select>

  <div class="partner-count" id="partnerCount">
    <div class="loading-msg">â³ Chargement des partenaires...</div>
  </div>

  <div class="partner-list" id="partnerList"></div>
</div>

<!-- CARTE -->
<div id="map"></div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ============================================
// ğŸ” SUPABASE â€” DÃ‰JÃ€ POSÃ‰
// ============================================
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

let supabaseClient;
if (typeof window.supabase !== 'undefined') {
  supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} else {
  console.error('Supabase library not loaded');
}

// ============================================
// ğŸ—ºï¸ DIGIY NDIMBAL MAP â€” Saly QG
// ============================================

// CoordonnÃ©es QG Saly (Astou Boutique) - Par dÃ©faut
const QG_SALY = {
  lat: 14.4574,
  lng: -16.9984,
  name: "QG DIGIYLYFE Saly"
};

// Variables globales
let map;
let markers;
let allMarkers = [];
let partners = [];

// Attendre que Leaflet ET Supabase soient chargÃ©s
window.addEventListener('load', function() {
  if (typeof L === 'undefined' || typeof window.supabase === 'undefined') {
    console.error('Leaflet ou Supabase non chargÃ©, nouvelle tentative...');
    setTimeout(initApp, 500);
  } else {
    initApp();
  }
});

async function initApp() {
  console.log('ğŸ¦… Initialisation DIGIY NDIMBAL MAP...');
  
  // Charger les partenaires depuis Supabase
  await loadPartnersFromSupabase();
  
  // Initialiser la carte
  initMap();
  
  // Initialiser la recherche
  initSearch();
}

// ============================================
// ğŸ“¥ CHARGEMENT SUPABASE
// ============================================
async function loadPartnersFromSupabase() {
  try {
    console.log('ğŸ“¥ Chargement des partenaires depuis Supabase...');
    
    // RÃ©cupÃ©rer les partenaires de la table 'partners'
    const { data, error } = await supabaseClient
      .from('partners')
      .select('*')
      .eq('location', 'Saly') // Filtrer par Saly
      .order('name', { ascending: true });

    if (error) {
      console.error('âŒ Erreur Supabase:', error);
      // Fallback sur les donnÃ©es locales
      useFallbackData();
      return;
    }

    if (data && data.length > 0) {
      console.log(`âœ… ${data.length} partenaires chargÃ©s depuis Supabase`);
      partners = data.map(p => ({
        id: p.id || p.slug,
        name: p.name,
        category: p.category,
        description: p.description || '',
        price: p.price || 'Sur demande',
        whatsapp: p.whatsapp_url,
        link: p.website_url || p.whatsapp_url,
        icon: p.icon || getCategoryIcon(p.category),
        keywords: p.keywords || '',
        lat: p.latitude || QG_SALY.lat,
        lng: p.longitude || QG_SALY.lng
      }));
    } else {
      console.log('âš ï¸ Aucun partenaire trouvÃ©, utilisation des donnÃ©es locales');
      useFallbackData();
    }

  } catch (err) {
    console.error('âŒ Erreur de connexion Supabase:', err);
    useFallbackData();
  }
}

// DonnÃ©es de fallback si Supabase Ã©choue
function useFallbackData() {
  console.log('ğŸ“¦ Utilisation des donnÃ©es locales de fallback');
  partners = [
    {
      id: "baptiste-saly",
      name: "ğŸï¸ Chez Baptiste â€” Saly",
      category: "hebergement",
      description: "Appartement meublÃ© â€” 2 chambres, salon, cuisine",
      price: "30 000 FCFA / nuit",
      whatsapp: "https://wa.me/221771342889?text=Salam%20je%20veux%20rÃ©server%20Chez%20Baptiste%20Saly%20ğŸ™",
      link: "https://digiylyfe.com/partenaires-chez-baptiste/",
      icon: "ğŸï¸",
      keywords: "saly appartement meuble 2 chambres cuisine hebergement",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "lamine",
      name: "ğŸš— Lamine â€” Chauffeur",
      category: "driver",
      description: "Transferts AIBD et circuits â€¢ Saly â€“ ThiÃ¨s â€“ Dakar",
      price: "Sur demande",
      whatsapp: "https://wa.me/221784413680?text=Salam%20Lamine%20DIGIYLYFE%20(j'aimerais%20rÃ©server%20un%20trajet)",
      link: "https://digiylyfe.com/partenaires-lamine/",
      icon: "ğŸš—",
      keywords: "chauffeur taxi transport aibd dakar saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "michel",
      name: "âœ‚ï¸ Michel â€” Styliste",
      category: "market",
      description: "Robes personnalisÃ©es â€¢ Saly â€“ ThiÃ¨s",
      price: "Sur mesure",
      whatsapp: "https://wa.me/221783718492?text=Salam%20Michel%20DIGIYLYFE%20je%20veux%20une%20crÃ©ation%20ğŸ‘—",
      link: "https://digiylyfe.com/page-partenaire-michel/",
      icon: "âœ‚ï¸",
      keywords: "styliste couture robes personnalisees vetements saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "zal",
      name: "âš¡ Zal & Kourant â€” Ã‰lectriciens",
      category: "construction",
      description: "Ã‰lectricitÃ© maison & bÃ¢timent â€¢ Saly",
      price: "Devis rapide",
      whatsapp: "https://wa.me/221772084781?text=Salam%20Zal%20je%20viens%20de%20DIGIYLYFE",
      link: "https://digiylyfe.com/partenaires-zal-kourant/",
      icon: "âš¡",
      keywords: "electricien electricite maison depannage saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "helage",
      name: "ğŸ’§ Helage â€” Plombier",
      category: "construction",
      description: "Plomberie multi-services â€¢ Saly â€“ Petite CÃ´te",
      price: "Sur demande / devis",
      whatsapp: "https://wa.me/221774513523?text=Salam%20Helage%2C%20je%20viens%20de%20DIGIYLYFE",
      link: "tel:+221774513523",
      icon: "ğŸ’§",
      keywords: "plombier plomberie depannage fuite robinet saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "astou",
      name: "ğŸ§µ Astou â€” Linge de maison",
      category: "market",
      description: "Linge de maison & couture sur mesure â€¢ Saly",
      price: "Promo locale",
      whatsapp: "https://wa.me/221778765785?text=Salam%20Astou%20je%20viens%20de%20DIGIYLYFE",
      link: "https://digiylyfe.com/partenaires-astou/",
      icon: "ğŸ§µ",
      keywords: "linge maison couture serviette torchon drap saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "daouda",
      name: "ğŸŒ´ Daouda Explore",
      category: "explore",
      description: "Guide local â€” circuits authentiques â€¢ Saly",
      price: "Circuits sur mesure",
      whatsapp: "https://wa.me/221771342889?text=Salam%20Daouda%20DIGIYLYFE%20circuit%20ğŸŒ´",
      link: "https://digiylyfe.com/partenaires-daouda/",
      icon: "ğŸŒ´",
      keywords: "guide touristique circuit marche saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "tonton-elhadji",
      name: "ğŸ‘œ Tonton Elhadji",
      category: "market",
      description: "SÃ©lection sacs & montres â€” qualitÃ© â€¢ Saly",
      price: "Stock limitÃ©",
      whatsapp: "https://wa.me/221778329612?text=Salam%20Tonton%20DIGIYLYFE%20ğŸ‘œ",
      link: "https://digiylyfe.com/partenaire-tonton-elhadji/",
      icon: "ğŸ‘œ",
      keywords: "sacs montres accessoires maroquinerie saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    },
    {
      id: "mbaye",
      name: "ğŸ‘· Mbaye Diouf â€” BÃ¢tisseur",
      category: "construction",
      description: "Villas modernes, piscines â€¢ Dakar â€“ ThiÃ¨s â€“ Petite CÃ´te",
      price: "Visite chantier",
      whatsapp: "https://wa.me/221776427113?text=Salam%20Mbaye%20je%20veux%20parler%20d%E2%80%99un%20projet%20ğŸ—ï¸%20(DIGIYLYFE)",
      link: "https://digiylyfe.com/partenaires-mbaye/",
      icon: "ğŸ‘·",
      keywords: "batisseur villa piscine travaux construction saly",
      lat: QG_SALY.lat,
      lng: QG_SALY.lng
    }
  ];
}

function getCategoryIcon(category) {
  const icons = {
    hebergement: 'ğŸ¨',
    driver: 'ğŸš—',
    market: 'ğŸ›’',
    construction: 'ğŸ—ï¸',
    explore: 'ğŸŒ´'
  };
  return icons[category] || 'ğŸ“';
}

// ============================================
// ğŸ—ºï¸ INITIALISATION CARTE
// ============================================
function initMap() {
  console.log('ğŸ—ºï¸ Initialisation de la carte...');
  
  // Initialisation carte
  map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: true
  }).setView([QG_SALY.lat, QG_SALY.lng], 15);

  // Tuile OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap | DIGIYLYFE âˆ',
    maxZoom: 19
  }).addTo(map);

  // Cluster de markers
  markers = L.markerClusterGroup({
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
  });

  // Ajouter tous les partenaires
  allMarkers = [];
  partners.forEach(partner => {
    const marker = L.marker([partner.lat, partner.lng], {
      icon: createCustomIcon(partner.icon)
    }).bindPopup(createPopup(partner));
    
    marker.partnerData = partner;
    allMarkers.push(marker);
    markers.addLayer(marker);
  });

  map.addLayer(markers);

  // Ajouter le marker QG
  const qgMarker = L.marker([QG_SALY.lat, QG_SALY.lng], {
    icon: L.divIcon({
      className: 'custom-marker',
      html: `<div class="digiy-marker" style="width:48px;height:48px;border-width:4px;"><span style="font-size:24px;">âˆ</span></div>`,
      iconSize: [48, 48],
      iconAnchor: [24, 48],
      popupAnchor: [0, -48]
    })
  }).bindPopup(`
    <div class="popup-header">ğŸ¢ QG DIGIYLYFE Saly</div>
    <div class="popup-meta">ğŸ“ Centre de coordination</div>
    <div class="popup-desc">${partners.length} partenaires locaux â€¢ 0% commission â€¢ Entraide digitale</div>
    <div class="popup-cta">
      <a href="https://digiylyfe.com" target="_blank" class="popup-btn view">ğŸŒ DIGIYLYFE</a>
    </div>
  `).addTo(map);

  console.log(`âœ… Carte initialisÃ©e avec ${partners.length} partenaires`);
}

// Fonction pour crÃ©er un marker personnalisÃ©
function createCustomIcon(icon) {
  return L.divIcon({
    className: 'custom-marker',
    html: `<div class="digiy-marker"><span>${icon}</span></div>`,
    iconSize: [36, 36],
    iconAnchor: [18, 36],
    popupAnchor: [0, -36]
  });
}

// Fonction pour crÃ©er le contenu popup
function createPopup(partner) {
  return `
    <div class="popup-header">${partner.name}</div>
    <div class="popup-meta">ğŸ“ ${partner.category.toUpperCase()}</div>
    <div class="popup-desc">${partner.description}</div>
    ${partner.price ? `<div class="popup-meta">ğŸ’° ${partner.price}</div>` : ''}
    <div class="popup-cta">
      ${partner.whatsapp ? `<a href="${partner.whatsapp}" target="_blank" class="popup-btn whatsapp">ğŸ’¬ WhatsApp</a>` : ''}
      <a href="${partner.link}" target="_blank" class="popup-btn view">ğŸ” Voir</a>
    </div>
  `;
}

// ============================================
// ğŸ” RECHERCHE & FILTRES
// ============================================
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');
  const partnerCount = document.getElementById('partnerCount');
  const partnerList = document.getElementById('partnerList');

  function normalizeText(text) {
    return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function updateDisplay() {
    const searchTerm = normalizeText(searchInput.value.trim());
    const category = categoryFilter.value;
    
    // Filtrer les partenaires
    const filtered = partners.filter(p => {
      const matchCategory = category === 'all' || p.category === category;
      const matchSearch = !searchTerm || 
        normalizeText(p.name + ' ' + p.description + ' ' + p.keywords).includes(searchTerm);
      return matchCategory && matchSearch;
    });

    // Mettre Ã  jour le compteur
    partnerCount.innerHTML = `${filtered.length} partenaire${filtered.length > 1 ? 's' : ''} â€¢ QG Saly`;

    // Mettre Ã  jour la liste
    partnerList.innerHTML = filtered.map(p => `
      <div class="partner-item" onclick="focusPartner('${p.id}')">
        <strong>${p.name}</strong>
        <span>${p.description}</span>
      </div>
    `).join('');

    // Mettre Ã  jour les markers sur la carte
    if (markers) {
      markers.clearLayers();
      allMarkers.forEach(marker => {
        if (filtered.find(p => p.id === marker.partnerData.id)) {
          markers.addLayer(marker);
        }
      });
    }
  }

  // Focus sur un partenaire
  window.focusPartner = function(partnerId) {
    const marker = allMarkers.find(m => m.partnerData.id === partnerId);
    if (marker) {
      map.setView([marker.partnerData.lat, marker.partnerData.lng], 17);
      marker.openPopup();
    }
  };

  // Event listeners
  searchInput.addEventListener('input', updateDisplay);
  categoryFilter.addEventListener('change', updateDisplay);

  // Initialisation
  updateDisplay();
}

// Fallback si window.load a dÃ©jÃ  eu lieu
if (document.readyState === 'complete') {
  initApp();
}

console.log('ğŸ¦… DIGIY NDIMBAL MAP Saly (Supabase) â€” PrÃªt ! Pierre par pierre âˆ');
</script>

</body>
</html>
