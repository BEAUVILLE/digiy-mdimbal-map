<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGIY NDIMBAL MAP ‚Äî Saly Multi-QG √ó Modules ‚àû</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  /* ============================================ */
  /* üé® TH√àME DIGIY ‚Äî Inspir√© MARKET */
  /* ============================================ */
  :root{
    --bg:#020617;
    --card:#030712;
    --accent:#facc15;
    --accent2:#22c55e;
    --ink:#f9fafb;
    --muted:#cbd5e1;
    --border:rgba(148,163,184,0.35);

    /* Couleurs QG */
    --qg-centre: #f97316;
    --qg-station: #0ea5e9;
    --qg-niakhal: #10b981;

    /* Couleurs Modules DIGIY */
    --module-driver: #0ea5e9;
    --module-resto: #f97316;
    --module-loc: #10b981;
    --module-market: #ec4899;
    --module-build: #eab308;
    --module-explore: #8b5cf6;
    --module-jobs: #6366f1;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    color: var(--ink);
    background: var(--bg);
    overflow: hidden;
  }

  /* ============================================ */
  /* üìå HEADER DIGIY */
  /* ============================================ */
  .digiy-header {
    background: linear-gradient(135deg, #facc15, #f97316);
    color: #111;
    padding: 14px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 16px rgba(250,204,21,0.4);
    position: relative;
    z-index: 1000;
  }

  .header-brand {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .brand-logo {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    background: radial-gradient(circle at 30% 0%, #facc15, #f97316);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    box-shadow: 0 8px 20px rgba(250,204,21,0.5);
  }

  .brand-text h1 {
    font-size: clamp(18px, 4vw, 24px);
    font-weight: 900;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin: 0;
  }

  .brand-text p {
    font-size: clamp(11px, 2.5vw, 13px);
    opacity: 0.85;
    font-weight: 700;
    margin: 2px 0 0;
  }

  .header-stats {
    display: flex;
    gap: 8px;
    font-size: 12px;
    font-weight: 800;
  }

  .stat-badge {
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(0,0,0,0.3);
  }

  /* ============================================ */
  /* üîç PANNEAU RECHERCHE */
  /* ============================================ */
  .search-panel {
    position: absolute;
    top: 90px;
    left: 20px;
    z-index: 999;
    background: var(--card);
    border-radius: 20px;
    padding: 18px;
    box-shadow: 0 16px 40px rgba(0,0,0,0.6);
    border: 1px solid var(--border);
    width: 360px;
    max-width: calc(100vw - 40px);
    transition: all .3s ease;
  }

  .search-toggle {
    display: none;
    position: absolute;
    top: 95px;
    left: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, var(--accent), #f97316);
    color: #111;
    border: none;
    padding: 12px 18px;
    border-radius: 14px;
    font-weight: 900;
    font-size: 14px;
    box-shadow: 0 6px 16px rgba(250,204,21,0.4);
    cursor: pointer;
    transition: all .2s;
  }
  .search-toggle:active {
    transform: scale(0.95);
  }

  .search-panel input {
    width: 100%;
    padding: 13px 16px;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: rgba(15,23,42,0.8);
    color: var(--ink);
    margin-bottom: 14px;
    transition: all .2s ease;
    font-weight: 600;
  }
  .search-panel input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(250,204,21,0.2);
  }

  .search-panel select {
    width: 100%;
    padding: 11px 14px;
    font-size: 13px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: rgba(15,23,42,0.8);
    color: var(--ink);
    margin-bottom: 14px;
    cursor: pointer;
    font-weight: 700;
  }

  .filter-section {
    margin-bottom: 16px;
  }

  .filter-label {
    font-size: 12px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
    display: block;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  .filter-btn {
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 800;
    cursor: pointer;
    transition: all .2s;
    border: 2px solid transparent;
    text-align: center;
    white-space: nowrap;
  }

  .filter-btn.all {
    background: linear-gradient(135deg, var(--accent), #f97316);
    color: #111;
  }
  .filter-btn.all.active {
    border-color: #fff;
    box-shadow: 0 0 0 2px rgba(250,204,21,0.5);
  }

  /* QG Filters */
  .filter-btn.qg-centre {
    background: var(--qg-centre);
    color: white;
  }
  .filter-btn.qg-centre.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(249,115,22,0.6);
  }

  .filter-btn.qg-station {
    background: var(--qg-station);
    color: white;
  }
  .filter-btn.qg-station.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(14,165,233,0.6);
  }

  .filter-btn.qg-niakhal {
    background: var(--qg-niakhal);
    color: white;
  }
  .filter-btn.qg-niakhal.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(16,185,129,0.6);
  }

  /* Module Filters */
  .filter-btn.module-driver {
    background: var(--module-driver);
    color: white;
  }
  .filter-btn.module-driver.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(14,165,233,0.6);
  }

  .filter-btn.module-resto {
    background: var(--module-resto);
    color: white;
  }
  .filter-btn.module-resto.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(249,115,22,0.6);
  }

  .filter-btn.module-loc {
    background: var(--module-loc);
    color: white;
  }
  .filter-btn.module-loc.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(16,185,129,0.6);
  }

  .filter-btn.module-market {
    background: var(--module-market);
    color: white;
  }
  .filter-btn.module-market.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(236,72,153,0.6);
  }

  .filter-btn.module-build {
    background: var(--module-build);
    color: white;
  }
  .filter-btn.module-build.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(234,179,8,0.6);
  }

  .filter-btn.module-explore {
    background: var(--module-explore);
    color: white;
  }
  .filter-btn.module-explore.active {
    border-color: #fff;
    box-shadow: 0 4px 12px rgba(139,92,246,0.6);
  }

  .filter-btn:hover {
    transform: translateY(-2px);
  }

  .partner-count {
    font-size: 14px;
    font-weight: 800;
    color: var(--accent);
    margin: 14px 0 10px;
    text-align: center;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    margin-bottom: 14px;
  }

  .stat-item {
    padding: 8px;
    border-radius: 10px;
    text-align: center;
    font-size: 11px;
    font-weight: 800;
    color: white;
  }

  .partner-list {
    max-height: 280px;
    overflow-y: auto;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }

  .partner-item {
    padding: 12px;
    margin: 6px 0;
    background: rgba(15,23,42,0.6);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: 12px;
    cursor: pointer;
    transition: all .2s ease;
  }

  .partner-item:hover {
    background: rgba(15,23,42,0.9);
    border-left-width: 6px;
    transform: translateX(4px);
  }

  .partner-item strong {
    display: block;
    font-size: 15px;
    margin-bottom: 4px;
    color: var(--ink);
  }

  .partner-item .desc {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .partner-badges {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 6px;
  }

  .badge {
    display: inline-block;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 800;
    color: white;
  }

  /* ============================================ */
  /* üó∫Ô∏è CARTE */
  /* ============================================ */
  #map {
    position: absolute;
    top: 80px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* Marker personnalis√© */
  .digiy-marker {
    background: linear-gradient(135deg, var(--accent), #f97316);
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    width: 38px;
    height: 38px;
    transform: rotate(-45deg);
    box-shadow: 0 4px 14px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 19px;
  }
  .digiy-marker span {
    transform: rotate(45deg);
  }

  /* Markers color√©s par module */
  .digiy-marker.module-driver { background: var(--module-driver); }
  .digiy-marker.module-resto { background: var(--module-resto); }
  .digiy-marker.module-loc { background: var(--module-loc); }
  .digiy-marker.module-market { background: var(--module-market); }
  .digiy-marker.module-build { background: var(--module-build); }
  .digiy-marker.module-explore { background: var(--module-explore); }

  /* Popup personnalis√©e */
  .leaflet-popup-content-wrapper {
    border-radius: 18px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 14px 36px rgba(0,0,0,0.3);
    background: var(--card);
  }
  .leaflet-popup-content {
    margin: 0;
    padding: 18px;
    min-width: 300px;
  }
  .popup-header {
    font-size: 18px;
    font-weight: 900;
    margin-bottom: 10px;
    color: var(--accent);
  }
  .popup-badges {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .popup-badge {
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 800;
    color: white;
  }
  .popup-desc {
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--muted);
    line-height: 1.5;
  }
  .popup-price {
    font-size: 13px;
    color: var(--accent2);
    font-weight: 800;
    margin-bottom: 14px;
  }
  .popup-cta {
    display: flex;
    gap: 8px;
  }
  .popup-btn {
    flex: 1;
    padding: 11px;
    text-align: center;
    text-decoration: none;
    font-weight: 900;
    font-size: 13px;
    border-radius: 12px;
    transition: all .2s ease;
  }
  .popup-btn.whatsapp {
    background: rgba(34,197,94,0.2);
    border: 1px solid var(--accent2);
    color: #bbf7d0;
  }
  .popup-btn.view {
    background: linear-gradient(135deg, var(--accent), #f97316);
    color: #111;
    box-shadow: 0 6px 16px rgba(250,204,21,0.4);
  }
  .popup-btn:hover {
    transform: translateY(-2px);
  }

  /* ============================================ */
  /* üì± MOBILE - RESPONSIVE */
  /* ============================================ */
  @media (max-width: 768px) {
    .digiy-header {
      padding: 12px 14px;
    }

    .header-stats {
      display: none;
    }

    .search-panel {
      top: 70px;
      left: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: none;
      padding: 16px;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
      transform: translateY(-120%);
      opacity: 0;
      pointer-events: none;
    }

    .search-panel.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }

    .search-toggle {
      display: block;
      top: 75px;
      left: 10px;
    }

    .filter-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .filter-btn {
      font-size: 11px;
      padding: 8px 10px;
    }

    .partner-list {
      max-height: 200px;
    }

    #map {
      top: 70px;
    }

    .leaflet-popup-content {
      min-width: 260px;
      padding: 16px;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .brand-logo {
      width: 40px;
      height: 40px;
      font-size: 22px;
    }

    .filter-btn {
      font-size: 10px;
      padding: 7px 8px;
    }

    .popup-btn {
      font-size: 12px;
      padding: 9px;
    }
  }

  /* Scrollbar custom */
  .partner-list::-webkit-scrollbar {
    width: 6px;
  }
  .partner-list::-webkit-scrollbar-track {
    background: rgba(15,23,42,0.5);
    border-radius: 10px;
  }
  .partner-list::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 10px;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="digiy-header">
  <div class="header-brand">
    <div class="brand-logo">üó∫Ô∏è</div>
    <div class="brand-text">
      <h1>DIGIY NDIMBAL MAP</h1>
      <p>Saly Multi-QG √ó Modules ‚Ä¢ 0% Commission ‚àû</p>
    </div>
  </div>
  <div class="header-stats">
    <div class="stat-badge">9 Partenaires</div>
    <div class="stat-badge">3 QG</div>
    <div class="stat-badge">6 Modules</div>
  </div>
</header>

<!-- BOUTON TOGGLE MOBILE -->
<button class="search-toggle" id="searchToggle" onclick="toggleSearch()">
  üîç Rechercher
</button>

<!-- PANNEAU DE RECHERCHE -->
<div class="search-panel" id="searchPanel">
  <input type="search" id="searchInput" placeholder="üîç Rechercher (nom, service, quartier...)" />
  
  <select id="categoryFilter">
    <option value="all">üåü Toutes cat√©gories</option>
    <option value="hebergement">üè® H√©bergement</option>
    <option value="market">üõí Market & Style</option>
    <option value="driver">üöó Driver</option>
    <option value="construction">üèóÔ∏è B√¢tisseur</option>
    <option value="explore">üå¥ Explore</option>
  </select>

  <!-- FILTRES QG -->
  <div class="filter-section">
    <span class="filter-label">üìç Par Quartier (QG)</span>
    <div class="filter-grid">
      <div class="filter-btn all active" data-type="qg" data-value="all" onclick="filterBy('qg', 'all')">
        ‚àû Tous
      </div>
      <div class="filter-btn qg-centre" data-type="qg" data-value="centre" onclick="filterBy('qg', 'centre')">
        üè™ Centre
      </div>
      <div class="filter-btn qg-station" data-type="qg" data-value="station" onclick="filterBy('qg', 'station')">
        üèñÔ∏è Station
      </div>
      <div class="filter-btn qg-niakhal" data-type="qg" data-value="niakhal" onclick="filterBy('qg', 'niakhal')">
        üè° Niakhal
      </div>
    </div>
  </div>

  <!-- FILTRES MODULE -->
  <div class="filter-section">
    <span class="filter-label">üéØ Par Module DIGIY</span>
    <div class="filter-grid">
      <div class="filter-btn all active" data-type="module" data-value="all" onclick="filterBy('module', 'all')">
        ‚àû Tous
      </div>
      <div class="filter-btn module-driver" data-type="module" data-value="DIGIY_DRIVER" onclick="filterBy('module', 'DIGIY_DRIVER')">
        üöó DRIVER
      </div>
      <div class="filter-btn module-loc" data-type="module" data-value="DIGIY_LOC" onclick="filterBy('module', 'DIGIY_LOC')">
        üè† LOC
      </div>
      <div class="filter-btn module-market" data-type="module" data-value="DIGIY_MARKET" onclick="filterBy('module', 'DIGIY_MARKET')">
        üõí MARKET
      </div>
      <div class="filter-btn module-build" data-type="module" data-value="DIGIY_BUILD" onclick="filterBy('module', 'DIGIY_BUILD')">
        üèóÔ∏è BUILD
      </div>
      <div class="filter-btn module-explore" data-type="module" data-value="DIGIY_EXPLORE" onclick="filterBy('module', 'DIGIY_EXPLORE')">
        üå¥ EXPLORE
      </div>
    </div>
  </div>

  <div class="partner-count" id="partnerCount">9 partenaires ‚Ä¢ 3 QG ‚Ä¢ 6 modules</div>

  <!-- STATS EN TEMPS R√âEL -->
  <div class="stats-grid" id="statsGrid"></div>

  <div class="partner-list" id="partnerList"></div>
</div>

<!-- CARTE -->
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ============================================
// üîç TOGGLE SEARCH PANEL
// ============================================
function toggleSearch() {
  const panel = document.getElementById('searchPanel');
  const button = document.getElementById('searchToggle');
  
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
    button.textContent = 'üîç Rechercher';
  } else {
    panel.classList.add('open');
    button.textContent = '‚úï Fermer';
  }
}

// ============================================
// üó∫Ô∏è D√âFINITION DES QG
// ============================================
const QG_SALY = {
  centre: {
    id: 'centre',
    name: 'QG Saly Centre',
    hub: 'Astou Boutique',
    description: 'Hub textile, market & artisanat',
    lat: 14.4574,
    lng: -16.9984,
    color: '#f97316',
    emoji: 'üè™'
  },
  station: {
    id: 'station',
    name: 'QG Saly Station',
    hub: 'Chez Baptiste',
    description: 'Hub h√©bergement, tourisme & loisirs',
    lat: 14.4520,
    lng: -16.9920,
    color: '#0ea5e9',
    emoji: 'üèñÔ∏è'
  },
  niakhal: {
    id: 'niakhal',
    name: 'QG Niakh Niakhal',
    hub: 'Garage Lamine',
    description: 'Hub services, construction & transport',
    lat: 14.4610,
    lng: -17.0050,
    color: '#10b981',
    emoji: 'üè°'
  }
};

// ============================================
// üìä MODULES DIGIY
// ============================================
const DIGIY_MODULES = {
  DIGIY_DRIVER: { name: 'DIGIY DRIVER', emoji: 'üöó', color: '#0ea5e9' },
  DIGIY_RESTO: { name: 'DIGIY RESTO', emoji: 'üçΩÔ∏è', color: '#f97316' },
  DIGIY_LOC: { name: 'DIGIY LOC', emoji: 'üè†', color: '#10b981' },
  DIGIY_MARKET: { name: 'DIGIY MARKET', emoji: 'üõí', color: '#ec4899' },
  DIGIY_BUILD: { name: 'DIGIY BUILD', emoji: 'üèóÔ∏è', color: '#eab308' },
  DIGIY_EXPLORE: { name: 'DIGIY EXPLORE', emoji: 'üå¥', color: '#8b5cf6' },
  DIGIY_JOBS: { name: 'DIGIY JOBS', emoji: 'üíº', color: '#6366f1' }
};

// ============================================
// üìä PARTENAIRES AVEC QG + MODULE
// ============================================
const partners = [
  // QG CENTRE
  {
    id: "astou",
    name: "üßµ Astou ‚Äî Linge de maison",
    category: "market",
    module: "DIGIY_MARKET",
    description: "Linge de maison & couture sur mesure",
    price: "Promo locale",
    whatsapp: "https://wa.me/221778765785?text=Salam%20Astou%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-astou/",
    icon: "üßµ",
    keywords: "linge maison couture serviette drap saly",
    qg: 'centre',
    isHub: true
  },
  {
    id: "tonton-elhadji",
    name: "üëú Tonton Elhadji",
    category: "market",
    module: "DIGIY_MARKET",
    description: "Sacs & montres ‚Äî qualit√© premium",
    price: "Stock limit√©",
    whatsapp: "https://wa.me/221778329612?text=Salam%20Tonton%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaire-tonton-elhadji/",
    icon: "üëú",
    keywords: "sacs montres accessoires saly",
    qg: 'centre'
  },
  {
    id: "michel",
    name: "‚úÇÔ∏è Michel ‚Äî Styliste",
    category: "market",
    module: "DIGIY_MARKET",
    description: "Robes personnalis√©es ‚Ä¢ Saly ‚Äì Thi√®s",
    price: "Sur mesure",
    whatsapp: "https://wa.me/221783718492?text=Salam%20Michel%20DIGIYLYFE",
    link: "https://digiylyfe.com/page-partenaire-michel/",
    icon: "‚úÇÔ∏è",
    keywords: "styliste couture robes saly",
    qg: 'centre'
  },

  // QG STATION
  {
    id: "baptiste-saly",
    name: "üèùÔ∏è Chez Baptiste ‚Äî Saly",
    category: "hebergement",
    module: "DIGIY_LOC",
    description: "Appartement meubl√© 2 chambres",
    price: "30 000 FCFA / nuit",
    whatsapp: "https://wa.me/221771342889?text=Salam%20Baptiste%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-chez-baptiste/",
    icon: "üèùÔ∏è",
    keywords: "appartement hebergement saly",
    qg: 'station',
    isHub: true
  },
  {
    id: "daouda",
    name: "üå¥ Daouda Explore",
    category: "explore",
    module: "DIGIY_EXPLORE",
    description: "Guide local circuits authentiques",
    price: "Circuits sur mesure",
    whatsapp: "https://wa.me/221771342889?text=Salam%20Daouda%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-daouda/",
    icon: "üå¥",
    keywords: "guide touristique circuit saly",
    qg: 'station'
  },

  // QG NIAKH NIAKHAL
  {
    id: "lamine",
    name: "üöó Lamine ‚Äî Chauffeur",
    category: "driver",
    module: "DIGIY_DRIVER",
    description: "Transferts AIBD et circuits",
    price: "Sur demande",
    whatsapp: "https://wa.me/221784413680?text=Salam%20Lamine%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-lamine/",
    icon: "üöó",
    keywords: "chauffeur taxi transport saly",
    qg: 'niakhal',
    isHub: true
  },
  {
    id: "zal",
    name: "‚ö° Zal & Kourant ‚Äî √âlectriciens",
    category: "construction",
    module: "DIGIY_BUILD",
    description: "√âlectricit√© maison & b√¢timent",
    price: "Devis rapide",
    whatsapp: "https://wa.me/221772084781?text=Salam%20Zal%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-zal-kourant/",
    icon: "‚ö°",
    keywords: "electricien electricite saly",
    qg: 'niakhal'
  },
  {
    id: "helage",
    name: "üíß Helage ‚Äî Plombier",
    category: "construction",
    module: "DIGIY_BUILD",
    description: "Plomberie multi-services",
    price: "Sur demande",
    whatsapp: "https://wa.me/221774513523?text=Salam%20Helage%20DIGIYLYFE",
    link: "tel:+221774513523",
    icon: "üíß",
    keywords: "plombier plomberie saly",
    qg: 'niakhal'
  },
  {
    id: "mbaye",
    name: "üë∑ Mbaye Diouf ‚Äî B√¢tisseur",
    category: "construction",
    module: "DIGIY_BUILD",
    description: "Villas modernes, piscines",
    price: "Visite chantier",
    whatsapp: "https://wa.me/221776427113?text=Salam%20Mbaye%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-mbaye/",
    icon: "üë∑",
    keywords: "batisseur villa construction saly",
    qg: 'niakhal'
  }
];

// Variables globales
let map;
let markers;
let allMarkers = [];
let currentQGFilter = 'all';
let currentModuleFilter = 'all';

// ============================================
// ‚è≥ INITIALISATION
// ============================================
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
})();

function initAll() {
  console.log('ü¶Ö DIGIY NDIMBAL MAP Multi-QG √ó Modules...');
  
  if (typeof L === 'undefined') {
    setTimeout(initAll, 100);
    return;
  }
  
  initMap();
  initSearch();
  initMobileHandlers();
  updateStats();
}

// ============================================
// üó∫Ô∏è INITIALISATION CARTE
// ============================================
function initMap() {
  const centerLat = (QG_SALY.centre.lat + QG_SALY.station.lat + QG_SALY.niakhal.lat) / 3;
  const centerLng = (QG_SALY.centre.lng + QG_SALY.station.lng + QG_SALY.niakhal.lng) / 3;

  map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: true
  }).setView([centerLat, centerLng], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap | DIGIYLYFE ‚àû',
    maxZoom: 19
  }).addTo(map);

  markers = L.markerClusterGroup({
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
  });

  allMarkers = [];
  partners.forEach(function(partner) {
    const qgData = QG_SALY[partner.qg];
    const moduleData = DIGIY_MODULES[partner.module];
    
    const marker = L.marker([qgData.lat, qgData.lng], {
      icon: createCustomIcon(partner.icon, partner.module)
    }).bindPopup(createPopup(partner));
    
    marker.partnerData = partner;
    allMarkers.push(marker);
    markers.addLayer(marker);
  });

  map.addLayer(markers);

  // Markers QG
  Object.keys(QG_SALY).forEach(function(qgKey) {
    const qg = QG_SALY[qgKey];
    const qgPartners = partners.filter(function(p) { return p.qg === qgKey; });
    
    const qgMarker = L.marker([qg.lat, qg.lng], {
      icon: L.divIcon({
        className: 'custom-marker',
        html: '<div class="digiy-marker" style="width:52px;height:52px;border-width:4px;background:' + qg.color + ';"><span style="font-size:28px;">‚àû</span></div>',
        iconSize: [52, 52],
        iconAnchor: [26, 52],
        popupAnchor: [0, -52]
      })
    }).bindPopup(createQGPopup(qg, qgPartners)).addTo(map);
  });

  console.log('‚úÖ Carte : ' + partners.length + ' partenaires, 3 QG');
}

function createCustomIcon(icon, module) {
  const moduleClass = module.toLowerCase().replace('digiy_', 'module-');
  return L.divIcon({
    className: 'custom-marker',
    html: '<div class="digiy-marker ' + moduleClass + '"><span>' + icon + '</span></div>',
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -38]
  });
}

function createPopup(partner) {
  const qgData = QG_SALY[partner.qg];
  const moduleData = DIGIY_MODULES[partner.module];
  const hubBadge = partner.isHub ? '<span class="popup-badge" style="background:#facc15;color:#111;">HUB</span>' : '';
  
  return `
    <div class="popup-header">${partner.name}</div>
    <div class="popup-badges">
      <span class="popup-badge" style="background:${qgData.color}">${qgData.emoji} ${qgData.name}</span>
      <span class="popup-badge" style="background:${moduleData.color}">${moduleData.emoji} ${moduleData.name}</span>
      ${hubBadge}
    </div>
    <div class="popup-desc">${partner.description}</div>
    ${partner.price ? '<div class="popup-price">üí∞ ' + partner.price + '</div>' : ''}
    <div class="popup-cta">
      ${partner.whatsapp ? '<a href="' + partner.whatsapp + '" target="_blank" class="popup-btn whatsapp">üí¨ WhatsApp</a>' : ''}
      <a href="${partner.link}" target="_blank" class="popup-btn view">üîé Voir</a>
    </div>
  `;
}

function createQGPopup(qg, qgPartners) {
  const hub = qgPartners.find(function(p) { return p.isHub; });
  
  return `
    <div class="popup-header">${qg.emoji} ${qg.name}</div>
    <div class="popup-desc">${qg.description}</div>
    ${hub ? '<div class="popup-price"><strong>Hub:</strong> ' + hub.name + '</div>' : ''}
    <div class="popup-desc">üë• ${qgPartners.length} partenaire${qgPartners.length > 1 ? 's' : ''}</div>
    <div class="popup-cta">
      <a href="https://digiylyfe.com" target="_blank" class="popup-btn view">üåê DIGIYLYFE</a>
    </div>
  `;
}

// ============================================
// üîç RECHERCHE & FILTRES
// ============================================
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');

  function normalizeText(text) {
    return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function updateDisplay() {
    const searchTerm = normalizeText(searchInput.value.trim());
    const category = categoryFilter.value;
    
    const filtered = partners.filter(function(p) {
      const matchQG = currentQGFilter === 'all' || p.qg === currentQGFilter;
      const matchModule = currentModuleFilter === 'all' || p.module === currentModuleFilter;
      const matchCategory = category === 'all' || p.category === category;
      const matchSearch = !searchTerm || 
        normalizeText(p.name + ' ' + p.description + ' ' + p.keywords).includes(searchTerm);
      return matchQG && matchModule && matchCategory && matchSearch;
    });

    const partnerCount = document.getElementById('partnerCount');
    partnerCount.textContent = filtered.length + ' partenaire' + (filtered.length > 1 ? 's' : '');

    const partnerList = document.getElementById('partnerList');
    partnerList.innerHTML = filtered.map(function(p) {
      const qgData = QG_SALY[p.qg];
      const moduleData = DIGIY_MODULES[p.module];
      return '<div class="partner-item" onclick="focusPartner(\'' + p.id + '\')">' +
        '<strong>' + p.name + '</strong>' +
        '<div class="desc">' + p.description + '</div>' +
        '<div class="partner-badges">' +
        '<span class="badge" style="background:' + qgData.color + '">' + qgData.emoji + ' ' + qgData.name + '</span>' +
        '<span class="badge" style="background:' + moduleData.color + '">' + moduleData.emoji + ' ' + moduleData.name + '</span>' +
        '</div>' +
        '</div>';
    }).join('');

    if (markers) {
      markers.clearLayers();
      allMarkers.forEach(function(marker) {
        if (filtered.find(function(p) { return p.id === marker.partnerData.id; })) {
          markers.addLayer(marker);
        }
      });
    }

    updateStats();
  }

  searchInput.addEventListener('input', updateDisplay);
  categoryFilter.addEventListener('change', updateDisplay);

  updateDisplay();
}

window.filterBy = function(type, value) {
  if (type === 'qg') {
    currentQGFilter = value;
    document.querySelectorAll('.filter-btn[data-type="qg"]').forEach(function(el) {
      el.classList.remove('active');
    });
    document.querySelector('.filter-btn[data-type="qg"][data-value="' + value + '"]').classList.add('active');
    
    if (value !== 'all') {
      const qgData = QG_SALY[value];
      map.setView([qgData.lat, qgData.lng], 16);
    }
  } else if (type === 'module') {
    currentModuleFilter = value;
    document.querySelectorAll('.filter-btn[data-type="module"]').forEach(function(el) {
      el.classList.remove('active');
    });
    document.querySelector('.filter-btn[data-type="module"][data-value="' + value + '"]').classList.add('active');
  }
  
  const searchInput = document.getElementById('searchInput');
  searchInput.dispatchEvent(new Event('input'));
};

window.focusPartner = function(partnerId) {
  const marker = allMarkers.find(function(m) { return m.partnerData.id === partnerId; });
  if (marker) {
    const qgData = QG_SALY[marker.partnerData.qg];
    map.setView([qgData.lat, qgData.lng], 17);
    marker.openPopup();
    
    if (window.innerWidth <= 768) {
      const panel = document.getElementById('searchPanel');
      const button = document.getElementById('searchToggle');
      panel.classList.remove('open');
      button.textContent = 'üîç Rechercher';
    }
  }
};

function updateStats() {
  const qgStats = {};
  const moduleStats = {};
  
  partners.forEach(function(p) {
    qgStats[p.qg] = (qgStats[p.qg] || 0) + 1;
    moduleStats[p.module] = (moduleStats[p.module] || 0) + 1;
  });
  
  const statsGrid = document.getElementById('statsGrid');
  const statItems = [];
  
  Object.keys(qgStats).forEach(function(qgKey) {
    const qg = QG_SALY[qgKey];
    statItems.push('<div class="stat-item" style="background:' + qg.color + '">' + qg.emoji + ' ' + qgStats[qgKey] + '</div>');
  });
  
  statsGrid.innerHTML = statItems.join('');
}

// ============================================
// üì± HANDLERS MOBILE
// ============================================
function initMobileHandlers() {
  if (window.innerWidth <= 768) {
    document.getElementById('map').addEventListener('click', function() {
      const panel = document.getElementById('searchPanel');
      const button = document.getElementById('searchToggle');
      if (panel.classList.contains('open')) {
        panel.classList.remove('open');
        button.textContent = 'üîç Rechercher';
      }
    });
  }
}

console.log('ü¶Ö DIGIY NDIMBAL MAP Multi-QG √ó Modules ‚Äî Pr√™t ! ‚àû');
</script>

</body>
</html>
