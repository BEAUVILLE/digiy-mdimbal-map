<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIY NDIMBAL MAP - Carte Interactive Nationale du S√©n√©gal</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        /* ================================
           VARIABLES CSS
        ================================ */
        :root {
            --primary-color: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary-color: #4ECDC4;
            --success-color: #95E1D3;
            --warning-color: #FFD93D;
            --danger-color: #FF6B6B;
            --dark-bg: #1A1A2E;
            --card-bg: #16213E;
            --sidebar-bg: #0F1419;
            --text-light: #FFFFFF;
            --text-gray: #B8B8B8;
            --border-radius: 15px;
            --transition: all 0.3s ease;
            
            /* COULEURS PAR CAT√âGORIE */
            --color-restaurant: #FF6B35;
            --color-commerce: #4ECDC4;
            --color-logement: #FFD93D;
            --color-taxi: #95E1D3;
            --color-notable: #9B59B6;
            --color-batiment: #E67E22;
            --color-voiture: #3498DB;
            --color-voyage: #1ABC9C;
            --color-loisir: #E91E63;
            --color-hotel: #FF9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* ================================
           HEADER COMPACT
        ================================ */
        .header {
            background: linear-gradient(135deg, var(--dark-bg), #0F3460);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-infinity {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }

        .logo-text p {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .header-search {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.08);
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            color: var(--text-light);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        /* ================================
           LAYOUT PRINCIPAL
        ================================ */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        /* ================================
           SIDEBAR CAT√âGORIES
        ================================ */
        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 900;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .category-section {
            padding: 1rem;
        }

        .category-title {
            color: var(--text-gray);
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.8rem;
            padding: 0 0.5rem;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            position: relative;
        }

        .category-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .category-item.active {
            background: rgba(255, 107, 53, 0.2);
            border-left-color: var(--primary-color);
        }

        .category-icon {
            font-size: 1.8rem;
            min-width: 40px;
            text-align: center;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
        }

        .category-count {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .category-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* PINS COLOR√âS PAR CAT√âGORIE */
        .category-item[data-category="restaurant"] { border-left-color: var(--color-restaurant); }
        .category-item[data-category="commerce"] { border-left-color: var(--color-commerce); }
        .category-item[data-category="logement"] { border-left-color: var(--color-logement); }
        .category-item[data-category="taxi"] { border-left-color: var(--color-taxi); }
        .category-item[data-category="notable"] { border-left-color: var(--color-notable); }
        .category-item[data-category="batiment"] { border-left-color: var(--color-batiment); }
        .category-item[data-category="voiture"] { border-left-color: var(--color-voiture); }
        .category-item[data-category="voyage"] { border-left-color: var(--color-voyage); }
        .category-item[data-category="loisir"] { border-left-color: var(--color-loisir); }
        .category-item[data-category="hotel"] { border-left-color: var(--color-hotel); }

        /* ================================
           R√âGION FILTER
        ================================ */
        .region-filter {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            margin: 1rem;
            border-radius: var(--border-radius);
        }

        .region-filter-title {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .region-btn {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .region-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            border-color: var(--secondary-color);
        }

        .region-btn.active {
            background: var(--secondary-color);
            color: var(--dark-bg);
            font-weight: bold;
            border-color: var(--secondary-color);
        }

        /* ================================
           CARTE PRINCIPALE
        ================================ */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ================================
           CONTROLS CARTE
        ================================ */
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 800;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-btn {
            background: white;
            border: none;
            padding: 0.8rem;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* ================================
           POPUP CUSTOM
        ================================ */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text-light);
            border-radius: var(--border-radius);
            padding: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 280px;
        }

        .popup-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 1rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .popup-category {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .popup-body {
            padding: 1rem;
        }

        .popup-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .popup-description {
            color: var(--text-gray);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .popup-actions {
            display: flex;
            gap: 0.5rem;
        }

        .popup-btn {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .popup-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .popup-btn-secondary {
            background: var(--secondary-color);
            color: var(--dark-bg);
        }

        .popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* ================================
           LEGEND
        ================================ */
        .map-legend {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 800;
            max-width: 280px;
        }

        .legend-title {
            color: var(--text-light);
            font-weight: bold;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }

        /* ================================
           MODAL D√âTAILS
        ================================ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .close {
            color: var(--text-gray);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close:hover {
            color: var(--danger-color);
        }

        .modal-body h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .info-label {
            color: var(--text-gray);
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        .info-value {
            color: var(--text-light);
            font-weight: 600;
        }

        /* ================================
           LOADER
        ================================ */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            z-index: 1000;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ================================
           RESPONSIVE
        ================================ */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }

            .header-stats {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .header-search {
                margin: 0;
                max-width: 100%;
            }

            .sidebar {
                position: absolute;
                left: -320px;
                height: calc(100vh - 140px);
                transition: left 0.3s ease;
                z-index: 1000;
            }

            .sidebar.open {
                left: 0;
            }

            .region-grid {
                grid-template-columns: 1fr;
            }

            .map-legend {
                display: none;
            }

            .modal-content {
                margin: 5% 1rem;
                max-width: calc(100% - 2rem);
            }

            .modal-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ================================
           UTILITY CLASSES
        ================================ */
        .hidden {
            display: none !important;
        }

        /* ================================
           SCROLLBAR
        ================================ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ================================
           CUSTOM MARKERS
        ================================ */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .custom-marker:hover {
            transform: scale(1.2);
        }

        .marker-restaurant { background: var(--color-restaurant); }
        .marker-commerce { background: var(--color-commerce); }
        .marker-logement { background: var(--color-logement); }
        .marker-taxi { background: var(--color-taxi); }
        .marker-notable { background: var(--color-notable); }
        .marker-batiment { background: var(--color-batiment); }
        .marker-voiture { background: var(--color-voiture); }
        .marker-voyage { background: var(--color-voyage); }
        .marker-loisir { background: var(--color-loisir); }
        .marker-hotel { background: var(--color-hotel); }
    </style>
</head>
<body>

    <!-- ================================
         HEADER
    ================================ -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-infinity">‚àû</div>
            <div class="logo-text">
                <h1>DIGIY NDIMBAL MAP</h1>
                <p>L'annuaire g√©olocalis√© du S√©n√©gal</p>
            </div>
        </div>
        
        <div class="header-search">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher un service, une ville, un nom...">
        </div>

        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalPros">0</div>
                <div class="stat-label">Professionnels</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">14</div>
                <div class="stat-label">R√©gions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">10</div>
                <div class="stat-label">Cat√©gories</div>
            </div>
        </div>
    </header>

    <!-- ================================
         MAIN CONTAINER
    ================================ -->
    <div class="main-container">
        
        <!-- SIDEBAR CAT√âGORIES -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üóÇÔ∏è Cat√©gories</h2>
                <p style="font-size: 0.85rem; opacity: 0.9;">Cliquez pour filtrer</p>
            </div>

            <div class="category-section">
                <div class="category-title">Services Principaux</div>
                <div class="category-list">
                    <div class="category-item active" data-category="all">
                        <span class="category-icon">üåç</span>
                        <div class="category-info">
                            <div class="category-name">Tout afficher</div>
                            <div class="category-count" id="count-all">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="restaurant">
                        <span class="category-icon">üçΩÔ∏è</span>
                        <div class="category-info">
                            <div class="category-name">Restaurants & Food</div>
                            <div class="category-count" id="count-restaurant">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="commerce">
                        <span class="category-icon">üè™</span>
                        <div class="category-info">
                            <div class="category-name">Commerces</div>
                            <div class="category-count" id="count-commerce">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="logement">
                        <span class="category-icon">üè†</span>
                        <div class="category-info">
                            <div class="category-name">Logements Saisonniers</div>
                            <div class="category-count" id="count-logement">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="taxi">
                        <span class="category-icon">üöï</span>
                        <div class="category-info">
                            <div class="category-name">Taxis & VTC</div>
                            <div class="category-count" id="count-taxi">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="notable">
                        <span class="category-icon">üëî</span>
                        <div class="category-info">
                            <div class="category-name">Notables</div>
                            <div class="category-count" id="count-notable">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="batiment">
                        <span class="category-icon">üî®</span>
                        <div class="category-info">
                            <div class="category-name">Ouvriers du B√¢timent</div>
                            <div class="category-count" id="count-batiment">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="voiture">
                        <span class="category-icon">üöó</span>
                        <div class="category-info">
                            <div class="category-name">Vente de Voitures</div>
                            <div class="category-count" id="count-voiture">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="voyage">
                        <span class="category-icon">‚úàÔ∏è</span>
                        <div class="category-info">
                            <div class="category-name">Agences de Voyage</div>
                            <div class="category-count" id="count-voyage">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="loisir">
                        <span class="category-icon">üé≠</span>
                        <div class="category-info">
                            <div class="category-name">Loisirs & Divertissement</div>
                            <div class="category-count" id="count-loisir">0 r√©sultats</div>
                        </div>
                    </div>

                    <div class="category-item" data-category="hotel">
                        <span class="category-icon">üè®</span>
                        <div class="category-info">
                            <div class="category-name">H√¥tels & H√©bergements</div>
                            <div class="category-count" id="count-hotel">0 r√©sultats</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILTRE R√âGIONS -->
            <div class="region-filter">
                <div class="region-filter-title">üó∫Ô∏è Filtrer par r√©gion</div>
                <div class="region-grid" id="regionGrid">
                    <button class="region-btn active" data-region="all">Toutes</button>
                    <button class="region-btn" data-region="dakar">Dakar</button>
                    <button class="region-btn" data-region="thies">Thi√®s</button>
                    <button class="region-btn" data-region="diourbel">Diourbel</button>
                    <button class="region-btn" data-region="fatick">Fatick</button>
                    <button class="region-btn" data-region="kaolack">Kaolack</button>
                    <button class="region-btn" data-region="kaffrine">Kaffrine</button>
                    <button class="region-btn" data-region="kolda">Kolda</button>
                    <button class="region-btn" data-region="louga">Louga</button>
                    <button class="region-btn" data-region="matam">Matam</button>
                    <button class="region-btn" data-region="saint-louis">Saint-Louis</button>
                    <button class="region-btn" data-region="sedhiou">S√©dhiou</button>
                    <button class="region-btn" data-region="tambacounda">Tambacounda</button>
                    <button class="region-btn" data-region="kedougou">K√©dougou</button>
                    <button class="region-btn" data-region="ziguinchor">Ziguinchor</button>
                </div>
            </div>
        </aside>

        <!-- CARTE PRINCIPALE -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- CONTROLS -->
            <div class="map-controls">
                <button class="control-btn" onclick="centerMap()" title="Centrer sur le S√©n√©gal">
                    üéØ
                </button>
                <button class="control-btn" onclick="locateUser()" title="Ma position">
                    üìç
                </button>
                <button class="control-btn" onclick="toggleSidebar()" title="Menu" style="display: none;" id="menuBtn">
                    ‚ò∞
                </button>
            </div>

            <!-- LEGEND -->
            <div class="map-legend">
                <div class="legend-title">üìç L√©gende des cat√©gories</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-restaurant);"></div>
                        <span>Restaurants</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-commerce);"></div>
                        <span>Commerces</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-logement);"></div>
                        <span>Logements</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-taxi);"></div>
                        <span>Taxis</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-batiment);"></div>
                        <span>B√¢timent</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-voiture);"></div>
                        <span>Voitures</span>
                    </div>
                </div>
            </div>

            <!-- LOADER -->
            <div class="loader" id="loader"></div>
        </div>
    </div>

    <!-- ================================
         MODAL D√âTAILS
    ================================ -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--primary-color);">D√©tails du professionnel</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <!-- ================================
         SCRIPTS
    ================================ -->
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ================================
        // CONFIGURATION SUPABASE
        // ================================
        const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ================================
        // VARIABLES GLOBALES
        // ================================
        let map;
        let markerCluster;
        let allProfessionals = [];
        let filteredProfessionals = [];
        let currentCategory = 'all';
        let currentRegion = 'all';
        let markers = [];

        // IC√îNES PAR CAT√âGORIE
        const categoryIcons = {
            restaurant: 'üçΩÔ∏è',
            commerce: 'üè™',
            logement: 'üè†',
            taxi: 'üöï',
            notable: 'üëî',
            batiment: 'üî®',
            voiture: 'üöó',
            voyage: '‚úàÔ∏è',
            loisir: 'üé≠',
            hotel: 'üè®'
        };

        const categoryColors = {
            restaurant: '#FF6B35',
            commerce: '#4ECDC4',
            logement: '#FFD93D',
            taxi: '#95E1D3',
            notable: '#9B59B6',
            batiment: '#E67E22',
            voiture: '#3498DB',
            voyage: '#1ABC9C',
            loisir: '#E91E63',
            hotel: '#FF9800'
        };

        // ================================
        // INITIALISATION
        // ================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ DIGIY NDIMBAL MAP - Initialisation...');
            
            initMap();
            await loadProfessionals();
            setupEventListeners();
            
            document.getElementById('loader').classList.add('hidden');
            
            console.log('‚úÖ Application pr√™te !');
        });

        // ================================
        // CARTE
        // ================================
        function initMap() {
            // Centrer sur le S√©n√©gal
            map = L.map('map').setView([14.4974, -14.4524], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | DIGIYLYFE',
                maxZoom: 19
            }).addTo(map);
            
            // Initialiser le cluster
            markerCluster = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50
            });
            map.addLayer(markerCluster);
            
            console.log('üó∫Ô∏è Carte initialis√©e');
        }

        function centerMap() {
            map.setView([14.4974, -14.4524], 7);
        }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        map.setView([latitude, longitude], 13);
                        
                        L.marker([latitude, longitude])
                            .addTo(map)
                            .bindPopup('üìç Vous √™tes ici')
                            .openPopup();
                    },
                    (error) => {
                        alert('Impossible de r√©cup√©rer votre position');
                    }
                );
            }
        }

        // ================================
        // CHARGEMENT DONN√âES
        // ================================
        async function loadProfessionals() {
            try {
                console.log('üì• Chargement des professionnels...');
                
                const { data, error } = await supabaseClient
                    .from('professionals')
                    .select('*');
                
                if (error) {
                    console.error('Erreur Supabase:', error);
                    allProfessionals = generateDemoData();
                } else {
                    allProfessionals = data || generateDemoData();
                }
                
                filteredProfessionals = [...allProfessionals];
                displayMarkers(filteredProfessionals);
                updateCounts();
                
                console.log(`‚úÖ ${allProfessionals.length} professionnels charg√©s`);
                
            } catch (error) {
                console.error('Erreur:', error);
                allProfessionals = generateDemoData();
                filteredProfessionals = [...allProfessionals];
                displayMarkers(filteredProfessionals);
                updateCounts();
            }
        }

        // ================================
        // DONN√âES D√âMO
        // ================================
        function generateDemoData() {
            const categories = ['restaurant', 'commerce', 'logement', 'taxi', 'notable', 'batiment', 'voiture', 'voyage', 'loisir', 'hotel'];
            const regions = ['dakar', 'thies', 'diourbel', 'saint-louis', 'kaolack', 'ziguinchor', 'louga', 'tambacounda', 'fatick', 'matam'];
            
            const names = {
                restaurant: ['Restaurant Teranga', 'Chez Fatou', 'Le Safoutier', 'La Lingu√®re', 'Ocean View'],
                commerce: ['Boutique √âl√©gance', 'Market Plus', 'Super Shop', 'Commerce du Coin', 'Grand March√©'],
                logement: ['Villa Vacances', 'Appartement Seaside', 'Casa S√©n√©gal', 'R√©sidence Oc√©ane', 'Maison Teranga'],
                taxi: ['Taxi Rapide Dakar', 'VTC Premium', 'Transport Express', 'Chauffeur Pro', 'Taxi Confort'],
                notable: ['Mairie', 'Chef de Village', 'Conseil R√©gional', 'Notable Local', 'Autorit√© Traditionnelle'],
                batiment: ['Ma√ßonnerie Pro', '√âlectricien Expert', 'Plomberie Service', 'Menuiserie Moderne', 'Peinture Plus'],
                voiture: ['Auto Occasion', 'Garage Premium', 'Vente Auto Express', 'Concessionnaire', 'Voitures Neuves'],
                voyage: ['Voyage D√©couverte', 'Tourisme S√©n√©gal', 'Agence Safari', 'Travel Plus', 'Excursions Pro'],
                loisir: ['Centre de Loisirs', 'Parc Attractions', 'Salle de Jeux', 'Club Sportif', 'Espace D√©tente'],
                hotel: ['H√¥tel Teranga', 'Auberge du Coin', 'R√©sidence H√¥teli√®re', 'Lodge Safari', 'Boutique Hotel']
            };
            
            const demoData = [];
            
            for (let i = 0; i < 100; i++) {
                const category = categories[i % categories.length];
                const region = regions[Math.floor(Math.random() * regions.length)];
                const nameList = names[category];
                
                demoData.push({
                    id: `demo-${i}`,
                    name: nameList[i % nameList.length] + ` ${Math.floor(i / nameList.length) + 1}`,
                    category: category,
                    region: region,
                    city: getCityForRegion(region),
                    address: `Rue ${i + 1}, Quartier ${Math.floor(Math.random() * 10) + 1}`,
                    description: getDescriptionForCategory(category),
                    phone: `+221 77 ${Math.floor(100 + Math.random() * 900)} ${Math.floor(10 + Math.random() * 90)} ${Math.floor(10 + Math.random() * 90)}`,
                    email: `contact${i}@digiylyfe.sn`,
                    website: `www.pro${i}.digiylyfe.sn`,
                    rating: (4 + Math.random()).toFixed(1),
                    latitude: getLatitudeForRegion(region),
                    longitude: getLongitudeForRegion(region),
                    hours: 'Lun-Sam 8h-20h',
                    services: getServicesForCategory(category)
                });
            }
            
            return demoData;
        }

        function getCityForRegion(region) {
            const cities = {
                dakar: ['Dakar', 'Pikine', 'Gu√©diawaye', 'Rufisque'],
                thies: ['Thi√®s', 'Mbour', 'Tivaouane', 'Joal-Fadiouth'],
                diourbel: ['Diourbel', 'Touba', 'Mback√©'],
                'saint-louis': ['Saint-Louis', 'Dagana', 'Podor'],
                kaolack: ['Kaolack', 'Nioro', 'Karang'],
                ziguinchor: ['Ziguinchor', 'Oussouye', 'Bignona'],
                louga: ['Louga', 'K√©b√©mer', 'Lingu√®re'],
                tambacounda: ['Tambacounda', 'Bakel', 'Goudiry'],
                fatick: ['Fatick', 'Foundiougne', 'Gossas'],
                matam: ['Matam', 'Kanel', 'Ran√©rou']
            };
            const cityList = cities[region] || ['Ville'];
            return cityList[Math.floor(Math.random() * cityList.length)];
        }

        function getLatitudeForRegion(region) {
            const coords = {
                dakar: 14.7167 + (Math.random() - 0.5) * 0.3,
                thies: 14.7889 + (Math.random() - 0.5) * 0.3,
                diourbel: 14.6522 + (Math.random() - 0.5) * 0.3,
                'saint-louis': 16.0179 + (Math.random() - 0.5) * 0.3,
                kaolack: 14.1472 + (Math.random() - 0.5) * 0.3,
                ziguinchor: 12.5681 + (Math.random() - 0.5) * 0.3,
                louga: 15.6133 + (Math.random() - 0.5) * 0.3,
                tambacounda: 13.7707 + (Math.random() - 0.5) * 0.3,
                fatick: 14.3333 + (Math.random() - 0.5) * 0.3,
                matam: 15.6556 + (Math.random() - 0.5) * 0.3
            };
            return coords[region] || 14.4974;
        }

        function getLongitudeForRegion(region) {
            const coords = {
                dakar: -17.4677 + (Math.random() - 0.5) * 0.3,
                thies: -16.9406 + (Math.random() - 0.5) * 0.3,
                diourbel: -16.2297 + (Math.random() - 0.5) * 0.3,
                'saint-louis': -16.5119 + (Math.random() - 0.5) * 0.3,
                kaolack: -16.0761 + (Math.random() - 0.5) * 0.3,
                ziguinchor: -16.2633 + (Math.random() - 0.5) * 0.3,
                louga: -16.2167 + (Math.random() - 0.5) * 0.3,
                tambacounda: -13.6714 + (Math.random() - 0.5) * 0.3,
                fatick: -16.4167 + (Math.random() - 0.5) * 0.3,
                matam: -13.2553 + (Math.random() - 0.5) * 0.3
            };
            return coords[region] || -14.4524;
        }

        function getDescriptionForCategory(category) {
            const descriptions = {
                restaurant: 'Restaurant traditionnel s√©n√©galais avec sp√©cialit√©s locales et internationales. Ambiance conviviale et service de qualit√©.',
                commerce: 'Commerce de proximit√© offrant une large gamme de produits. Service rapide et prix comp√©titifs.',
                logement: 'Logement saisonnier tout √©quip√©, proche des commodit√©s. Id√©al pour vacances et s√©jours professionnels.',
                taxi: 'Service de taxi professionnel et fiable. V√©hicules confortables et chauffeurs exp√©riment√©s.',
                notable: 'Autorit√© locale reconnue. Point de contact pour les d√©marches administratives et communautaires.',
                batiment: 'Ouvrier qualifi√© du b√¢timent. Travaux de qualit√© et respect des d√©lais.',
                voiture: 'Vente de v√©hicules neufs et occasions. Large choix et garantie constructeur.',
                voyage: 'Agence de voyage proposant circuits touristiques et excursions au S√©n√©gal et en Afrique.',
                loisir: 'Espace de loisirs et divertissement pour toute la famille. Activit√©s vari√©es.',
                hotel: 'H√©bergement confortable avec services complets. Accueil chaleureux √† la s√©n√©galaise.'
            };
            return descriptions[category] || 'Service professionnel de qualit√©';
        }

        function getServicesForCategory(category) {
            const services = {
                restaurant: ['Cuisine locale', 'Plats √† emporter', 'Terrasse', 'Wifi gratuit'],
                commerce: ['√âpicerie', 'Produits frais', 'Livraison', 'Paiement mobile'],
                logement: ['Wifi', 'Climatisation', 'Parking', 'S√©curit√© 24h'],
                taxi: ['A√©roport', 'Longue distance', 'Climatisation', 'Paiement mobile'],
                notable: ['Conseils', 'M√©diation', 'D√©marches', 'R√©unions'],
                batiment: ['Ma√ßonnerie', '√âlectricit√©', 'Plomberie', 'R√©novation'],
                voiture: ['Neuf', 'Occasion', 'Financement', 'Garantie'],
                voyage: ['Circuits', 'Excursions', 'R√©servations', 'Guides'],
                loisir: ['Jeux', 'Sports', 'Animations', 'Restauration'],
                hotel: ['Restaurant', 'Piscine', 'Spa', 'Wifi']
            };
            return services[category] || ['Service 1', 'Service 2'];
        }

        // ================================
        // AFFICHAGE MARKERS
        // ================================
        function displayMarkers(professionals) {
            // Nettoyer les markers existants
            markerCluster.clearLayers();
            
            professionals.forEach(pro => {
                if (pro.latitude && pro.longitude) {
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="custom-marker marker-${pro.category}">${categoryIcons[pro.category] || 'üìç'}</div>`,
                        iconSize: [35, 35],
                        iconAnchor: [17, 17]
                    });
                    
                    const marker = L.marker([pro.latitude, pro.longitude], { icon: icon });
                    
                    marker.bindPopup(createPopupContent(pro));
                    marker.on('click', () => {
                        // Optionnel : analytics ou actions suppl√©mentaires
                    });
                    
                    markerCluster.addLayer(marker);
                }
            });
            
            console.log(`üìç ${professionals.length} markers affich√©s`);
        }

        function createPopupContent(pro) {
            return `
                <div class="popup-header">
                    <div class="popup-title">${pro.name}</div>
                    <div class="popup-category">${getCategoryLabel(pro.category)}</div>
                </div>
                <div class="popup-body">
                    <div class="popup-info">
                        üìç ${pro.city}, ${getRegionLabel(pro.region)}
                    </div>
                    <div class="popup-info">
                        ‚≠ê ${pro.rating || '5.0'} | üìû ${pro.phone}
                    </div>
                    <div class="popup-description">
                        ${pro.description ? pro.description.substring(0, 100) + '...' : 'Service professionnel'}
                    </div>
                    <div class="popup-actions">
                        <button class="popup-btn popup-btn-primary" onclick='openDetailsModal("${pro.id}")'>
                            üëÅÔ∏è D√©tails
                        </button>
                        <button class="popup-btn popup-btn-secondary" onclick='contactPro("${pro.id}")'>
                            üìû Contact
                        </button>
                    </div>
                </div>
            `;
        }

        // ================================
        // FILTRAGE
        // ================================
        function filterProfessionals() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let results = [...allProfessionals];
            
            // Filtre cat√©gorie
            if (currentCategory !== 'all') {
                results = results.filter(p => p.category === currentCategory);
            }
            
            // Filtre r√©gion
            if (currentRegion !== 'all') {
                results = results.filter(p => p.region === currentRegion);
            }
            
            // Filtre recherche
            if (searchTerm) {
                results = results.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.city.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            filteredProfessionals = results;
            displayMarkers(results);
            updateCounts();
        }

        function updateCounts() {
            // Total
            document.getElementById('totalPros').textContent = allProfessionals.length;
            document.getElementById('count-all').textContent = `${filteredProfessionals.length} r√©sultats`;
            
            // Par cat√©gorie
            const categories = ['restaurant', 'commerce', 'logement', 'taxi', 'notable', 'batiment', 'voiture', 'voyage', 'loisir', 'hotel'];
            
            categories.forEach(cat => {
                const count = filteredProfessionals.filter(p => p.category === cat).length;
                const element = document.getElementById(`count-${cat}`);
                if (element) {
                    element.textContent = `${count} r√©sultats`;
                }
            });
        }

        // ================================
        // MODAL
        // ================================
        function openDetailsModal(proId) {
            const pro = allProfessionals.find(p => p.id === proId);
            if (!pro) return;
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <h2>${pro.name}</h2>
                <p style="color: var(--secondary-color); margin-bottom: 1rem;">${getCategoryLabel(pro.category)}</p>
                
                <div class="modal-info-grid">
                    <div class="info-card">
                        <div class="info-label">üìç Localisation</div>
                        <div class="info-value">${pro.city}, ${getRegionLabel(pro.region)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">‚≠ê Note</div>
                        <div class="info-value">${pro.rating || '5.0'} / 5</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üìû T√©l√©phone</div>
                        <div class="info-value">${pro.phone}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üìß Email</div>
                        <div class="info-value">${pro.email}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üåê Site web</div>
                        <div class="info-value">${pro.website || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">‚è∞ Horaires</div>
                        <div class="info-value">${pro.hours || 'N/A'}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="color: var(--text-gray); font-size: 0.85rem; margin-bottom: 0.5rem;">üìù Description</div>
                    <p style="color: var(--text-light); line-height: 1.6;">${pro.description}</p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="color: var(--text-gray); font-size: 0.85rem; margin-bottom: 0.5rem;">üè∑Ô∏è Services</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${(pro.services || []).map(s => `<span style="background: rgba(78, 205, 196, 0.2); color: var(--secondary-color); padding: 0.4rem 1rem; border-radius: 15px; font-size: 0.85rem;">${s}</span>`).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button onclick="contactPro('${pro.id}')" style="flex: 1; padding: 1rem; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                        üìû Contacter
                    </button>
                    <button onclick="viewOnMap('${pro.id}')" style="flex: 1; padding: 1rem; background: var(--secondary-color); color: var(--dark-bg); border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                        üó∫Ô∏è Voir sur la carte
                    </button>
                </div>
            `;
            
            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function contactPro(proId) {
            const pro = allProfessionals.find(p => p.id === proId);
            if (!pro) return;
            
            window.location.href = `tel:${pro.phone}`;
        }

        function viewOnMap(proId) {
            const pro = allProfessionals.find(p => p.id === proId);
            if (!pro || !pro.latitude || !pro.longitude) return;
            
            closeModal();
            map.setView([pro.latitude, pro.longitude], 15);
        }

        // ================================
        // UTILS
        // ================================
        function getCategoryLabel(category) {
            const labels = {
                restaurant: 'üçΩÔ∏è Restaurant',
                commerce: 'üè™ Commerce',
                logement: 'üè† Logement Saisonnier',
                taxi: 'üöï Taxi/VTC',
                notable: 'üëî Notable',
                batiment: 'üî® B√¢timent',
                voiture: 'üöó Vente Voiture',
                voyage: '‚úàÔ∏è Agence Voyage',
                loisir: 'üé≠ Loisir',
                hotel: 'üè® H√¥tel'
            };
            return labels[category] || category;
        }

        function getRegionLabel(region) {
            return region.charAt(0).toUpperCase() + region.slice(1);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ================================
        // EVENT LISTENERS
        // ================================
        function setupEventListeners() {
            // Recherche
            document.getElementById('searchInput').addEventListener('input', filterProfessionals);
            
            // Cat√©gories
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    currentCategory = item.dataset.category;
                    filterProfessionals();
                });
            });
            
            // R√©gions
            document.querySelectorAll('.region-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    currentRegion = btn.dataset.region;
                    filterProfessionals();
                });
            });
            
            // Modal
            window.onclick = (event) => {
                if (event.target.id === 'detailsModal') {
                    closeModal();
                }
            };
            
            // Responsive
            if (window.innerWidth <= 768) {
                document.getElementById('menuBtn').style.display = 'block';
            }
        }

        console.log('‚úÖ DIGIY NDIMBAL MAP - Syst√®me op√©rationnel ! üó∫Ô∏èüá∏üá≥');
    </script>

</body>
</html>
