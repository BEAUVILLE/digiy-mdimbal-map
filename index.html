<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGIY NDIMBAL MAP â€” Saly Multi-QG âˆ</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  /* ============================================ */
  /* ğŸ¨ THÃˆME SABLE & OR â€” DIGIYLYFE Premium */
  /* ============================================ */
  :root{
    --bg-1: #f7f3ea;
    --bg-2: #efe7d6;
    --ink: #1f2937;
    --muted: #6b7280;
    --card: #ffffff;
    --line: rgba(31,41,55,.08);
    --shadow: 0 10px 30px rgba(0,0,0,.06);

    --gold-1: #d1b464;
    --gold-2: #b89231;
    --gold-3: #f3e6b3;

    --accent-cta-1: #b38728;
    --accent-cta-2: #f9d976;

    --radius-xl: 28px;
    --radius-lg: 18px;

    /* Couleurs QG */
    --qg-centre: #f97316;
    --qg-station: #0ea5e9;
    --qg-niakhal: #10b981;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--ink);
    background: linear-gradient(180deg, var(--bg-1), #fbfaf7 40%, #ffffff 100%);
    overflow: hidden;
  }

  /* ============================================ */
  /* ğŸ“Œ HEADER DIGIY */
  /* ============================================ */
  .digiy-header {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color: #111;
    padding: 12px 16px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    position: relative;
    z-index: 1000;
  }
  .digiy-header h1 {
    font-size: clamp(16px, 4vw, 28px);
    font-weight: 900;
    letter-spacing: .5px;
    margin: 0;
    text-shadow: 0 1px 2px rgba(255,255,255,.3);
  }
  .digiy-header p {
    font-size: clamp(11px, 2.5vw, 14px);
    margin: 4px 0 0;
    opacity: .85;
    font-weight: 600;
  }

  /* ============================================ */
  /* ğŸ” BARRE DE RECHERCHE */
  /* ============================================ */
  .search-panel {
    position: absolute;
    top: 90px;
    left: 20px;
    z-index: 999;
    background: rgba(255,255,255,.96);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    width: 320px;
    max-width: calc(100vw - 40px);
    transition: all .3s ease;
  }

  .search-toggle {
    display: none;
    position: absolute;
    top: 95px;
    left: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color: #111;
    border: none;
    padding: 12px 16px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
    cursor: pointer;
    transition: all .2s;
  }
  .search-toggle:active {
    transform: scale(0.95);
  }

  .search-panel input {
    width: 100%;
    padding: 12px 14px;
    font-size: 14px;
    border: 1px solid var(--line);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all .2s ease;
  }
  .search-panel input:focus {
    outline: none;
    border-color: var(--gold-1);
    box-shadow: 0 0 0 3px rgba(209,180,100,.25);
  }

  .search-panel select {
    width: 100%;
    padding: 10px 12px;
    font-size: 13px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: white;
    margin-bottom: 12px;
    cursor: pointer;
  }

  .qg-filters {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .qg-filter {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all .2s;
    border: 2px solid transparent;
  }

  .qg-filter.all {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color: #111;
  }
  .qg-filter.all.active {
    border-color: #111;
  }

  .qg-filter.centre {
    background: var(--qg-centre);
    color: white;
  }
  .qg-filter.centre.active {
    border-color: #7c2d12;
  }

  .qg-filter.station {
    background: var(--qg-station);
    color: white;
  }
  .qg-filter.station.active {
    border-color: #075985;
  }

  .qg-filter.niakhal {
    background: var(--qg-niakhal);
    color: white;
  }
  .qg-filter.niakhal.active {
    border-color: #065f46;
  }

  .qg-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,.2);
  }

  .partner-count {
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    margin-top: 8px;
  }

  .qg-stats {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    font-size: 11px;
    font-weight: 700;
  }

  .qg-stat {
    padding: 4px 8px;
    border-radius: 8px;
    color: white;
  }
  .qg-stat.centre { background: var(--qg-centre); }
  .qg-stat.station { background: var(--qg-station); }
  .qg-stat.niakhal { background: var(--qg-niakhal); }

  .partner-list {
    max-height: 250px;
    overflow-y: auto;
    margin-top: 12px;
    border-top: 1px solid var(--line);
    padding-top: 12px;
  }

  .partner-item {
    padding: 8px 10px;
    margin: 4px 0;
    background: var(--card);
    border: 1px solid var(--line);
    border-left: 4px solid var(--gold-1);
    border-radius: 10px;
    cursor: pointer;
    transition: all .2s ease;
    font-size: 13px;
  }

  .partner-item.qg-centre {
    border-left-color: var(--qg-centre);
  }
  .partner-item.qg-station {
    border-left-color: var(--qg-station);
  }
  .partner-item.qg-niakhal {
    border-left-color: var(--qg-niakhal);
  }

  .partner-item:hover {
    background: linear-gradient(135deg, var(--gold-3), #fde68a);
    border-color: var(--gold-1);
    transform: translateX(4px);
  }
  .partner-item strong {
    display: block;
    font-size: 14px;
    margin-bottom: 2px;
    color: var(--ink);
  }
  .partner-item span {
    color: var(--muted);
    font-size: 12px;
  }
  .partner-item .qg-badge {
    display: inline-block;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-top: 4px;
    color: white;
    font-weight: 700;
  }

  /* ============================================ */
  /* ğŸ—ºï¸ CARTE */
  /* ============================================ */
  #map {
    position: absolute;
    top: 80px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* Marker personnalisÃ© */
  .digiy-marker {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    width: 36px;
    height: 36px;
    transform: rotate(-45deg);
    box-shadow: 0 4px 12px rgba(0,0,0,.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .digiy-marker span {
    transform: rotate(45deg);
  }

  /* Markers QG colorÃ©s */
  .digiy-marker.qg-centre {
    background: var(--qg-centre);
  }
  .digiy-marker.qg-station {
    background: var(--qg-station);
  }
  .digiy-marker.qg-niakhal {
    background: var(--qg-niakhal);
  }

  /* Popup personnalisÃ©e */
  .leaflet-popup-content-wrapper {
    border-radius: var(--radius-lg);
    padding: 0;
    overflow: hidden;
    box-shadow: 0 12px 32px rgba(0,0,0,.2);
  }
  .leaflet-popup-content {
    margin: 0;
    padding: 16px;
    min-width: 280px;
  }
  .popup-header {
    font-size: 16px;
    font-weight: 900;
    margin-bottom: 8px;
    color: var(--ink);
  }
  .popup-meta {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .popup-qg-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 800;
    color: white;
    margin-bottom: 8px;
  }
  .popup-qg-badge.centre { background: var(--qg-centre); }
  .popup-qg-badge.station { background: var(--qg-station); }
  .popup-qg-badge.niakhal { background: var(--qg-niakhal); }
  .popup-desc {
    font-size: 13px;
    margin-bottom: 12px;
    color: #4b5563;
  }
  .popup-cta {
    display: flex;
    gap: 8px;
  }
  .popup-btn {
    flex: 1;
    padding: 10px;
    text-align: center;
    text-decoration: none;
    font-weight: 800;
    font-size: 12px;
    border-radius: 10px;
    transition: all .2s ease;
  }
  .popup-btn.whatsapp {
    background: linear-gradient(135deg, #35d07f, #0d9f54);
    color: white;
  }
  .popup-btn.view {
    background: linear-gradient(135deg, var(--accent-cta-2), var(--accent-cta-1));
    color: #111;
  }
  .popup-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }

  /* ============================================ */
  /* ğŸ“± MOBILE - RESPONSIVE */
  /* ============================================ */
  @media (max-width: 768px) {
    .digiy-header {
      padding: 10px 12px;
    }
    .digiy-header h1 {
      font-size: 16px;
    }
    .digiy-header p {
      font-size: 11px;
    }

    .search-panel {
      top: 70px;
      left: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: none;
      padding: 14px;
      max-height: calc(100vh - 150px);
      overflow-y: auto;
      transform: translateY(-120%);
      opacity: 0;
      pointer-events: none;
    }

    .search-panel.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }

    .search-toggle {
      display: block;
      top: 75px;
      left: 10px;
    }

    .partner-list {
      max-height: 200px;
    }

    #map {
      top: 70px;
    }

    .leaflet-popup-content {
      min-width: 240px;
      padding: 14px;
    }

    .qg-filters {
      gap: 4px;
    }

    .qg-filter {
      font-size: 11px;
      padding: 5px 10px;
    }
  }

  @media (max-width: 480px) {
    .search-toggle {
      font-size: 13px;
      padding: 10px 14px;
    }

    .partner-list {
      max-height: 150px;
    }

    .popup-btn {
      font-size: 11px;
      padding: 8px;
    }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="digiy-header">
  <h1>ğŸ—ºï¸ DIGIY NDIMBAL MAP â€” Saly Multi-QG âˆ</h1>
  <p>ğŸ“ L'entraide digitale du SÃ©nÃ©gal â€¢ Pierre par pierre</p>
</header>

<!-- BOUTON TOGGLE MOBILE -->
<button class="search-toggle" id="searchToggle" onclick="toggleSearch()">
  ğŸ” Rechercher
</button>

<!-- PANNEAU DE RECHERCHE -->
<div class="search-panel" id="searchPanel">
  <input type="search" id="searchInput" placeholder="ğŸ” Rechercher (chauffeur, villa, plombier...)" />
  
  <select id="categoryFilter">
    <option value="all">ğŸŒŸ Toutes catÃ©gories</option>
    <option value="hebergement">ğŸ¨ HÃ©bergement</option>
    <option value="market">ğŸ›’ Market & Style</option>
    <option value="driver">ğŸš— Driver</option>
    <option value="construction">ğŸ—ï¸ BÃ¢tisseur</option>
    <option value="explore">ğŸŒ´ Explore</option>
  </select>

  <!-- FILTRES QG -->
  <div class="qg-filters">
    <div class="qg-filter all active" data-qg="all" onclick="filterByQG('all')">
      âˆ Tous QG
    </div>
    <div class="qg-filter centre" data-qg="centre" onclick="filterByQG('centre')">
      ğŸª Centre
    </div>
    <div class="qg-filter station" data-qg="station" onclick="filterByQG('station')">
      ğŸ–ï¸ Station
    </div>
    <div class="qg-filter niakhal" data-qg="niakhal" onclick="filterByQG('niakhal')">
      ğŸ¡ Niakhal
    </div>
  </div>

  <div class="partner-count" id="partnerCount">9 partenaires â€¢ 3 QG Saly</div>

  <!-- STATS QG -->
  <div class="qg-stats" id="qgStats"></div>

  <div class="partner-list" id="partnerList"></div>
</div>

<!-- CARTE -->
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ============================================
// ğŸ” TOGGLE SEARCH PANEL (MOBILE)
// ============================================
function toggleSearch() {
  const panel = document.getElementById('searchPanel');
  const button = document.getElementById('searchToggle');
  
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
    button.textContent = 'ğŸ” Rechercher';
  } else {
    panel.classList.add('open');
    button.textContent = 'âœ• Fermer';
  }
}

// ============================================
// ğŸ—ºï¸ DÃ‰FINITION DES QG SALY
// ============================================
const QG_SALY = {
  centre: {
    id: 'centre',
    name: 'QG Saly Centre',
    hub: 'Astou Boutique',
    description: 'Hub textile, market & artisanat',
    lat: 14.4574,
    lng: -16.9984,
    color: '#f97316',
    emoji: 'ğŸª'
  },
  station: {
    id: 'station',
    name: 'QG Saly Station',
    hub: 'Chez Baptiste',
    description: 'Hub hÃ©bergement, tourisme & loisirs',
    lat: 14.4520,
    lng: -16.9920,
    color: '#0ea5e9',
    emoji: 'ğŸ–ï¸'
  },
  niakhal: {
    id: 'niakhal',
    name: 'QG Niakh Niakhal',
    hub: 'Garage Lamine',
    description: 'Hub services, construction & transport',
    lat: 14.4610,
    lng: -17.0050,
    color: '#10b981',
    emoji: 'ğŸ¡'
  }
};

// ============================================
// ğŸ“Š BASE DE DONNÃ‰ES PARTENAIRES AVEC QG
// ============================================
const partners = [
  // QG CENTRE (Astou - Market/Textile)
  {
    id: "astou",
    name: "ğŸ§µ Astou â€” Linge de maison",
    category: "market",
    description: "Linge de maison & couture sur mesure â€¢ Saly",
    price: "Promo locale",
    whatsapp: "https://wa.me/221778765785?text=Salam%20Astou%20je%20viens%20de%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-astou/",
    icon: "ğŸ§µ",
    keywords: "linge maison couture serviette torchon drap saly",
    qg: 'centre',
    isHub: true
  },
  {
    id: "tonton-elhadji",
    name: "ğŸ‘œ Tonton Elhadji",
    category: "market",
    description: "SÃ©lection sacs & montres â€” qualitÃ© â€¢ Saly",
    price: "Stock limitÃ©",
    whatsapp: "https://wa.me/221778329612?text=Salam%20Tonton%20DIGIYLYFE%20ğŸ‘œ",
    link: "https://digiylyfe.com/partenaire-tonton-elhadji/",
    icon: "ğŸ‘œ",
    keywords: "sacs montres accessoires maroquinerie saly",
    qg: 'centre'
  },
  {
    id: "michel",
    name: "âœ‚ï¸ Michel â€” Styliste",
    category: "market",
    description: "Robes personnalisÃ©es â€¢ Saly â€“ ThiÃ¨s",
    price: "Sur mesure",
    whatsapp: "https://wa.me/221783718492?text=Salam%20Michel%20DIGIYLYFE%20je%20veux%20une%20crÃ©ation%20ğŸ‘—",
    link: "https://digiylyfe.com/page-partenaire-michel/",
    icon: "âœ‚ï¸",
    keywords: "styliste couture robes personnalisees vetements saly",
    qg: 'centre'
  },

  // QG STATION (Baptiste - HÃ©bergement/Tourisme)
  {
    id: "baptiste-saly",
    name: "ğŸï¸ Chez Baptiste â€” Saly",
    category: "hebergement",
    description: "Appartement meublÃ© â€” 2 chambres, salon, cuisine",
    price: "30 000 FCFA / nuit",
    whatsapp: "https://wa.me/221771342889?text=Salam%20je%20veux%20rÃ©server%20Chez%20Baptiste%20Saly%20ğŸ™",
    link: "https://digiylyfe.com/partenaires-chez-baptiste/",
    icon: "ğŸï¸",
    keywords: "saly appartement meuble 2 chambres cuisine hebergement",
    qg: 'station',
    isHub: true
  },
  {
    id: "daouda",
    name: "ğŸŒ´ Daouda Explore",
    category: "explore",
    description: "Guide local â€” circuits authentiques â€¢ Saly",
    price: "Circuits sur mesure",
    whatsapp: "https://wa.me/221771342889?text=Salam%20Daouda%20DIGIYLYFE%20circuit%20ğŸŒ´",
    link: "https://digiylyfe.com/partenaires-daouda/",
    icon: "ğŸŒ´",
    keywords: "guide touristique circuit marche saly",
    qg: 'station'
  },

  // QG NIAKH NIAKHAL (Lamine - Services/Construction)
  {
    id: "lamine",
    name: "ğŸš— Lamine â€” Chauffeur",
    category: "driver",
    description: "Transferts AIBD et circuits â€¢ Saly â€“ ThiÃ¨s â€“ Dakar",
    price: "Sur demande",
    whatsapp: "https://wa.me/221784413680?text=Salam%20Lamine%20DIGIYLYFE%20(j'aimerais%20rÃ©server%20un%20trajet)",
    link: "https://digiylyfe.com/partenaires-lamine/",
    icon: "ğŸš—",
    keywords: "chauffeur taxi transport aibd dakar saly",
    qg: 'niakhal',
    isHub: true
  },
  {
    id: "zal",
    name: "âš¡ Zal & Kourant â€” Ã‰lectriciens",
    category: "construction",
    description: "Ã‰lectricitÃ© maison & bÃ¢timent â€¢ Saly",
    price: "Devis rapide",
    whatsapp: "https://wa.me/221772084781?text=Salam%20Zal%20je%20viens%20de%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-zal-kourant/",
    icon: "âš¡",
    keywords: "electricien electricite maison depannage saly",
    qg: 'niakhal'
  },
  {
    id: "helage",
    name: "ğŸ’§ Helage â€” Plombier",
    category: "construction",
    description: "Plomberie multi-services â€¢ Saly â€“ Petite CÃ´te",
    price: "Sur demande / devis",
    whatsapp: "https://wa.me/221774513523?text=Salam%20Helage%2C%20je%20viens%20de%20DIGIYLYFE",
    link: "tel:+221774513523",
    icon: "ğŸ’§",
    keywords: "plombier plomberie depannage fuite robinet saly",
    qg: 'niakhal'
  },
  {
    id: "mbaye",
    name: "ğŸ‘· Mbaye Diouf â€” BÃ¢tisseur",
    category: "construction",
    description: "Villas modernes, piscines â€¢ Dakar â€“ ThiÃ¨s â€“ Petite CÃ´te",
    price: "Visite chantier",
    whatsapp: "https://wa.me/221776427113?text=Salam%20Mbaye%20je%20veux%20parler%20d%E2%80%99un%20projet%20ğŸ—ï¸%20(DIGIYLYFE)",
    link: "https://digiylyfe.com/partenaires-mbaye/",
    icon: "ğŸ‘·",
    keywords: "batisseur villa piscine travaux construction saly",
    qg: 'niakhal'
  }
];

// Variables globales
let map;
let markers;
let allMarkers = [];
let currentQGFilter = 'all';

// ============================================
// â³ INITIALISATION APRÃˆS CHARGEMENT
// ============================================
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
})();

function initAll() {
  console.log('ğŸ¦… Initialisation DIGIY NDIMBAL MAP Multi-QG...');
  
  if (typeof L === 'undefined') {
    console.error('âŒ Leaflet non chargÃ©, nouvelle tentative...');
    setTimeout(initAll, 100);
    return;
  }
  
  initMap();
  initSearch();
  initMobileHandlers();
  updateQGStats();
}

// ============================================
// ğŸ—ºï¸ INITIALISATION CARTE
// ============================================
function initMap() {
  // Centre de la carte (entre les 3 QG)
  const centerLat = (QG_SALY.centre.lat + QG_SALY.station.lat + QG_SALY.niakhal.lat) / 3;
  const centerLng = (QG_SALY.centre.lng + QG_SALY.station.lng + QG_SALY.niakhal.lng) / 3;

  map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: true
  }).setView([centerLat, centerLng], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap | DIGIYLYFE âˆ',
    maxZoom: 19
  }).addTo(map);

  markers = L.markerClusterGroup({
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
  });

  // Ajouter les partenaires par QG
  allMarkers = [];
  partners.forEach(function(partner) {
    const qgData = QG_SALY[partner.qg];
    const marker = L.marker([qgData.lat, qgData.lng], {
      icon: createCustomIcon(partner.icon, partner.qg)
    }).bindPopup(createPopup(partner));
    
    marker.partnerData = partner;
    allMarkers.push(marker);
    markers.addLayer(marker);
  });

  map.addLayer(markers);

  // Ajouter les markers QG
  Object.keys(QG_SALY).forEach(function(qgKey) {
    const qg = QG_SALY[qgKey];
    const qgPartners = partners.filter(function(p) { return p.qg === qgKey; });
    
    const qgMarker = L.marker([qg.lat, qg.lng], {
      icon: L.divIcon({
        className: 'custom-marker',
        html: '<div class="digiy-marker qg-' + qgKey + '" style="width:52px;height:52px;border-width:4px;"><span style="font-size:28px;">âˆ</span></div>',
        iconSize: [52, 52],
        iconAnchor: [26, 52],
        popupAnchor: [0, -52]
      })
    }).bindPopup(createQGPopup(qg, qgPartners)).addTo(map);
  });

  console.log('âœ… Carte initialisÃ©e : ' + partners.length + ' partenaires, 3 QG');
}

function createCustomIcon(icon, qg) {
  return L.divIcon({
    className: 'custom-marker',
    html: '<div class="digiy-marker qg-' + qg + '"><span>' + icon + '</span></div>',
    iconSize: [36, 36],
    iconAnchor: [18, 36],
    popupAnchor: [0, -36]
  });
}

function createPopup(partner) {
  const qgData = QG_SALY[partner.qg];
  const hubBadge = partner.isHub ? '<span style="background:#facc15;color:#111;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:800;margin-left:6px;">HUB</span>' : '';
  
  return `
    <div class="popup-header">${partner.name} ${hubBadge}</div>
    <div class="popup-qg-badge ${partner.qg}">${qgData.emoji} ${qgData.name}</div>
    <div class="popup-meta">ğŸ“ ${partner.category.toUpperCase()}</div>
    <div class="popup-desc">${partner.description}</div>
    ${partner.price ? '<div class="popup-meta">ğŸ’° ' + partner.price + '</div>' : ''}
    <div class="popup-cta">
      ${partner.whatsapp ? '<a href="' + partner.whatsapp + '" target="_blank" class="popup-btn whatsapp">ğŸ’¬ WhatsApp</a>' : ''}
      <a href="${partner.link}" target="_blank" class="popup-btn view">ğŸ” Voir</a>
    </div>
  `;
}

function createQGPopup(qg, qgPartners) {
  const hub = qgPartners.find(function(p) { return p.isHub; });
  
  return `
    <div class="popup-header">${qg.emoji} ${qg.name}</div>
    <div class="popup-meta">ğŸ“ ${qg.description}</div>
    ${hub ? '<div class="popup-desc"><strong>Hub:</strong> ' + hub.name + '</div>' : ''}
    <div class="popup-meta">ğŸ‘¥ ${qgPartners.length} partenaire${qgPartners.length > 1 ? 's' : ''}</div>
    <div style="margin-top:12px;font-size:12px;color:#6b7280;">
      ${qgPartners.map(function(p) { return p.icon + ' ' + p.name.split('â€”')[0]; }).join('<br>')}
    </div>
    <div class="popup-cta" style="margin-top:12px;">
      <a href="https://digiylyfe.com" target="_blank" class="popup-btn view">ğŸŒ DIGIYLYFE</a>
    </div>
  `;
}

// ============================================
// ğŸ” RECHERCHE & FILTRES
// ============================================
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');

  function normalizeText(text) {
    return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function updateDisplay() {
    const searchTerm = normalizeText(searchInput.value.trim());
    const category = categoryFilter.value;
    
    const filtered = partners.filter(function(p) {
      const matchQG = currentQGFilter === 'all' || p.qg === currentQGFilter;
      const matchCategory = category === 'all' || p.category === category;
      const matchSearch = !searchTerm || 
        normalizeText(p.name + ' ' + p.description + ' ' + p.keywords).includes(searchTerm);
      return matchQG && matchCategory && matchSearch;
    });

    const partnerCount = document.getElementById('partnerCount');
    partnerCount.textContent = filtered.length + ' partenaire' + (filtered.length > 1 ? 's' : '') + ' â€¢ 3 QG Saly';

    const partnerList = document.getElementById('partnerList');
    partnerList.innerHTML = filtered.map(function(p) {
      const qgData = QG_SALY[p.qg];
      return '<div class="partner-item qg-' + p.qg + '" onclick="focusPartner(\'' + p.id + '\')">' +
        '<strong>' + p.name + '</strong>' +
        '<span>' + p.description + '</span>' +
        '<div class="qg-badge" style="background:' + qgData.color + '">' + qgData.emoji + ' ' + qgData.name + '</div>' +
        '</div>';
    }).join('');

    if (markers) {
      markers.clearLayers();
      allMarkers.forEach(function(marker) {
        if (filtered.find(function(p) { return p.id === marker.partnerData.id; })) {
          markers.addLayer(marker);
        }
      });
    }
  }

  searchInput.addEventListener('input', updateDisplay);
  categoryFilter.addEventListener('change', updateDisplay);

  updateDisplay();
}

// Filtre par QG
window.filterByQG = function(qg) {
  currentQGFilter = qg;
  
  document.querySelectorAll('.qg-filter').forEach(function(el) {
    el.classList.remove('active');
  });
  document.querySelector('.qg-filter[data-qg="' + qg + '"]').classList.add('active');
  
  const searchInput = document.getElementById('searchInput');
  searchInput.dispatchEvent(new Event('input'));
  
  if (qg !== 'all') {
    const qgData = QG_SALY[qg];
    map.setView([qgData.lat, qgData.lng], 16);
  }
};

// Focus sur un partenaire
window.focusPartner = function(partnerId) {
  const marker = allMarkers.find(function(m) { return m.partnerData.id === partnerId; });
  if (marker) {
    const qgData = QG_SALY[marker.partnerData.qg];
    map.setView([qgData.lat, qgData.lng], 17);
    marker.openPopup();
    
    if (window.innerWidth <= 768) {
      const panel = document.getElementById('searchPanel');
      const button = document.getElementById('searchToggle');
      panel.classList.remove('open');
      button.textContent = 'ğŸ” Rechercher';
    }
  }
};

// Stats QG
function updateQGStats() {
  const stats = {};
  partners.forEach(function(p) {
    stats[p.qg] = (stats[p.qg] || 0) + 1;
  });
  
  const qgStats = document.getElementById('qgStats');
  qgStats.innerHTML = Object.keys(stats).map(function(qgKey) {
    return '<div class="qg-stat ' + qgKey + '">' + QG_SALY[qgKey].emoji + ' ' + stats[qgKey] + '</div>';
  }).join('');
}

// ============================================
// ğŸ“± HANDLERS MOBILE
// ============================================
function initMobileHandlers() {
  if (window.innerWidth <= 768) {
    document.getElementById('map').addEventListener('click', function() {
      const panel = document.getElementById('searchPanel');
      const button = document.getElementById('searchToggle');
      if (panel.classList.contains('open')) {
        panel.classList.remove('open');
        button.textContent = 'ğŸ” Rechercher';
      }
    });
  }
}

console.log('ğŸ¦… DIGIY NDIMBAL MAP Multi-QG â€” PrÃªt ! Pierre par pierre âˆ');
</script>

</body>
</html>
