<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGIY NDIMBAL MAP ‚Äî Saly QG ‚àû</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  /* ============================================ */
  /* üé® TH√àME SABLE & OR ‚Äî DIGIYLYFE Premium */
  /* ============================================ */
  :root{
    --bg-1: #f7f3ea;
    --bg-2: #efe7d6;
    --ink: #1f2937;
    --muted: #6b7280;
    --card: #ffffff;
    --line: rgba(31,41,55,.08);
    --shadow: 0 10px 30px rgba(0,0,0,.06);

    --gold-1: #d1b464;
    --gold-2: #b89231;
    --gold-3: #f3e6b3;

    --accent-cta-1: #b38728;
    --accent-cta-2: #f9d976;

    --radius-xl: 28px;
    --radius-lg: 18px;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--ink);
    background: linear-gradient(180deg, var(--bg-1), #fbfaf7 40%, #ffffff 100%);
    overflow: hidden;
  }

  /* ============================================ */
  /* üìå HEADER DIGIY */
  /* ============================================ */
  .digiy-header {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color: #111;
    padding: 12px 16px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    position: relative;
    z-index: 1000;
  }
  .digiy-header h1 {
    font-size: clamp(16px, 4vw, 28px);
    font-weight: 900;
    letter-spacing: .5px;
    margin: 0;
    text-shadow: 0 1px 2px rgba(255,255,255,.3);
  }
  .digiy-header p {
    font-size: clamp(11px, 2.5vw, 14px);
    margin: 4px 0 0;
    opacity: .85;
    font-weight: 600;
  }

  /* ============================================ */
  /* üîç BARRE DE RECHERCHE */
  /* ============================================ */
  .search-panel {
    position: absolute;
    top: 90px;
    left: 20px;
    z-index: 999;
    background: rgba(255,255,255,.96);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    width: 320px;
    max-width: calc(100vw - 40px);
    transition: all .3s ease;
  }

  /* Bouton toggle mobile */
  .search-toggle {
    display: none;
    position: absolute;
    top: 95px;
    left: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color: #111;
    border: none;
    padding: 12px 16px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
    cursor: pointer;
    transition: all .2s;
  }
  .search-toggle:active {
    transform: scale(0.95);
  }

  .search-panel input {
    width: 100%;
    padding: 12px 14px;
    font-size: 14px;
    border: 1px solid var(--line);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all .2s ease;
  }
  .search-panel input:focus {
    outline: none;
    border-color: var(--gold-1);
    box-shadow: 0 0 0 3px rgba(209,180,100,.25);
  }

  .search-panel select {
    width: 100%;
    padding: 10px 12px;
    font-size: 13px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: white;
    margin-bottom: 12px;
    cursor: pointer;
  }

  .partner-count {
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    margin-top: 8px;
  }

  .partner-list {
    max-height: 250px;
    overflow-y: auto;
    margin-top: 12px;
    border-top: 1px solid var(--line);
    padding-top: 12px;
  }

  .partner-item {
    padding: 8px 10px;
    margin: 4px 0;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 10px;
    cursor: pointer;
    transition: all .2s ease;
    font-size: 13px;
  }
  .partner-item:hover {
    background: linear-gradient(135deg, var(--gold-3), #fde68a);
    border-color: var(--gold-1);
    transform: translateX(4px);
  }
  .partner-item strong {
    display: block;
    font-size: 14px;
    margin-bottom: 2px;
    color: var(--ink);
  }
  .partner-item span {
    color: var(--muted);
    font-size: 12px;
  }

  /* ============================================ */
  /* üó∫Ô∏è CARTE */
  /* ============================================ */
  #map {
    position: absolute;
    top: 80px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* Marker personnalis√© */
  .digiy-marker {
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    width: 36px;
    height: 36px;
    transform: rotate(-45deg);
    box-shadow: 0 4px 12px rgba(0,0,0,.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .digiy-marker span {
    transform: rotate(45deg);
  }

  /* Popup personnalis√©e */
  .leaflet-popup-content-wrapper {
    border-radius: var(--radius-lg);
    padding: 0;
    overflow: hidden;
    box-shadow: 0 12px 32px rgba(0,0,0,.2);
  }
  .leaflet-popup-content {
    margin: 0;
    padding: 16px;
    min-width: 280px;
  }
  .popup-header {
    font-size: 16px;
    font-weight: 900;
    margin-bottom: 8px;
    color: var(--ink);
  }
  .popup-meta {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .popup-desc {
    font-size: 13px;
    margin-bottom: 12px;
    color: #4b5563;
  }
  .popup-cta {
    display: flex;
    gap: 8px;
  }
  .popup-btn {
    flex: 1;
    padding: 10px;
    text-align: center;
    text-decoration: none;
    font-weight: 800;
    font-size: 12px;
    border-radius: 10px;
    transition: all .2s ease;
  }
  .popup-btn.whatsapp {
    background: linear-gradient(135deg, #35d07f, #0d9f54);
    color: white;
  }
  .popup-btn.view {
    background: linear-gradient(135deg, var(--accent-cta-2), var(--accent-cta-1));
    color: #111;
  }
  .popup-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }

  /* ============================================ */
  /* üì± MOBILE - RESPONSIVE FIX */
  /* ============================================ */
  @media (max-width: 768px) {
    .digiy-header {
      padding: 10px 12px;
    }
    .digiy-header h1 {
      font-size: 16px;
    }
    .digiy-header p {
      font-size: 11px;
    }

    /* IMPORTANT : Panneau cach√© par d√©faut sur mobile */
    .search-panel {
      top: 70px;
      left: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: none;
      padding: 14px;
      max-height: calc(100vh - 150px);
      overflow-y: auto;
      transform: translateY(-120%);
      opacity: 0;
      pointer-events: none;
    }

    /* Panneau visible quand ouvert */
    .search-panel.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }

    /* Bouton toggle visible sur mobile */
    .search-toggle {
      display: block;
      top: 75px;
      left: 10px;
    }

    .partner-list {
      max-height: 200px;
    }

    #map {
      top: 70px;
    }

    /* Ajuster les popups sur mobile */
    .leaflet-popup-content {
      min-width: 240px;
      padding: 14px;
    }
  }

  /* Tr√®s petits √©crans */
  @media (max-width: 480px) {
    .search-toggle {
      font-size: 13px;
      padding: 10px 14px;
    }

    .partner-list {
      max-height: 150px;
    }

    .popup-btn {
      font-size: 11px;
      padding: 8px;
    }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="digiy-header">
  <h1>üó∫Ô∏è DIGIY NDIMBAL MAP ‚Äî Saly QG ‚àû</h1>
  <p>üìç L'entraide digitale du S√©n√©gal ‚Ä¢ Pierre par pierre</p>
</header>

<!-- BOUTON TOGGLE MOBILE -->
<button class="search-toggle" id="searchToggle" onclick="toggleSearch()">
  üîç Rechercher
</button>

<!-- PANNEAU DE RECHERCHE -->
<div class="search-panel" id="searchPanel">
  <input type="search" id="searchInput" placeholder="üîç Rechercher (chauffeur, villa, plombier...)" />
  
  <select id="categoryFilter">
    <option value="all">üåü Toutes cat√©gories</option>
    <option value="hebergement">üè® H√©bergement</option>
    <option value="market">üõí Market & Style</option>
    <option value="driver">üöó Driver</option>
    <option value="construction">üèóÔ∏è B√¢tisseur</option>
    <option value="explore">üå¥ Explore</option>
  </select>

  <div class="partner-count" id="partnerCount">9 partenaires ‚Ä¢ QG Saly</div>

  <div class="partner-list" id="partnerList"></div>
</div>

<!-- CARTE -->
<div id="map"></div>

<!-- Leaflet JS - CHARGEMENT DANS L'ORDRE -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ============================================
// üîç TOGGLE SEARCH PANEL (MOBILE)
// ============================================
function toggleSearch() {
  const panel = document.getElementById('searchPanel');
  const button = document.getElementById('searchToggle');
  
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
    button.textContent = 'üîç Rechercher';
  } else {
    panel.classList.add('open');
    button.textContent = '‚úï Fermer';
  }
}

// ============================================
// üó∫Ô∏è DONN√âES & INITIALISATION
// ============================================

// Coordonn√©es QG Saly (Astou Boutique)
const QG_SALY = {
  lat: 14.4574,
  lng: -16.9984,
  name: "QG DIGIYLYFE Saly"
};

// Base de donn√©es partenaires Saly
const partners = [
  {
    id: "baptiste-saly",
    name: "üèùÔ∏è Chez Baptiste ‚Äî Saly",
    category: "hebergement",
    description: "Appartement meubl√© ‚Äî 2 chambres, salon, cuisine",
    price: "30 000 FCFA / nuit",
    whatsapp: "https://wa.me/221771342889?text=Salam%20je%20veux%20r√©server%20Chez%20Baptiste%20Saly%20üôè",
    link: "https://digiylyfe.com/partenaires-chez-baptiste/",
    icon: "üèùÔ∏è",
    keywords: "saly appartement meuble 2 chambres cuisine hebergement"
  },
  {
    id: "lamine",
    name: "üöó Lamine ‚Äî Chauffeur",
    category: "driver",
    description: "Transferts AIBD et circuits ‚Ä¢ Saly ‚Äì Thi√®s ‚Äì Dakar",
    price: "Sur demande",
    whatsapp: "https://wa.me/221784413680?text=Salam%20Lamine%20DIGIYLYFE%20(j'aimerais%20r√©server%20un%20trajet)",
    link: "https://digiylyfe.com/partenaires-lamine/",
    icon: "üöó",
    keywords: "chauffeur taxi transport aibd dakar saly"
  },
  {
    id: "michel",
    name: "‚úÇÔ∏è Michel ‚Äî Styliste",
    category: "market",
    description: "Robes personnalis√©es ‚Ä¢ Saly ‚Äì Thi√®s",
    price: "Sur mesure",
    whatsapp: "https://wa.me/221783718492?text=Salam%20Michel%20DIGIYLYFE%20je%20veux%20une%20cr√©ation%20üëó",
    link: "https://digiylyfe.com/page-partenaire-michel/",
    icon: "‚úÇÔ∏è",
    keywords: "styliste couture robes personnalisees vetements saly"
  },
  {
    id: "zal",
    name: "‚ö° Zal & Kourant ‚Äî √âlectriciens",
    category: "construction",
    description: "√âlectricit√© maison & b√¢timent ‚Ä¢ Saly",
    price: "Devis rapide",
    whatsapp: "https://wa.me/221772084781?text=Salam%20Zal%20je%20viens%20de%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-zal-kourant/",
    icon: "‚ö°",
    keywords: "electricien electricite maison depannage saly"
  },
  {
    id: "helage",
    name: "üíß Helage ‚Äî Plombier",
    category: "construction",
    description: "Plomberie multi-services ‚Ä¢ Saly ‚Äì Petite C√¥te",
    price: "Sur demande / devis",
    whatsapp: "https://wa.me/221774513523?text=Salam%20Helage%2C%20je%20viens%20de%20DIGIYLYFE",
    link: "tel:+221774513523",
    icon: "üíß",
    keywords: "plombier plomberie depannage fuite robinet saly"
  },
  {
    id: "astou",
    name: "üßµ Astou ‚Äî Linge de maison",
    category: "market",
    description: "Linge de maison & couture sur mesure ‚Ä¢ Saly",
    price: "Promo locale",
    whatsapp: "https://wa.me/221778765785?text=Salam%20Astou%20je%20viens%20de%20DIGIYLYFE",
    link: "https://digiylyfe.com/partenaires-astou/",
    icon: "üßµ",
    keywords: "linge maison couture serviette torchon drap saly"
  },
  {
    id: "daouda",
    name: "üå¥ Daouda Explore",
    category: "explore",
    description: "Guide local ‚Äî circuits authentiques ‚Ä¢ Saly",
    price: "Circuits sur mesure",
    whatsapp: "https://wa.me/221771342889?text=Salam%20Daouda%20DIGIYLYFE%20circuit%20üå¥",
    link: "https://digiylyfe.com/partenaires-daouda/",
    icon: "üå¥",
    keywords: "guide touristique circuit marche saly"
  },
  {
    id: "tonton-elhadji",
    name: "üëú Tonton Elhadji",
    category: "market",
    description: "S√©lection sacs & montres ‚Äî qualit√© ‚Ä¢ Saly",
    price: "Stock limit√©",
    whatsapp: "https://wa.me/221778329612?text=Salam%20Tonton%20DIGIYLYFE%20üëú",
    link: "https://digiylyfe.com/partenaire-tonton-elhadji/",
    icon: "üëú",
    keywords: "sacs montres accessoires maroquinerie saly"
  },
  {
    id: "mbaye",
    name: "üë∑ Mbaye Diouf ‚Äî B√¢tisseur",
    category: "construction",
    description: "Villas modernes, piscines ‚Ä¢ Dakar ‚Äì Thi√®s ‚Äì Petite C√¥te",
    price: "Visite chantier",
    whatsapp: "https://wa.me/221776427113?text=Salam%20Mbaye%20je%20veux%20parler%20d%E2%80%99un%20projet%20üèóÔ∏è%20(DIGIYLYFE)",
    link: "https://digiylyfe.com/partenaires-mbaye/",
    icon: "üë∑",
    keywords: "batisseur villa piscine travaux construction saly"
  }
];

// Variables globales
let map;
let markers;
let allMarkers = [];

// ============================================
// ‚è≥ INITIALISATION APR√àS CHARGEMENT
// ============================================
(function() {
  // Attendre que tout soit charg√©
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
})();

function initAll() {
  console.log('ü¶Ö Initialisation DIGIY NDIMBAL MAP...');
  
  // V√©rifier que Leaflet est charg√©
  if (typeof L === 'undefined') {
    console.error('‚ùå Leaflet non charg√©, nouvelle tentative...');
    setTimeout(initAll, 100);
    return;
  }
  
  initMap();
  initSearch();
  initMobileHandlers();
}

// ============================================
// üó∫Ô∏è INITIALISATION CARTE
// ============================================
function initMap() {
  // Initialisation carte
  map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: true
  }).setView([QG_SALY.lat, QG_SALY.lng], 15);

  // Tuile OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap | DIGIYLYFE ‚àû',
    maxZoom: 19
  }).addTo(map);

  // Cluster de markers
  markers = L.markerClusterGroup({
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
  });

  // Ajouter tous les partenaires au QG
  allMarkers = [];
  partners.forEach(partner => {
    const marker = L.marker([QG_SALY.lat, QG_SALY.lng], {
      icon: createCustomIcon(partner.icon)
    }).bindPopup(createPopup(partner));
    
    marker.partnerData = partner;
    allMarkers.push(marker);
    markers.addLayer(marker);
  });

  map.addLayer(markers);

  // Ajouter le marker QG
  const qgMarker = L.marker([QG_SALY.lat, QG_SALY.lng], {
    icon: L.divIcon({
      className: 'custom-marker',
      html: '<div class="digiy-marker" style="width:48px;height:48px;border-width:4px;"><span style="font-size:24px;">‚àû</span></div>',
      iconSize: [48, 48],
      iconAnchor: [24, 48],
      popupAnchor: [0, -48]
    })
  }).bindPopup(`
    <div class="popup-header">üè¢ QG DIGIYLYFE Saly</div>
    <div class="popup-meta">üìç Centre de coordination</div>
    <div class="popup-desc">9 partenaires locaux ‚Ä¢ 0% commission ‚Ä¢ Entraide digitale</div>
    <div class="popup-cta">
      <a href="https://digiylyfe.com" target="_blank" class="popup-btn view">üåê DIGIYLYFE</a>
    </div>
  `).addTo(map);

  console.log('‚úÖ Carte initialis√©e avec ' + partners.length + ' partenaires');
}

// Fonction pour cr√©er un marker personnalis√©
function createCustomIcon(icon) {
  return L.divIcon({
    className: 'custom-marker',
    html: '<div class="digiy-marker"><span>' + icon + '</span></div>',
    iconSize: [36, 36],
    iconAnchor: [18, 36],
    popupAnchor: [0, -36]
  });
}

// Fonction pour cr√©er le contenu popup
function createPopup(partner) {
  return `
    <div class="popup-header">${partner.name}</div>
    <div class="popup-meta">üìç ${partner.category.toUpperCase()}</div>
    <div class="popup-desc">${partner.description}</div>
    ${partner.price ? '<div class="popup-meta">üí∞ ' + partner.price + '</div>' : ''}
    <div class="popup-cta">
      ${partner.whatsapp ? '<a href="' + partner.whatsapp + '" target="_blank" class="popup-btn whatsapp">üí¨ WhatsApp</a>' : ''}
      <a href="${partner.link}" target="_blank" class="popup-btn view">üîé Voir</a>
    </div>
  `;
}

// ============================================
// üîç RECHERCHE & FILTRES
// ============================================
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');

  function normalizeText(text) {
    return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function updateDisplay() {
    const searchTerm = normalizeText(searchInput.value.trim());
    const category = categoryFilter.value;
    
    // Filtrer les partenaires
    const filtered = partners.filter(function(p) {
      const matchCategory = category === 'all' || p.category === category;
      const matchSearch = !searchTerm || 
        normalizeText(p.name + ' ' + p.description + ' ' + p.keywords).includes(searchTerm);
      return matchCategory && matchSearch;
    });

    // Mettre √† jour le compteur
    const partnerCount = document.getElementById('partnerCount');
    partnerCount.textContent = filtered.length + ' partenaire' + (filtered.length > 1 ? 's' : '') + ' ‚Ä¢ QG Saly';

    // Mettre √† jour la liste
    const partnerList = document.getElementById('partnerList');
    partnerList.innerHTML = filtered.map(function(p) {
      return '<div class="partner-item" onclick="focusPartner(\'' + p.id + '\')">' +
        '<strong>' + p.name + '</strong>' +
        '<span>' + p.description + '</span>' +
        '</div>';
    }).join('');

    // Mettre √† jour les markers sur la carte
    if (markers) {
      markers.clearLayers();
      allMarkers.forEach(function(marker) {
        if (filtered.find(function(p) { return p.id === marker.partnerData.id; })) {
          markers.addLayer(marker);
        }
      });
    }
  }

  // Event listeners
  searchInput.addEventListener('input', updateDisplay);
  categoryFilter.addEventListener('change', updateDisplay);

  // Initialisation
  updateDisplay();
}

// Focus sur un partenaire
window.focusPartner = function(partnerId) {
  const marker = allMarkers.find(function(m) { return m.partnerData.id === partnerId; });
  if (marker) {
    map.setView([QG_SALY.lat, QG_SALY.lng], 17);
    marker.openPopup();
    
    // Fermer le panneau sur mobile apr√®s s√©lection
    if (window.innerWidth <= 768) {
      const panel = document.getElementById('searchPanel');
      const button = document.getElementById('searchToggle');
      panel.classList.remove('open');
      button.textContent = 'üîç Rechercher';
    }
  }
};

// ============================================
// üì± HANDLERS MOBILE
// ============================================
function initMobileHandlers() {
  // Fermer le panneau si on clique sur la carte (mobile uniquement)
  if (window.innerWidth <= 768) {
    document.getElementById('map').addEventListener('click', function() {
      const panel = document.getElementById('searchPanel');
      const button = document.getElementById('searchToggle');
      if (panel.classList.contains('open')) {
        panel.classList.remove('open');
        button.textContent = 'üîç Rechercher';
      }
    });
  }
}

console.log('ü¶Ö DIGIY NDIMBAL MAP Saly ‚Äî Pr√™t ! Pierre par pierre ‚àû');
</script>

</body>
</html>
