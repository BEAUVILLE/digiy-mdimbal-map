/**
 * ğŸ—ºï¸ SYNCHRONISATION AUTOMATIQUE FICHE â†’ NDIMBAL MAP
 * 
 * Ce script synchronise automatiquement les nouveaux partenaires
 * entre partners-data.json et la table Supabase 'partners' pour NDIMBAL Map
 */

// Configuration Supabase
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

/**
 * Fonction principale : Ajouter un partenaire Ã  NDIMBAL Map
 * @param {Object} partnerData - DonnÃ©es du partenaire depuis partners-data.json
 */
async function addPartnerToNdimbalMap(partnerData) {
  
  // CrÃ©er client Supabase
  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
  
  // PrÃ©parer donnÃ©es pour table 'partners' (NDIMBAL Map)
  const mapPartner = {
    slug: partnerData.id,
    name: partnerData.name,
    category: partnerData.category,
    description: partnerData.description,
    price: partnerData.price,
    location: partnerData.location,
    latitude: partnerData.gps.lat,
    longitude: partnerData.gps.lng,
    icon: partnerData.emoji,
    keywords: [
      partnerData.name.toLowerCase(),
      partnerData.category,
      partnerData.location.toLowerCase(),
      ...partnerData.features.map(f => f.toLowerCase()),
      ...partnerData.services.slice(0, 3).map(s => s.toLowerCase())
    ].join(' '),
    whatsapp_url: partnerData.whatsapp,
    website_url: `https://TON-USERNAME.github.io/digiy-partenaires/?id=${partnerData.id}`,
    phone: partnerData.phone,
    email: partnerData.email,
    is_active: true,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };
  
  try {
    // VÃ©rifier si existe dÃ©jÃ 
    const { data: existing } = await supabase
      .from('partners')
      .select('id')
      .eq('slug', partnerData.id)
      .single();
    
    if (existing) {
      // Mise Ã  jour
      const { data, error } = await supabase
        .from('partners')
        .update(mapPartner)
        .eq('slug', partnerData.id)
        .select();
      
      if (error) throw error;
      
      console.log(`âœ… Partenaire ${partnerData.name} mis Ã  jour sur NDIMBAL Map`);
      return { success: true, action: 'updated', data };
      
    } else {
      // Insertion
      const { data, error } = await supabase
        .from('partners')
        .insert(mapPartner)
        .select();
      
      if (error) throw error;
      
      console.log(`âœ… Partenaire ${partnerData.name} ajoutÃ© Ã  NDIMBAL Map`);
      return { success: true, action: 'created', data };
    }
    
  } catch (error) {
    console.error(`âŒ Erreur NDIMBAL Map pour ${partnerData.name}:`, error);
    return { success: false, error: error.message };
  }
}

/**
 * Synchroniser TOUS les partenaires de partners-data.json vers NDIMBAL Map
 */
async function syncAllPartnersToMap() {
  
  console.log('ğŸ—ºï¸ DÃ©but synchronisation NDIMBAL Map...');
  
  try {
    // Charger partners-data.json
    const response = await fetch('partners-data.json');
    const data = await response.json();
    
    const results = {
      total: data.partners.length,
      created: 0,
      updated: 0,
      failed: 0,
      errors: []
    };
    
    // Traiter chaque partenaire
    for (const partner of data.partners) {
      const result = await addPartnerToNdimbalMap(partner);
      
      if (result.success) {
        if (result.action === 'created') results.created++;
        if (result.action === 'updated') results.updated++;
      } else {
        results.failed++;
        results.errors.push({
          partner: partner.name,
          error: result.error
        });
      }
      
      // Pause pour Ã©viter rate limiting
      await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    console.log('ğŸ“Š RÃ©sultat synchronisation:', results);
    
    return results;
    
  } catch (error) {
    console.error('âŒ Erreur synchronisation globale:', error);
    return { success: false, error: error.message };
  }
}

/**
 * Webhook appelÃ© aprÃ¨s crÃ©ation d'un nouveau partenaire
 * (Ã€ intÃ©grer dans le processus post-paiement)
 */
async function onNewPartnerCreated(partnerData) {
  
  console.log('ğŸ†• Nouveau partenaire dÃ©tectÃ©:', partnerData.name);
  
  // 1. Ajouter Ã  NDIMBAL Map
  const mapResult = await addPartnerToNdimbalMap(partnerData);
  
  if (!mapResult.success) {
    console.error('Ã‰chec ajout NDIMBAL Map');
    return { success: false, error: mapResult.error };
  }
  
  // 2. Envoyer notification WhatsApp au partenaire
  const message = `
ğŸ¦… Bienvenue ${partnerData.name} dans DIGIYLYFE !

âœ… Ton inscription est validÃ©e
âœ… Ta fiche partenaire est en ligne :
https://TON-USERNAME.github.io/digiy-partenaires/?id=${partnerData.id}

âœ… Tu es maintenant sur NDIMBAL Map !
ğŸ—ºï¸ Les clients peuvent te trouver facilement

ğŸ“± Partage ton lien !
ğŸ’° 0% commission - tu gardes 100%

L'Ã©quipe DIGIYLYFE âˆ
  `.trim();
  
  console.log('ğŸ“± Message WhatsApp prÃ©parÃ©:', message);
  
  // Ici, intÃ©grer ton systÃ¨me WhatsApp
  // await sendWhatsAppMessage(partnerData.phone, message);
  
  return {
    success: true,
    mapAdded: true,
    partnerUrl: `https://TON-USERNAME.github.io/digiy-partenaires/?id=${partnerData.id}`
  };
}

/**
 * Interface pour tester depuis la console
 */
window.DIGIY_NDIMBAL = {
  addPartner: addPartnerToNdimbalMap,
  syncAll: syncAllPartnersToMap,
  onNewPartner: onNewPartnerCreated
};

console.log('ğŸ—ºï¸ DIGIY NDIMBAL Sync chargÃ© !');
console.log('ğŸ’¡ Utilise : DIGIY_NDIMBAL.syncAll() pour synchroniser tous les partenaires');
console.log('ğŸ’¡ Utilise : DIGIY_NDIMBAL.addPartner(data) pour ajouter un partenaire');

// Export pour Node.js (si utilisÃ© cÃ´tÃ© serveur)
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    addPartnerToNdimbalMap,
    syncAllPartnersToMap,
    onNewPartnerCreated
  };
}
