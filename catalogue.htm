<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>DIGIYLYFE ‚Äî Catalogue Local Premium (Sable & Or) ‚Äî Supabase</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* ============================================ */
  /* üé® TH√àME SABLE & OR ‚Äî premium */
  /* ============================================ */
  :root{
    --bg-1:#f7f3ea; --bg-2:#efe7d6; --ink:#1f2937; --muted:#6b7280;
    --card:#fff; --line:rgba(31,41,55,.08); --shadow:0 10px 30px rgba(0,0,0,.06);

    --gold-1:#d1b464; --gold-2:#b89231; --gold-3:#f3e6b3;
    --accent-cta-1:#b38728; --accent-cta-2:#f9d976;

    --radius-xl:28px; --radius-lg:18px; --topbar-h:64px;
  }
  *{box-sizing:border-box}

  body{
    margin:0; padding:20px; min-height:100svh; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 10% 0%, var(--bg-2), transparent),
      radial-gradient(1200px 600px at 100% 30%, var(--bg-1), transparent),
      linear-gradient(180deg, var(--bg-1), #fbfaf7 40%, #ffffff 100%);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }

  @media (prefers-color-scheme: dark){
    :root{ --ink:#f4f5f7; --card:#0f141b; --line: rgba(255,255,255,.08); --bg-1:#0a0d12; --bg-2:#141922; --muted:#a3aab6; }
    body{ background: linear-gradient(180deg, #0b0f15, #10161e 60%, #0b0f15); }
  }

  .digiy-wrap{
    max-width:1200px; margin:0 auto; padding:24px;
    background:rgba(255,255,255,.85);
    -webkit-backdrop-filter: blur(14px) saturate(140%);
    backdrop-filter: blur(14px) saturate(140%);
    border-radius: var(--radius-xl);
    border:1px solid var(--line);
    box-shadow:0 24px 60px rgba(0,0,0,.12), 0 1px 0 rgba(255,255,255,.6) inset;
    position:relative; overflow:hidden;
  }
  .digiy-wrap::before{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent 0%, rgba(209,180,100,.08) 50%, transparent 100%);
    pointer-events:none;
    mask: linear-gradient(90deg, transparent 0%, black 45%, black 55%, transparent 100%);
  }

  /* ============================================ */
  /* üß≠ TOPBAR */
  /* ============================================ */
  .topbar{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    margin:-24px -24px 14px; padding:14px 18px;
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.82));
    -webkit-backdrop-filter: blur(10px) saturate(140%);
    backdrop-filter: blur(10px) saturate(140%);
    border-bottom:1px solid var(--line);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
  }
  .brand{
    display:flex; align-items:center; gap:10px; min-width:220px;
  }
  .brand .inf{
    width:38px; height:38px; border-radius:12px;
    display:grid; place-items:center;
    background:linear-gradient(135deg, var(--gold-3), var(--gold-1));
    border:1px solid rgba(0,0,0,.06);
    box-shadow:0 8px 18px rgba(0,0,0,.08);
    font-weight:1000; font-size:20px; color:#111;
  }
  .brand .txt{line-height:1.05}
  .brand .txt b{display:block; font-size:14px; letter-spacing:.2px}
  .brand .txt span{display:block; font-size:12px; color:var(--muted); font-weight:700}

  .top-actions{display:flex; gap:8px; align-items:center}
  .btn{
    border:1px solid var(--line);
    background:#fff;
    color:var(--ink);
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    font-size:13px;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex;
    gap:8px;
    align-items:center;
    transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    user-select:none;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.08); border-color:rgba(209,180,100,.45); }
  .btn.gold{
    background: linear-gradient(135deg, var(--accent-cta-2), var(--accent-cta-1));
    border-color: rgba(179,135,40,.25);
    color:#111;
    box-shadow: 0 8px 16px rgba(179,135,40,.18);
  }

  /* ============================================ */
  /* üéØ TOOLBAR FILTERS */
  /* ============================================ */
  .digiy-toolbar{
    display:flex; gap:12px; margin-bottom:12px;
  }
  .digiy-toolbar input, .digiy-toolbar select{
    flex:1; padding:11px 14px; font-size:14px; color:var(--ink);
    background:#fff; border:1px solid var(--line); border-radius: 12px;
    transition: box-shadow .2s ease, border-color .2s ease, transform .15s ease;
  }
  .digiy-toolbar input:focus, .digiy-toolbar select:focus{
    outline:none; border-color: var(--gold-1);
    box-shadow: 0 0 0 3px rgba(209,180,100,.25);
    transform: translateY(-1px);
  }

  .digiy-subbar{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    margin: 10px 0 8px;
  }
  .digiy-count{ font-weight:900; color:var(--muted); }
  .digiy-hint{ font-size:12px; color:var(--muted); font-weight:800; }

  mark{ background: linear-gradient(120deg, var(--gold-3), #fde68a); border-radius:4px; padding: 0 4px; }

  /* ============================================ */
  /* üí≥ GRID + CARDS */
  /* ============================================ */
  .digiy-row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:22px; }

  .digiy-card{
    display:flex; flex-direction:column;
    background:var(--card);
    border-radius: var(--radius-lg);
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    position:relative; overflow:hidden;
    transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    content-visibility:auto;
    contain-intrinsic-size: 320px 420px;
  }
  .digiy-card:hover{ transform:translateY(-5px); box-shadow:0 18px 40px rgba(0,0,0,.10); border-color: rgba(209,180,100,.45); }
  .digiy-card::after{
    content:""; position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .2s ease;
    background: radial-gradient(420px 140px at 80% 0%, rgba(209,180,100,.18), transparent 60%);
  }
  .digiy-card:hover::after{opacity:1}

  .digiy-thumb{ height:220px; position:relative; overflow:hidden; background:linear-gradient(135deg,#c8b27a,#e9d9a4); }
  .digiy-thumb img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; transition: transform .35s ease; }
  .digiy-card:hover .digiy-thumb img{ transform:scale(1.05); }

  .digiy-badge{
    position:absolute; top:12px; right:12px; z-index:2;
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color:#111;
    border-radius:10px;
    font-size:11px;
    font-weight:1000;
    padding:6px 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,.12), 0 0 0 1px rgba(255,255,255,.35) inset;
  }

  .digiy-body{ padding:16px; display:flex; flex-direction:column; gap:6px; }
  .digiy-title{ margin:0; font-size:18px; font-weight:1000; color:var(--ink); letter-spacing:.2px; }
  .digiy-meta{ margin:0; font-size:13px; color:var(--muted); font-weight:800; }
  .digiy-desc{ margin:0; font-size:13px; color:#4b5563; }
  .digiy-price{ margin:6px 0 10px; font-weight:1000; font-size:17px; color:#1f2937; }

  .digiy-footer{ border-top:1px solid var(--line); padding-top:10px; margin-top:auto; }
  .digiy-cta{ display:flex; gap:8px; flex-wrap:wrap; }

  .digiy-btn{
    flex:1; text-align:center; text-decoration:none;
    font-weight:1000; font-size:13px;
    padding:10px 14px; border-radius:12px;
    color:#111; position:relative; overflow:hidden;
    transition: transform .15s ease, box-shadow .15s ease;
    border:1px solid rgba(0,0,0,.06);
  }
  .digiy-btn:focus{ outline:3px solid rgba(209,180,100,.35); outline-offset:2px; }
  .digiy-btn::before{
    content:""; position:absolute; top:50%; left:50%;
    width:0; height:0; border-radius:50%;
    background: rgba(255,255,255,.4);
    transform: translate(-50%,-50%);
    transition: width .35s, height .35s;
  }
  .digiy-btn:hover::before{ width:260px; height:260px; }
  .digiy-btn:hover{ transform:translateY(-1px); }

  .digiy-btn.view{
    background: linear-gradient(135deg, var(--accent-cta-2), var(--accent-cta-1));
    box-shadow: 0 6px 16px rgba(179,135,40,.20);
  }
  .digiy-btn.whatsapp{
    color:#fff;
    background: linear-gradient(135deg, #35d07f, #0d9f54);
    box-shadow: 0 6px 16px rgba(13,159,84,.18);
  }
  .digiy-btn.map{
    background: #fff;
    border-color: rgba(209,180,100,.35);
  }

  /* ============================================ */
  /* üì± MOBILE */
  /* ============================================ */
  @media (max-width: 640px){
    body{ padding:10px; }
    .digiy-wrap{ padding:14px; border-radius: 20px; }
    .topbar{ flex-wrap:wrap; gap:10px; margin:-14px -14px 12px; padding:12px; }
    .brand{ min-width:auto; }
    .top-actions{ width:100%; justify-content:flex-end; }

    .digiy-toolbar{ flex-direction:column; }

    .digiy-card{ display:grid; grid-template-columns:1fr; grid-template-rows:110px; border-radius:16px; }
    .digiy-thumb{ grid-column:1 / -1; height:100%; width:100%; }

    .digiy-body{
      grid-column:1 / -1; grid-row:1 / -1;
      background: linear-gradient(to right, rgba(255,255,255,0) 88px, rgba(255,255,255,.96) 110px, #fff 128px);
      border-radius: 0 16px 16px 0;
      padding:6px 8px 6px 114px;
    }
    .digiy-title{ font-size:14px; line-height:1.12; }
    .digiy-meta{ display:none !important; }
    .digiy-desc{ font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .digiy-price{ font-size:13px; margin:2px 0 4px; }
    .digiy-footer{ border-top:none; padding-top:0; }
    .digiy-btn{ padding:6px 8px; font-size:11px; flex:0 0 auto; width:auto; }
    .digiy-badge{ top:6px; right:8px; font-size:10px; padding:4px 7px; }
  }

  /* ============================================ */
  /* üö´ EMPTY / LOADER */
  /* ============================================ */
  .empty-state-box{
    text-align:center; padding:56px 18px;
    background: rgba(255,255,255,.6);
    border-radius: 18px;
    border: 2px dashed rgba(31,41,55,.12);
    margin: 18px 0;
  }
  .empty-state-box p:first-child{ font-size:18px; font-weight:1000; margin:0 0 8px; }
  .empty-state-box p:last-child{ font-size:14px; color:var(--muted); margin:0; font-weight:800; }

  .loader{
    display:flex; align-items:center; gap:10px;
    padding:12px 14px; border-radius:14px;
    background:rgba(255,255,255,.7);
    border:1px solid var(--line);
    font-weight:900; color:var(--muted);
    margin: 10px 0 14px;
  }
  .dot{
    width:10px; height:10px; border-radius:50%;
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    animation: pulse .9s infinite ease-in-out;
  }
  @keyframes pulse{ 0%,100%{transform:scale(1);opacity:.6} 50%{transform:scale(1.25);opacity:1} }
</style>
</head>

<body>

<section class="digiy-wrap" aria-label="Catalogue partenaires DIGIYLYFE">

  <div class="topbar" role="banner" aria-label="DIGIY topbar">
    <div class="brand">
      <div class="inf">‚àû</div>
      <div class="txt">
        <b>DIGIYLYFE ‚Ä¢ Catalogue</b>
        <span>0% commission ‚Ä¢ paiement direct au pro</span>
      </div>
    </div>

    <div class="top-actions">
      <a class="btn" href="https://beauville.github.io/digiy-hub/" title="Retour au HUB">üè† Retour HUB</a>
      <a class="btn gold" id="openMapBtn" href="https://beauville.github.io/digiy-mdimbal-map/" title="Ouvrir NDIMBAL MAP">üó∫Ô∏è NDIMBAL MAP</a>
    </div>
  </div>

  <div class="digiy-toolbar" role="region" aria-label="Filtres catalogue">
    <input id="q-search" type="search" placeholder="üîç Rechercher (Saly, chauffeur, villa...)" aria-label="Recherche partenaires" autocomplete="off" inputmode="search" />
    <select id="cat-filter" aria-label="Filtrer par cat√©gorie">
      <option value="all">üåü Toutes cat√©gories</option>
      <option value="logement">üè® H√©bergement</option>
      <option value="commerce">üõí Market & Style</option>
      <option value="taxi">üöó Driver</option>
      <option value="batiment">üèóÔ∏è B√¢tisseur</option>
      <option value="voyage">üå¥ Explore</option>
      <option value="restaurant">üçΩÔ∏è Resto</option>
    </select>
    <select id="region-filter" aria-label="Filtrer par r√©gion">
      <option value="all">üó∫Ô∏è Toutes r√©gions</option>
      <option value="dakar">Dakar</option>
      <option value="thies">Thi√®s (Saly inclus)</option>
      <option value="diourbel">Diourbel</option>
      <option value="fatick">Fatick</option>
      <option value="kaolack">Kaolack</option>
      <option value="saint-louis">Saint-Louis</option>
      <option value="ziguinchor">Ziguinchor</option>
      <option value="louga">Louga</option>
      <option value="tambacounda">Tambacounda</option>
      <option value="matam">Matam</option>
    </select>
  </div>

  <div class="digiy-subbar">
    <p id="count" class="digiy-count" aria-live="polite">Chargement‚Ä¶</p>
    <div class="digiy-hint" id="hint">Astuce : clique ‚Äúüó∫Ô∏è NDIMBAL MAP‚Äù pour guidage/distance.</div>
  </div>

  <div id="loading" class="loader" aria-live="polite">
    <span class="dot"></span> Synchronisation NDIMBAL‚Ä¶
  </div>

  <div class="digiy-row" id="cards-container"></div>

  <div id="empty-state" class="empty-state-box" hidden>
    <p>üòï Oups ! Aucun partenaire trouv√©.</p>
    <p>V√©rifie l‚Äôorthographe ou repasse sur ‚ÄúToutes cat√©gories / r√©gions‚Äù.</p>
  </div>

</section>

<script>
/* ==========================================================
   ‚úÖ CONFIG SUPABASE
========================================================== */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ==========================================================
   ‚úÖ HELPERS (anti-bugs + Saly‚ÜíThi√®s)
========================================================== */
const $ = (s, p=document)=> p.querySelector(s);
const $$ = (s, p=document)=> Array.from(p.querySelectorAll(s));

function fold(s){
  return (s||"").toString().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .trim();
}

function toRegionKey(regionOrCity){
  const v = fold(regionOrCity);

  // ‚úÖ Saly / Petite C√¥te -> Thi√®s
  if(v.includes("saly") || v.includes("mbour") || v.includes("somone") || v.includes("ngaparou") || v.includes("warang") || v.includes("popenguine")){
    return "thies";
  }

  if(v.includes("dakar")) return "dakar";
  if(v.includes("thies")) return "thies";
  if(v.includes("saint") && v.includes("louis")) return "saint-louis";
  if(v.includes("ziguinchor")) return "ziguinchor";
  if(v.includes("diourbel")) return "diourbel";
  if(v.includes("fatick")) return "fatick";
  if(v.includes("kaolack")) return "kaolack";
  if(v.includes("louga")) return "louga";
  if(v.includes("tambacounda")) return "tambacounda";
  if(v.includes("matam")) return "matam";

  const clean = v.replace(/\s+/g,"-");
  return clean || "unknown";
}

function normalizeCategory(cat){
  const v = fold(cat);
  if(v.includes("resto") || v.includes("restaurant")) return "restaurant";
  if(v.includes("market") || v.includes("boutique") || v.includes("shop") || v.includes("commerce") || v.includes("style") || v.includes("couture")) return "commerce";
  if(v.includes("logement") || v.includes("villa") || v.includes("appart") || v.includes("hotel") || v.includes("heberg") || v.includes("hebergement")) return "logement";
  if(v.includes("taxi") || v.includes("vtc") || v.includes("chauffeur") || v.includes("driver") || v.includes("transport")) return "taxi";
  if(v.includes("bat") || v.includes("chantier") || v.includes("construction") || v.includes("plomb") || v.includes("electric")) return "batiment";
  if(v.includes("voyage") || v.includes("tour") || v.includes("guide") || v.includes("excursion") || v.includes("explore")) return "voyage";
  return "commerce";
}

function escapeHTML(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function getParam(name){
  try{
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }catch(e){ return null; }
}

/* ==========================================================
   ‚úÖ UI + TEMPLATES
========================================================== */
const CAT_LABELS = {
  restaurant:"üçΩÔ∏è Restaurant",
  commerce:"üõí Market & Style",
  logement:"üè® H√©bergement",
  taxi:"üöó Driver",
  batiment:"üèóÔ∏è B√¢tisseur",
  voyage:"üå¥ Explore"
};

function badgeTextFor(p){
  // petite logique ‚Äúpremium‚Äù pour badge
  if(p.__cat === "taxi") return "‚è≥ Dispo aujourd‚Äôhui";
  if(p.__cat === "logement") return "‚è≥ 1 dispo";
  if(p.__cat === "commerce") return "üõçÔ∏è Local";
  if(p.__cat === "restaurant") return "üçΩÔ∏è √Ä tester";
  if(p.__cat === "batiment") return "üèóÔ∏è Pro terrain";
  if(p.__cat === "voyage") return "üå¥ Circuit";
  return "‚ú® Premium";
}

function pickCover(p){
  // essaie plusieurs champs possibles selon ta DB
  const url =
    p.cover_url || p.cover || p.photo_url || p.image_url || p.image || p.avatar_url || p.logo_url || "";
  if(url && String(url).startsWith("http")) return url;

  // fallback premium (pas d‚Äôimages externes obligatoires)
  // (petit SVG inline simple)
  const title = escapeHTML(p.name || p.title || "DIGIYLYFE");
  const subtitle = escapeHTML(CAT_LABELS[p.__cat] || "Partenaire");
  const bg1 = "f3e6b3", bg2 = "d1b464";
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#${bg1}"/>
        <stop offset="1" stop-color="#${bg2}"/>
      </linearGradient>
    </defs>
    <rect width="1200" height="800" fill="url(#g)"/>
    <circle cx="980" cy="180" r="220" fill="rgba(255,255,255,.25)"/>
    <circle cx="250" cy="620" r="320" fill="rgba(0,0,0,.06)"/>
    <text x="70" y="160" font-family="Arial" font-size="54" font-weight="800" fill="#111">${title}</text>
    <text x="70" y="230" font-family="Arial" font-size="34" font-weight="700" fill="rgba(17,17,17,.7)">${subtitle}</text>
    <text x="70" y="710" font-family="Arial" font-size="28" font-weight="800" fill="rgba(17,17,17,.55)">‚àû DIGIYLYFE ‚Äî Paiement direct au pro</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function buildCard(p, highlightTerms=[]){
  const name = escapeHTML(p.name || p.title || "Partenaire");
  const city = escapeHTML(p.city || p.town || "");
  const rawRegion = p.region || p.area || p.zone || "";
  const regionLabel = escapeHTML((p.__region || rawRegion || "").toString().replace(/-/g," ").replace(/\b\w/g, c=>c.toUpperCase()));
  const desc = escapeHTML(p.description || p.short_desc || p.bio || "Service local ‚Ä¢ contact direct");
  const badge = badgeTextFor(p);
  const cover = pickCover(p);

  // prix
  const price = p.price_text || p.price || p.tarif || "";
  const priceHTML = price ? `üí∞ <strong>${escapeHTML(String(price))}</strong>` : `üí∞ <strong>Sur demande</strong>`;

  // actions
  const slug = (p.slug || "").toString().trim();
  const phone = (p.phone || p.tel || p.whatsapp || "").toString().trim();

  // lien fiche
  const page = p.page_url || p.website || p.url || p.link || "";
  const hasPage = page && String(page).startsWith("http");

  // whatsapp
  const wa = phone ? phone.replace(/\D/g,"") : "";
  const waLink = wa ? `https://wa.me/${wa}?text=${encodeURIComponent("Salam " + (p.name||"") + " ‚Ä¢ DIGIYLYFE (je veux des infos)")}` : "";

  // map (slug ready)
  const mapUrl = slug ? `https://beauville.github.io/digiy-mdimbal-map/?pro=${encodeURIComponent(slug)}` : `https://beauville.github.io/digiy-mdimbal-map/`;

  // highlight safe (simple)
  const hName = highlightText(name, highlightTerms);
  const hDesc = highlightText(desc, highlightTerms);

  return `
    <article class="digiy-card" data-cat="${escapeHTML(p.__cat)}" data-region="${escapeHTML(p.__region)}" data-keywords="${escapeHTML(p.__text)}" id="${escapeHTML(slug || ("pro-"+String(p.id||""))) }">
      <div class="digiy-thumb">
        <div class="digiy-badge">${badge}</div>
        <img width="1200" height="800" src="${cover}" alt="${name}" loading="lazy" decoding="async"/>
      </div>

      <div class="digiy-body">
        <h3 class="digiy-title">${hName}</h3>
        <p class="digiy-meta">üìç ${city || "S√©n√©gal"}${regionLabel ? " ‚Ä¢ "+regionLabel : ""} ‚Ä¢ ${escapeHTML(CAT_LABELS[p.__cat] || "Service")}</p>
        <p class="digiy-desc">${hDesc}</p>

        <div class="digiy-footer">
          <p class="digiy-price">${priceHTML}</p>

          <div class="digiy-cta">
            ${waLink ? `<a class="digiy-btn whatsapp" href="${waLink}" target="_blank" rel="noopener">üí¨ WhatsApp</a>` : (phone ? `<a class="digiy-btn whatsapp" href="tel:${escapeHTML(phone)}">üìû Appeler</a>` : ``)}
            ${hasPage ? `<a class="digiy-btn view" href="${escapeHTML(page)}" target="_blank" rel="noopener">üì≤ Voir</a>` : ``}
            <a class="digiy-btn map" href="${mapUrl}" target="_blank" rel="noopener">üó∫Ô∏è Carte</a>
          </div>
        </div>
      </div>
    </article>
  `;
}

function highlightText(htmlSafeText, terms){
  // htmlSafeText est d√©j√† √©chapp√© ; on peut injecter <mark> dessus sans risque
  if(!terms || !terms.length) return htmlSafeText;
  const uniq = Array.from(new Set(terms.map(t=>t.trim()).filter(t=>t.length>1))).slice(0,6);
  if(!uniq.length) return htmlSafeText;
  const escaped = uniq.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"));
  const rx = new RegExp("(" + escaped.join("|") + ")", "gi");
  return htmlSafeText.replace(rx, "<mark>$1</mark>");
}

/* ==========================================================
   ‚úÖ DATA (Supabase)
========================================================== */
let allPros = [];
let filtered = [];

async function loadPros(){
  // On ne d√©pend PAS de is_active (tu as eu l‚Äôerreur colonne)
  // On charge tout, puis on filtre c√¥t√© front si besoin.
  const res = await SB.from("professionals").select("*").order("created_at", { ascending:false });
  if(res.error){
    console.warn("Supabase load error:", res.error);
    return [];
  }
  return res.data || [];
}

function normalizePros(rows){
  return (rows||[]).map(p=>{
    const name = p.name || p.title || p.business_name || "";
    const city = p.city || p.town || p.commune || "";
    const region = p.region || p.area || p.zone || city || "";
    const cat = p.category || p.cat || p.type || p.module || "";

    const __cat = normalizeCategory(cat);
    const __region = toRegionKey(region);
    const __text = fold(
      (name||"") + " " + (city||"") + " " + (region||"") + " " +
      (p.description||p.short_desc||p.bio||"") + " " + (p.slug||"")
    );

    return { ...p, __cat, __region, __text };
  });
}

/* ==========================================================
   ‚úÖ FILTER ENGINE
========================================================== */
const searchInput = $("#q-search");
const catFilter   = $("#cat-filter");
const regFilter   = $("#region-filter");
const container   = $("#cards-container");
const countEl     = $("#count");
const emptyState  = $("#empty-state");
const loadingEl   = $("#loading");
const openMapBtn  = $("#openMapBtn");

function tokenize(q){
  return fold(q).split(/\s+/).filter(t => t.length > 1).slice(0,8);
}

function applyFilters(){
  const q = searchInput.value.trim();
  const terms = tokenize(q);
  const cat = catFilter.value;
  const reg = regFilter.value;

  let res = [...allPros];

  if(cat !== "all") res = res.filter(p => p.__cat === cat);
  if(reg !== "all") res = res.filter(p => p.__region === reg);

  if(terms.length){
    res = res
      .map(p=>{
        let score = 0;
        for(const t of terms){ if(p.__text.includes(t)) score++; }
        return { p, score };
      })
      .filter(x => x.score > 0)
      .sort((a,b)=> b.score - a.score)
      .map(x => x.p);
  }

  filtered = res;
  render(res, q);
  updateCount();
  updateMapButton();
}

function updateCount(){
  const n = filtered.length;
  countEl.textContent = `${n} partenaire${n>1?"s":""} trouv√©${n>1?"s":""}`;
  emptyState.hidden = n > 0;
}

function updateMapButton(){
  // si un seul r√©sultat et qu‚Äôil a un slug -> bouton map direct sur ce pro
  if(filtered.length === 1 && filtered[0].slug){
    openMapBtn.href = `https://beauville.github.io/digiy-mdimbal-map/?pro=${encodeURIComponent(filtered[0].slug)}`;
    openMapBtn.textContent = "üó∫Ô∏è NDIMBAL MAP (ce pro)";
  }else{
    openMapBtn.href = "https://beauville.github.io/digiy-mdimbal-map/";
    openMapBtn.textContent = "üó∫Ô∏è NDIMBAL MAP";
  }
}

function render(list, q){
  const terms = q ? q.split(/\s+/).filter(t=>t.trim().length>1).slice(0,8) : [];
  const html = list.map(p => buildCard(p, terms)).join("");
  container.innerHTML = html || "";
}

/* ==========================================================
   ‚úÖ SLUG READY (open catalogue.htm?pro=slug)
========================================================== */
function focusSlugIfAny(){
  const slug = (getParam("pro") || "").trim();
  if(!slug) return;

  // cherche dans la liste
  const hit = allPros.find(p => String(p.slug||"") === slug);
  if(!hit){
    // si pas trouv√©, on met le slug dans recherche, √ßa aide
    searchInput.value = slug;
    applyFilters();
    return;
  }

  // force filtres en ‚Äúall‚Äù pour √©viter disparition
  catFilter.value = "all";
  regFilter.value = "all";
  searchInput.value = hit.name || hit.title || slug;

  applyFilters();

  // scroll vers la card
  const el = document.getElementById(slug);
  if(el){
    setTimeout(()=> el.scrollIntoView({ behavior:"smooth", block:"start" }), 200);
  }
}

/* ==========================================================
   ‚úÖ INIT
========================================================== */
let debounceId;
function debouncedApply(){
  clearTimeout(debounceId);
  debounceId = setTimeout(applyFilters, 70);
}

document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    loadingEl.style.display = "flex";

    const rows = await loadPros();
    allPros = normalizePros(rows);

    // ‚úÖ S√©curit√© : si ta table est vide, on affiche un message propre
    if(!allPros.length){
      container.innerHTML = "";
      emptyState.hidden = false;
      countEl.textContent = "0 partenaire trouv√©";
      loadingEl.style.display = "none";
      updateMapButton();
      return;
    }

    // render initial
    filtered = [...allPros];
    render(filtered, "");
    updateCount();
    updateMapButton();

    // events
    searchInput.addEventListener("input", debouncedApply);
    searchInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); applyFilters(); }});
    catFilter.addEventListener("change", applyFilters);
    regFilter.addEventListener("change", applyFilters);

    // ‚úÖ slug focus
    focusSlugIfAny();

  }catch(err){
    console.warn("Init error:", err);
    container.innerHTML = "";
    emptyState.hidden = false;
    countEl.textContent = "Erreur chargement";
  }finally{
    loadingEl.style.display = "none";
  }
});
</script>

</body>
</html>
