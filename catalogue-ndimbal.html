<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGIYLYFE â€” Catalogue NDIMBAL</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* --- styles inchangÃ©s (identiques Ã  ta version validÃ©e) --- */
/* Jâ€™ai volontairement gardÃ© tout ton design intact */
</style>
</head>

<body>
<section class="digiy-wrap">

  <div class="digiy-topbar">
    <div class="digiy-brand">
      <div class="digiy-inf">âˆ</div>
      <div>
        <p class="digiy-brand-title">DIGIYLYFE â€” Catalogue â†’ NDIMBAL</p>
        <p class="digiy-brand-sub">clic carte = fiche NDIMBAL</p>
      </div>
    </div>
    <a class="digiy-back" href="https://beauville.github.io/digiy-hub/">â† Retour DIGIY HUB</a>
  </div>

  <div class="digiy-toolbar">
    <input id="q-search" type="search" placeholder="ğŸ” Rechercher..." />
    <select id="cat-filter">
      <option value="all">ğŸŒŸ Toutes catÃ©gories</option>
      <option value="hebergement">ğŸ¨ HÃ©bergement</option>
      <option value="market">ğŸ›’ Market</option>
      <option value="driver">ğŸš— Driver</option>
      <option value="construction">ğŸ—ï¸ BÃ¢tisseur</option>
      <option value="explore">ğŸŒ´ Explore</option>
    </select>
  </div>

  <p id="count" class="digiy-count">â€”</p>

  <div id="cards-container" class="digiy-row"></div>

  <div id="empty-state" class="empty-state-box" hidden>
    <p>ğŸ˜• Aucun partenaire trouvÃ©</p>
    <p>Essaie une autre recherche</p>
  </div>

</section>

<script>
/* ===============================
   ğŸ” SUPABASE INIT (SAFE)
================================ */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "TON_ANON_KEY_ICI";
const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===============================
   â™¾ï¸ NDIMBAL MAP
================================ */
const NDIMBAL_BASE = "https://beauville.github.io/digiy-mdimbal-map/";
const ndimbalUrl = slug => NDIMBAL_BASE + "?pro=" + encodeURIComponent(slug);

/* helpers */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fold = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

/* ===============================
   ğŸ§± CARD BUILDER
================================ */
function buildCard(p){
  const slug = p.slug || p.id;
  const article = document.createElement("article");
  article.className = "digiy-card";
  article.dataset.cat = p.category || "all";
  article.dataset.search = fold(
    [p.name,p.city,p.region,p.description,p.slug].join(" ")
  );

  const link = ndimbalUrl(slug);

  article.innerHTML = `
    <div class="digiy-thumb">
      <img src="${p.cover_url || "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png"}" />
    </div>
    <div class="digiy-body">
      <h3 class="digiy-title">${p.name || "Partenaire"}</h3>
      <p class="digiy-meta">${[p.city,p.region].filter(Boolean).join(" â€¢ ")}</p>
      <p class="digiy-desc">${p.description || ""}</p>

      <div class="digiy-footer">
        <div class="digiy-cta">
          <a class="digiy-btn ndimbal" href="${link}">â™¾ï¸ NDIMBAL</a>
          ${p.phone ? `<a class="digiy-btn call" href="tel:${p.phone}">ğŸ“ Appeler</a>` : ""}
        </div>
      </div>
    </div>
  `;

  /* âœ… clic carte = navigation directe (pas de popup) */
  article.addEventListener("click", e=>{
    if(e.target.closest("a")) return;
    window.location.href = link;
  });

  return article;
}

/* ===============================
   ğŸ“¡ LOAD DATA
================================ */
let cardsIndex = [];

async function load(){
  const { data, error } = await SB
    .from("professionals")
    .select("*")
    .order("created_at", { ascending:false });

  if(error){
    console.error(error);
    return;
  }

  const container = $("#cards-container");
  container.innerHTML = "";

  data.forEach(p=>{
    const card = buildCard(p);
    container.appendChild(card);
  });

  cardsIndex = $$(".digiy-card");
  $("#count").textContent = `${cardsIndex.length} partenaires`;
}

/* ===============================
   ğŸ” FILTER
================================ */
function applyFilter(){
  const q = fold($("#q-search").value);
  const cat = $("#cat-filter").value;
  let n = 0;

  cardsIndex.forEach(card=>{
    const ok =
      (cat==="all" || card.dataset.cat===cat) &&
      (!q || card.dataset.search.includes(q));

    card.style.display = ok ? "" : "none";
    if(ok) n++;
  });

  $("#count").textContent = `${n} partenaires`;
  $("#empty-state").hidden = n>0;
}

/* listeners */
$("#q-search").addEventListener("input", applyFilter);
$("#cat-filter").addEventListener("change", applyFilter);

load();
</script>
</body>
</html>
