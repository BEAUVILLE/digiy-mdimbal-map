<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGIYLYFE ‚Äî Catalogue NDIMBAL (Cards Premium) ‚Äî Supabase</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg-1:#f7f3ea; --bg-2:#efe7d6; --ink:#1f2937; --muted:#6b7280;
    --card:#fff; --line:rgba(31,41,55,.08); --shadow:0 10px 30px rgba(0,0,0,.06);
    --gold-1:#d1b464; --gold-2:#b89231; --gold-3:#f3e6b3;
    --accent-cta-1:#b38728; --accent-cta-2:#f9d976;
    --radius-xl:28px; --radius-lg:18px; --topbar-h:64px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:20px; min-height:100svh; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 10% 0%, var(--bg-2), transparent),
      radial-gradient(1200px 600px at 100% 30%, var(--bg-1), transparent),
      linear-gradient(180deg, var(--bg-1), #fbfaf7 40%, #ffffff 100%);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  @media (prefers-color-scheme: dark){
    :root{ --ink:#f4f5f7; --card:#0f141b; --line: rgba(255,255,255,.08); --bg-1:#0a0d12; --bg-2:#141922; --muted:#a3aab6; --shadow:0 10px 30px rgba(0,0,0,.45); }
    body{ background: linear-gradient(180deg, #0b0f15, #10161e 60%, #0b0f15); }
  }

  .wrap{
    max-width:1200px; margin:0 auto; padding:24px;
    background: rgba(255,255,255,.85);
    -webkit-backdrop-filter: blur(14px) saturate(140%);
    backdrop-filter: blur(14px) saturate(140%);
    border-radius: var(--radius-xl);
    border:1px solid var(--line);
    box-shadow: 0 24px 60px rgba(0,0,0,.12), 0 1px 0 rgba(255,255,255,.6) inset;
    position:relative; overflow:hidden;
  }
  @media (prefers-color-scheme: dark){
    .wrap{ background: rgba(15,20,27,.86); box-shadow:0 24px 70px rgba(0,0,0,.55), 0 1px 0 rgba(255,255,255,.06) inset; }
  }
  .wrap::before{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent 0%, rgba(209,180,100,.08) 50%, transparent 100%);
    pointer-events:none; mask: linear-gradient(90deg, transparent 0%, black 45%, black 55%, transparent 100%);
  }

  .topbar{
    display:flex; gap:12px; align-items:center;
    position:sticky; top:0; z-index:10;
    padding:14px 18px; margin:-24px -24px 18px; width:calc(100% + 48px);
    background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
    -webkit-backdrop-filter: blur(10px) saturate(140%);
    backdrop-filter: blur(10px) saturate(140%);
    border-bottom: 1px solid var(--line);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    box-shadow: 0 10px 30px rgba(0,0,0,.06);
  }
  @media (prefers-color-scheme: dark){
    .topbar{ background: linear-gradient(180deg, rgba(15,20,27,.92), rgba(15,20,27,.82)); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  }

  .brand{
    display:flex; align-items:center; gap:10px; min-width:240px;
    font-weight:1000;
  }
  .inf{
    font-weight:1000; font-size:22px;
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    -webkit-background-clip:text; background-clip:text;
    color:transparent;
  }
  .brand small{ display:block; font-weight:800; color:var(--muted); margin-top:2px; }

  .topbar input, .topbar select{
    flex:1; padding:11px 14px; font-size:14px; color:var(--ink);
    background:#fff; border:1px solid var(--line); border-radius: 12px;
    transition: box-shadow .2s ease, border-color .2s ease, transform .15s ease;
  }
  @media (prefers-color-scheme: dark){
    .topbar input, .topbar select{ background: rgba(255,255,255,.06); color: var(--ink); }
  }
  .topbar input:focus, .topbar select:focus{
    outline:none; border-color: var(--gold-1);
    box-shadow: 0 0 0 3px rgba(209,180,100,.25);
    transform: translateY(-1px);
  }

  .btn{
    flex:0 0 auto;
    padding:11px 14px; border-radius:12px; border:1px solid var(--line);
    background: rgba(255,255,255,.9);
    font-weight:1000; cursor:pointer;
    transition: transform .15s ease, box-shadow .15s ease;
    white-space:nowrap;
  }
  @media (prefers-color-scheme: dark){ .btn{ background: rgba(255,255,255,.06); } }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.10); }

  .count{ margin: 10px 0 8px; font-weight:1000; color:var(--muted); }
  .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 22px; }

  .card{
    display:flex; flex-direction:column; background:var(--card);
    border-radius: var(--radius-lg);
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    position:relative; overflow:hidden;
    transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    cursor:pointer;
    content-visibility:auto; contain-intrinsic-size: 320px 420px;
  }
  .card:hover{ transform: translateY(-5px); box-shadow: 0 18px 40px rgba(0,0,0,.10); border-color: rgba(209,180,100,.45); }
  .thumb{ height:220px; position:relative; overflow:hidden; background: linear-gradient(135deg, #c8b27a, #e9d9a4); }
  .thumb img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; transition: transform .35s ease; }
  .card:hover .thumb img{ transform: scale(1.05); }

  .badge{
    position:absolute; top:12px; right:12px; z-index:2;
    background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
    color:#111; border-radius:10px; font-size:11px; font-weight:1000; padding:6px 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,.12), 0 0 0 1px rgba(255,255,255,.35) inset;
    max-width: 80%;
    white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
  }

  .body{ padding:16px; display:flex; flex-direction:column; gap:6px; }
  .title{ margin:0; font-size:18px; font-weight:1000; letter-spacing:.2px; }
  .meta{ margin:0; font-size:13px; color:var(--muted); font-weight:800; }
  .desc{ margin:0; font-size:13px; color:#4b5563; }
  @media (prefers-color-scheme: dark){ .desc{ color:#cbd5e1; } }
  .price{ margin:6px 0 10px; font-weight:1000; font-size:17px; }

  .footer{ border-top:1px solid var(--line); padding-top:10px; margin-top:auto; }
  .cta{ display:flex; gap:8px; flex-wrap:wrap; }

  .cta a{
    flex:1;
    text-align:center; text-decoration:none;
    font-weight:1000; font-size:13px;
    padding:10px 14px; border-radius:12px;
    transition: transform .15s ease, box-shadow .15s ease;
    user-select:none;
  }
  .cta a:hover{ transform: translateY(-1px); }

  .primary{
    color:#fff;
    background: linear-gradient(135deg, #35d07f, #0d9f54);
    box-shadow: 0 6px 16px rgba(13,159,84,.28);
  }
  .secondary{
    color:#111;
    background: linear-gradient(135deg, var(--accent-cta-2), var(--accent-cta-1));
    box-shadow: 0 6px 16px rgba(179,135,40,.28);
  }
  .ndimbal{
    color:#111;
    background: linear-gradient(135deg, #fde68a, var(--accent-cta-1));
    box-shadow: 0 6px 16px rgba(179,135,40,.28);
  }

  .empty{
    text-align:center; padding:56px 18px;
    background: rgba(255,255,255,.6);
    border-radius: 18px;
    border: 2px dashed rgba(31,41,55,.12);
    margin: 18px 0;
  }
  @media (prefers-color-scheme: dark){
    .empty{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.12); }
  }
  .empty p:first-child{ font-size:18px; font-weight:1000; margin:0 0 8px; }
  .empty p:last-child{ font-size:14px; color:var(--muted); margin:0; }

  @media (max-width: 640px){
    body{ padding:10px; }
    .wrap{ padding:14px; border-radius: 20px; }
    .topbar{ flex-direction:column; padding:12px; margin:-14px -14px 14px; width:calc(100% + 28px); }
    .brand{ width:100%; justify-content:space-between; }
    .btn{ width:100%; }
    .card{ display:grid; grid-template-columns: 1fr; grid-template-rows: 110px; border-radius:16px; }
    .thumb{ grid-column:1 / -1; height:100%; width:100%; }
    .body{
      grid-column:1 / -1; grid-row:1 / -1;
      background: linear-gradient(to right, rgba(255,255,255,0) 88px, rgba(255,255,255,.96) 110px, #fff 128px);
      border-radius: 0 16px 16px 0; padding:6px 8px 6px 114px;
    }
    @media (prefers-color-scheme: dark){
      .body{ background: linear-gradient(to right, rgba(0,0,0,0) 88px, rgba(15,20,27,.92) 110px, rgba(15,20,27,.98) 128px); }
    }
    .title{ font-size:14px; line-height:1.12; }
    .meta{ display:none !important; }
    .desc{ font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .price{ font-size:13px; margin:2px 0 4px; }
    .footer{ border-top:none; padding-top:0; }
    .cta a{ padding:6px 8px; font-size:11px; flex:0 0 auto; width:auto; }
    .badge{ top:6px; right:8px; font-size:10px; padding:4px 7px; }
  }
</style>
</head>

<body>
<section class="wrap" aria-label="Catalogue NDIMBAL ‚Äî DIGIYLYFE">

  <div class="topbar" role="region" aria-label="Recherche et filtres">
    <div class="brand">
      <div>
        <div><span class="inf">‚àû</span> DIGIYLYFE ‚Äî Catalogue</div>
        <small>clic carte = NDIMBAL Map (focus slug)</small>
      </div>
    </div>

    <input id="q" type="search" placeholder="üîç Rechercher (Saly, chauffeur, villa‚Ä¶)" autocomplete="off" />
    <select id="cat">
      <option value="all">üåü Toutes cat√©gories</option>
      <option value="hebergement">üè® H√©bergement</option>
      <option value="market">üõí Market & Style</option>
      <option value="driver">üöó Driver</option>
      <option value="construction">üèóÔ∏è B√¢tisseur</option>
      <option value="explore">üå¥ Explore</option>
      <option value="restaurant">üçΩÔ∏è Restaurant</option>
    </select>
    <button class="btn" id="btnMap">üó∫Ô∏è Carte NDIMBAL</button>
    <button class="btn" id="btnHub">üè† HUB</button>
  </div>

  <p class="count" id="count">Chargement‚Ä¶</p>

  <div class="grid" id="grid"></div>

  <div class="empty" id="empty" hidden>
    <p>üòï Oups ! Aucun partenaire trouv√©.</p>
    <p>V√©rifie l‚Äôorthographe ou remets ‚ÄúToutes cat√©gories‚Äù.</p>
  </div>
</section>

<script>
/* üîê SUPABASE ‚Äî int√©gr√© */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* üî• NDIMBAL MAP base (IMPORTANT) */
const NDIMBAL_MAP_BASE = "https://beauville.github.io/digiy-mdimbal-map/"; // ton repo map
function ndimbalUrlFromSlug(slug){
  const s = (slug || "").toString().trim();
  return s ? `${NDIMBAL_MAP_BASE}?pro=${encodeURIComponent(s)}` : NDIMBAL_MAP_BASE;
}

/* DOM */
const $ = (s, p=document)=> p.querySelector(s);
const grid = $("#grid");
const countEl = $("#count");
const emptyEl = $("#empty");
const qEl = $("#q");
const catEl = $("#cat");

/* utils */
const fold = (s) => (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
const safe = (s) => (s??"").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

function pick(p, ...keys){
  for(const k of keys){
    if(p && p[k] != null && String(p[k]).trim() !== "") return String(p[k]);
  }
  return "";
}

/* ‚úÖ normalisation cat√©gories (pour que le filtre match) */
function normalizeCatValue(raw){
  const c = fold(raw).trim();
  if(!c) return "market";

  if(c.includes("heb") || c.includes("logement") || c.includes("villa") || c.includes("hotel")) return "hebergement";
  if(c.includes("driver") || c.includes("chauffeur") || c.includes("taxi") || c.includes("vtc")) return "driver";
  if(c.includes("bat") || c.includes("construct") || c.includes("artisan")) return "construction";
  if(c.includes("explore") || c.includes("voyage") || c.includes("guide") || c.includes("tour")) return "explore";
  if(c.includes("resto") || c.includes("restaurant")) return "restaurant";
  if(c.includes("market") || c.includes("commerce") || c.includes("boutique") || c.includes("style")) return "market";

  // sinon on renvoie tel quel si d√©j√† propre
  return c.replace(/\s+/g,"-");
}

function computeKeywords(p){
  return fold([
    p.name, p.title, p.slug, p.city, p.region, p.description,
    p.keywords, p.tags, p.category, p.cat, p.type
  ].filter(Boolean).join(" "));
}

/* ‚úÖ WA / TEL auto */
function normalizePhoneDigits(val){
  if(!val) return "";
  return String(val).replace(/[^\d]/g,"");
}
function waUrlFromPhone(phone){
  const digits = normalizePhoneDigits(phone);
  if(!digits) return "";
  return `https://wa.me/${digits}?text=${encodeURIComponent("Salam je viens de DIGIYLYFE üôè")}`;
}

/* ‚úÖ Card builder */
function cardHTML(p){
  const slug = pick(p, "slug") || "";
  const name = pick(p, "name","title","label") || "Partenaire";
  const meta = [pick(p,"city"), pick(p,"region")].filter(Boolean).join(" ‚Äî ");
  const desc = pick(p, "description") || "Service local ‚Äî DIGIYLYFE";
  const cover = pick(p, "cover_url","photo_url","image_url") || "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png";
  const badge = pick(p, "badge_text") || "‚ú® Partenaire";
  const price = pick(p, "price_text") || "üí∞ Sur demande";

  const cta1Label = pick(p, "cta_primary_label") || "üí¨ WhatsApp";
  const cta1Url   = pick(p, "cta_primary_url", "whatsapp_url", "phone_url");
  const cta2Label = pick(p, "cta_secondary_label") || "üîé Voir";
  const cta2Url   = pick(p, "cta_secondary_url", "page_url","website","url","link");

  const phone = pick(p, "phone");
  const autoWA = waUrlFromPhone(phone);
  const telUrl = phone ? `tel:${phone.replace(/\s+/g,"")}` : "";

  const primaryHref = cta1Url || autoWA || telUrl || "";
  const secondaryHref = cta2Url || (slug ? `https://digiylyfe.com/partenaires-${encodeURIComponent(slug)}/` : "");

  const ndimbalLink = ndimbalUrlFromSlug(slug);

  // liens valides
  const isHttp = (u)=> /^https?:\/\//i.test(u);
  const isTel  = (u)=> /^tel:/i.test(u);

  const primaryOk = isHttp(primaryHref) || isTel(primaryHref);
  const secondaryOk = isHttp(secondaryHref);

  return `
    <article class="card" data-cat="${safe(p.__cat)}" data-key="${safe(p.__kw)}" data-slug="${safe(slug)}" tabindex="0" role="button" aria-label="Ouvrir NDIMBAL pour ${safe(name)}">
      <div class="thumb">
        <div class="badge">${safe(badge)}</div>
        <img src="${safe(cover)}" alt="${safe(name)}" loading="lazy" decoding="async" />
      </div>
      <div class="body">
        <h3 class="title">${safe(name)}</h3>
        <p class="meta">${safe(meta || "S√©n√©gal")}</p>
        <p class="desc">${safe(desc)}</p>
        <div class="footer">
          <p class="price">${safe(price)}</p>
          <div class="cta">
            <a class="ndimbal" href="${safe(ndimbalLink)}" target="_blank" rel="noopener">‚ôæÔ∏è NDIMBAL</a>
            ${primaryOk ? `<a class="primary" href="${safe(primaryHref)}" target="_blank" rel="noopener">${safe(cta1Label)}</a>` : ``}
            ${secondaryOk ? `<a class="secondary" href="${safe(secondaryHref)}" target="_blank" rel="noopener">${safe(cta2Label)}</a>` : ``}
          </div>
        </div>
      </div>
    </article>
  `;
}

/* render */
function render(list){
  grid.innerHTML = list.map(cardHTML).join("");

  // ‚úÖ clic sur la carte enti√®re => NDIMBAL (sauf si clic sur lien)
  grid.querySelectorAll(".card").forEach(card=>{
    const slug = card.dataset.slug || "";
    const url = ndimbalUrlFromSlug(slug);

    const open = (e)=>{
      const link = e.target.closest("a,button");
      if(link) return;
      window.open(url, "_blank", "noopener");
    };

    card.addEventListener("click", open);
    card.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        window.open(url, "_blank", "noopener");
      }
    });
  });

  const n = list.length;
  countEl.textContent = `${n} partenaire${n>1?"s":""} trouv√©${n>1?"s":""}`;
  emptyEl.hidden = n > 0;
}

/* filters */
let all = [];
let view = [];

function applyFilters(){
  const q = fold(qEl.value.trim());
  const cat = catEl.value;

  view = all.filter(p=>{
    if(cat !== "all" && p.__cat !== cat) return false;
    if(q){
      const tokens = q.split(/\s+/).filter(t=>t.length>1);
      return tokens.every(t=> p.__kw.includes(t));
    }
    return true;
  });

  render(view);
}

/* ‚úÖ demo data (si table vide/erreur) */
function demoData(){
  const cats = ["market","driver","hebergement","construction","explore","restaurant"];
  const regs = ["Dakar","Thi√®s (Saly)","Kaolack","Saint-Louis","Ziguinchor","Fatick"];
  const out = [];
  for(let i=0;i<36;i++){
    out.push({
      id:`demo-${i}`,
      slug:`demo-${i}`,
      name:`Partenaire D√©mo ${i+1}`,
      city: regs[i % regs.length],
      region: "S√©n√©gal",
      description:"üß™ D√©mo NDIMBAL ‚Äî pour donner de la pr√©sence au catalogue.",
      category: cats[i % cats.length],
      badge_text: "üß™ D√©mo",
      price_text: "üí∞ Sur demande",
      phone: "+221770000000",
      cover_url: "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png",
      cta_primary_label: "üí¨ WhatsApp",
      cta_primary_url: "https://wa.me/221770000000?text=Salam%20je%20viens%20de%20DIGIYLYFE%20üôè",
      cta_secondary_label: "üîé Voir",
      cta_secondary_url: "https://digiylyfe.com/"
    });
  }
  return out;
}

/* load */
async function load(){
  countEl.textContent = "Chargement‚Ä¶";

  // ‚úÖ pas de .eq("is_active", true) ici (car si colonne absente => erreur)
  const { data, error } = await SB
    .from("professionals")
    .select("id, created_at, name, title, slug, category, cat, type, city, region, description, keywords, tags, phone, cover_url, badge_text, price_text, cta_primary_label, cta_primary_url, cta_secondary_label, cta_secondary_url, page_url, website, url, link")
    .order("created_at", { ascending:false });

  if(error){
    console.warn("Supabase error => demo fallback:", error);
    all = demoData().map(p=>({ ...p, __cat: normalizeCatValue(p.category||p.cat||p.type||""), __kw: computeKeywords(p) }));
    applyFilters();
    return;
  }

  const rows = data || [];
  const base = rows.length ? rows : demoData();

  all = base.map(p=>{
    const rawCat = p.category || p.cat || p.type || "";
    p.__cat = normalizeCatValue(rawCat);
    p.__kw = computeKeywords(p);
    return p;
  });

  applyFilters();
}

/* nav buttons */
$("#btnHub").addEventListener("click", ()=>{ window.location.href = "https://beauville.github.io/digiy-hub/"; });
$("#btnMap").addEventListener("click", ()=>{ window.location.href = NDIMBAL_MAP_BASE; });

/* listeners */
qEl.addEventListener("input", ()=> applyFilters());
catEl.addEventListener("change", ()=> applyFilters());

load();
</script>
</body>
</html>
